//>>built
define("epi-cms/widget/ContextualContentForestStoreModel",["dojo/_base/array","dojo/_base/declare","dojo/_base/lang","dojo/aspect","dojo/Deferred","dojo/promise/all","dojo/topic","dojo/when","epi/shell/TypeDescriptorManager","epi-cms/_ContentContextMixin","epi-cms/contentediting/_ContextualContentContextMixin","epi-cms/core/ContentReference","epi-cms/widget/ContentForestStoreModel"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d){return _2([_d,_a,_b],{handleSelection:null,previousSelection:null,postscript:function(){this.inherited(arguments);this._handles.push(_7.subscribe("/epi/cms/action/createlocalasset",_3.hitch(this,this.refreshRoots)));this._handles.push(_7.subscribe("/epi/cms/action/togglecreatemode",_3.hitch(this,this._toggleContextualContent)));this._handles.push(_4.around(this,"pasteItem",_3.hitch(this,this._aroundPasteItem)));this._handles.push(_4.after(this.store,"get",_3.hitch(this,this._afterStoreGet)));},contentContextChanged:function(_e,_f){this.inherited(arguments);this.refreshRoots();},getChildren:function(_10,_11,_12){if(_10===this.root){_8(this._getRootItems(),_11,_12);}else{if(this.isPseudoContextualRoot(_10)){_11([]);return;}this.inherited(arguments);}},getAncestors:function(_13,_14){var _15=this.getInherited(arguments);_8(this.getCurrentContent(),_3.hitch(this,function(_16){var _17=this.roots.concat(_16.assetsFolderLink),_18=_3.hitch(this,function(_19){var _1a;for(var i=_19.length-1;i>=0;i--){_1a=_19[i];if(this.isContextualRoot(_1a)){_19[i]=this.getContextualRoot(_1a);}if(_1.indexOf(_17,this.getIdentity(_1a))>=0){_19=_19.slice(i);_19.unshift(this.root);_14(_19);return;}}_14([this.root]);});if(_1.indexOf(_17,this.getIdentity(_13))>=0){_14([this.root]);}_15.apply(this,[_13,_18]);}));},getObjectIconClass:function(_1b,_1c){var _1d=this._currentContext&&this._currentContext.dataType;if(!_1d){return this.inherited(arguments);}var _1e=_9.getValue(_1d,"iconClass");return this.isContextualContent(_1b)?(_1e?_1c+" "+_1e+"Contextual":_1c):this.inherited(arguments);},onToggleContentDisplay:function(_1f,_20){},onRefreshRoots:function(_21){},refreshRoots:function(_22){if(_22===this){return true;}var _23=this;return _23._refreshPromise=_8(_23._refreshPromise,function(){return _8(_23._getRootItems(),function(_24){_23.onChildrenChange(_23.root,_24);if(_23.get("handleSelection")===true){return _23._setSelection(_3.clone(_24).pop());}});});},canCopy:function(_25){return this.isContextualContent(_25)?false:this.inherited(arguments);},canCut:function(_26){return this.isContextualContent(_26)?false:this.inherited(arguments);},canPaste:function(_27,_28,_29){var _2a=this,_2b=_2a.getInherited(arguments),_2c=new _5();if(_29){_2c.resolve(_2b.apply(_2a,[_27,_28,_29]));}else{_8(_2a.getCurrentContent(),function(_2d){_2a.getAncestors(_28,function(_2e){var _2f=_2a.isContextualContent(_28)||_2a.hasContextual(_2e);if(_2f){if(_c.compareIgnoreVersion(_27.contentLink,_2d.contentLink)){_2c.resolve(false);}else{_2a.getAncestors(_2d.contentLink,function(_30){_2c.resolve(_1.some(_30,function(_31){return _27.contentLink===_31.contentLink;},this)?false:_2b.apply(_2a,[_27,_28,_29]));});}}else{_2c.resolve(_2b.apply(_2a,[_27,_28,_29]));}});});}return _2c;},filterAncestors:function(_32){if(!(_32 instanceof Array)){return _32;}var _33=_32.indexOf(this._getPseudoContextualContent().toString());if(_33!==-1&&_33<_32.length-1){_32.splice(_33,1);}return _32;},_toggleContextualContent:function(_34){_8(this.getCurrentContent(),_3.hitch(this,function(_35){this.onToggleContentDisplay(_35.assetsFolderLink,!_34);this._setSelection(null);}));},_setSelection:function(_36){var _37=this.roots[0].toString(),_38=_36!=null?_36.contentLink:_37,_39=this.get("previousSelection"),_3a=this.get("previousContextualSelection"),_3b=new _5();if(!(_38&&_39)){_3b.resolve();return _3b;}var _3c=false,_3d=_39.selectedContent,_3e=_39.selectedAncestors,_3f=_3d.item&&!_3d.item.contentLink;var _40=function(_41){_3b.resolve();};if(_3f||this.hasContextual(_3e)){this.onSelect(_38,_3c,_40);}else{if(_3d.item.contentLink==_37&&_3a&&_3a.selectedContent&&_3a.selectedContent.item&&_3a.selectedContent.item.contentLink){this.onSelect(_3a.selectedContent.item.contentLink,_3c,_40);}else{_3b.resolve();}}return _3b;},_getRootItems:function(){var _42=this,_43=_42.store,_44=_1.map(_42.roots,function(_45){return _43.get(_45);});var _46=_8(_6([_42.getCurrentContent(),_42.getCurrentContext()]),function(_47){var _48=_47[0],_49=_47.length>1?_47[1]:null;return _8(_43.get(_48.contentLink),function(_4a){var _4b=_49&&_49.currentMode==="create";if((_4b&&_42.get("view")==="contentselector")||!_42.canHaveContextualContent(_4a)){return null;}var _4c=_4a.assetsFolderLink;if(_4c){var _4d=function(_4e){return _8(_43.get(_4e),function(_4f){var _50={"id":_4f.contentLink,"typeIdentifiers":_42.typeIdentifiers,"allLanguages":_42.showAllLanguages};return _8(_43.query(_50),function(_51){if(typeof _42.isSupportedType==="function"&&!_42.isSupportedType(_51.typeIdentifier)){return null;}if(!_42.isPseudoContextualRoot(_51)){return _42.getContextualRoot(_51);}else{return _8(_42.onRefreshRoots(_51),function(){return _42._modifyContentAccess(_51,_4a);});}});});};if(_4c==_42._getPseudoContextualContent()){return _8(_43.refresh(_4a.contentLink),function(_52){return _4d(_52.assetsFolderLink);});}else{return _4d(_4c);}}return null;});},function(_53){return null;});_44.push(_46);return _8(_6(_44),function(_54){return _1.filter(_54,Boolean);});},_aroundPasteItem:function(_55){var _56=this;return function(_57,_58,_59,_5a,_5b){var _5c=_59,_5d=_56.get("createAsLocalAsset");return _8(_56.getCurrentContent(),function(_5e){if(!_5d){_5d=_56.isPseudoContextualRoot(_5c);_56.set("createAsLocalAsset",_5d);}_5d&&(_5c=_5e);return _8(_55.apply(_56,[_57,_58,_5c,_5a,_5b]),function(_5f){if(_5d){_56.set("createAsLocalAsset",false);return _8(_56.refreshRoots(),function(){_7.publish("/epi/cms/action/createlocalasset",_56);return _5f;});}else{return _5f;}});});};},_afterStoreGet:function(_60){var _61=this;return _8(_60,function(_62){return _8(_61.getCurrentContent(),function(_63){return _61._modifyContentAccess(_62,_63);},function(_64){return _62;});});},_modifyContentAccess:function(_65,_66){if(this.isContextualContent(_65)){var _67=this.getContextualRoot(_65);return this.isPseudoContextualRoot(_65)?_3.mixin(_67,{isPreferredLanguageAvailable:_66.isPreferredLanguageAvailable,accessMask:_66.accessRights}):_67;}return _65;}});});