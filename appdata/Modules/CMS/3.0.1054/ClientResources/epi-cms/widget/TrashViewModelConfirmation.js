//>>built
define("epi-cms/widget/TrashViewModelConfirmation",["dojo/_base/array","dojo/_base/declare","dojo/_base/Deferred","dojo/_base/lang","dojo/aspect","dojo/when","epi/dependency","epi/string","epi/shell/TypeDescriptorManager","epi/shell/widget/dialog/Dialog","epi/shell/widget/dialog/Confirmation","epi/shell/widget/dialog/Alert","epi-cms/widget/ContentSelectorDialog","epi-cms/contentediting/ContentActionSupport","epi/i18n!epi/cms/nls/episerver.cms.components.trash"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e,_f){return function(_10){var _11=function(_12,_13,_14){var _15=new _3();var _16=new _b({destroyOnHide:true,description:_8.toHTML(_13),title:_8.toHTML(_12),onAction:function(_17){_17?_15.resolve(_14):_15.cancel();}});_16.show();return _15;};var _18=function(_19,_1a,_1b){var df=new _3(),_1c=_f.restore.dialog,_1d=_9.getValue(_19.typeIdentifier,"containerTypes"),_1e=_1f(_19),_20={showButtons:false,roots:_1a,multiRootsMode:true,canSelectOwnerContent:false,allowedTypes:_1d||_1e,selectedContentType:_19.typeIdentifier};var _21=new _d(_20);var _22=new _a({title:_8.toHTML(_1c.title),description:_1b||_8.toHTML(_1c.description),confirmActionText:_8.toHTML(_f.restore.label),content:_21});var _23=function(_24){_6(_10.contentStore.query({id:_24}),function(_25){_22.onActionPropertyChanged({name:"ok"},"disabled",!_25);});};_21.on("change",function(_26){if(_26){_23(_26);}else{_22.onActionPropertyChanged({name:"ok"},"disabled",true);}});_22.on("execute",function(){df.resolve(_21.get("value"));});_22.on("onHide",function(){df.cancel();});_22.show();_21.onChange(null);return df;};var _27=function(_28,_29){var _2a=_e.action.Create,_2b=_e.providerCapabilities.Create,_2c=_29&&!(_29.isWastebasket||_29.isDeleted)&&_e.isActionAvailable(_29,_2a,_2b,true,true);if(!_2c){var _2d=new _c({description:_8.toHTML(_f.restore.userdonothavepermission)});_2d.show();return false;}return true;};var _2e=function(_2f,_30,_31,_32,_33,_34){if(!_33||!_2f||!_30){return false;}if(_32&&_31){confirmation=_11(_f.restore.label,_f.restore.confirmquestion,_31);}else{confirmation=_18(_30,_35(_30),_34);}_6(confirmation,function(_36){_6(_2f.contentStore.get(_36),function(_37){if(!_27(_30,_37)){return false;}return _33.apply(_2f,[_30,_36]);});},function(){return false;});};var _35=function(_38){var _39=_7.resolve("epi.cms.contentRepositoryDescriptors");var _3a=[];for(var key in _39){_39[key].containedTypes.forEach(function(_3b){if(_9.isBaseTypeIdentifier(_38.typeIdentifier,_3b)){_39[key].roots.forEach(function(_3c){if(_3a.indexOf(_3c)===-1){_3a.push(_3c);}});}});}return _3a;};var _1f=function(_3d){var _3e=_7.resolve("epi.cms.contentRepositoryDescriptors");var _3f=[];for(var key in _3e){_3e[key].containedTypes.forEach(function(_40){if(_9.isBaseTypeIdentifier(_3d.typeIdentifier,_40)){_3f=_3f.concat(_3e[key].containedTypes);}});}return _3f;};_5.around(_10,"restore",function(_41){return function(_42,_43){var _44;return _6(_10.contentStore.query({id:_42.contentLink}),_4.hitch(this,function(_45){var _46=null;var _47=null;if(_45.hasOwnProperty("statusCode")&&(_45.statusCode===401||_45.statusCode===403)){_46=_8.toHTML(_f.restore.userdonothavepermission);}if(_45.hasOwnProperty("isDeleted")&&!_45.isDeleted){_46=_8.toHTML(_f.restore.contentalreadyrestored);_47=function(){_10.updateTrash(_10.get("currentTrash"));};}if(_46){var _48=new _c({description:_46,onAction:_47});_48.show();return false;}var _49=_10.get("currentTrash");if(_45.parentLink!=_49.wasteBasketLink){return _6(_18(_45,_35(_45)),function(_4a){_6(_10.contentStore.get(_4a),function(_4b){if(!_27(_45,_4b)){return false;}return _41.apply(_10,[_45,_4a]);});},function(){return false;});}else{return _6(_10.getOldParent(_45.contentLink),function(_4c){var _4d=_4c?_4c.contentLink:null;_2e(_10,_45,_4d,_4d!=null,_41);});}}),_4.hitch(this,function(_4e){var _4f=new _c({description:_8.toHTML(_f.restore.contentdeletedpermanently),onAction:function(){_10.updateTrash(_10.get("currentTrash"));}});_4f.show();return false;}));};});return _10;};});