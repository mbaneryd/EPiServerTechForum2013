(function(tinymce,$){tinymce.create("tinymce.plugins.epicontentfragment",{init:function(ed,url){var self=this;if("undefined"==typeof epiContentBlockUtilities){var scriptUrl=tinymce.baseURI.toAbsolute("plugins/epipersonalizedcontent/epicontentblockutilities.js");tinymce.ScriptLoader.load(scriptUrl,function(){this._init(ed,url)},this),tinymce.ScriptLoader.loadQueue()}else this._init(ed,url);ed.onPreInit.addToTop(function(){var mceNonEditableClass=tinymce.trim(ed.getParam("noneditable_noneditable_class","mceNonEditable"));ed.parser.addAttributeFilter("class",function(nodes){for(var i=nodes.length;i--;)self._convertContentFragmentToNonEditable(nodes[i],mceNonEditableClass)})}),ed.onInit.add(function(){self._onInitCalled=!0})},_init:function(ed){$.extend(this,epiContentBlockUtilities);var self=this;self.ed=ed,self._contentFragmentClass=ed.getParam("epicontentfragment_cssclass","epi-contentfragment"),self._enabledControls=ed.getParam("epicontentfragment_enabledcontrols","");var pluginInit=function(ed){ed.onNodeChange.add(function(ed){var selection=ed.selection,selectNode=selection.getNode(),isContentFragment=ed.dom.hasClass(selectNode,self._contentFragmentClass);(isContentFragment||self._disabled)&&(isContentFragment&&(self._disabled=!0),self._disabled&&self._setDisabled(isContentFragment,self._enabledControls))}),ed.onBeforeExecCommand.add(function(ed,cmd,ui,value,args){"mceInsertContent"===cmd&&self._isSelectionContainsCF()&&(args.terminate=!0)})};self._onInitCalled?pluginInit(ed):ed.onInit.add(pluginInit)},_isSelectionContainsCF:function(){var cfMatchRule=RegExp("<div.*"+this._contentFragmentClass+".*>");return this.ed.dom.hasClass(this.ed.selection.getNode(),this._contentFragmentClass)||this.ed.selection.getContent().match(cfMatchRule)},_convertContentFragmentToNonEditable:function(node,mceNonEditableClass){var nodeClass=node.attr("class")+" ";-1===nodeClass.indexOf("epi-contentfragment")||nodeClass.indexOf(mceNonEditableClass)>=0||(node.attr("contenteditable",null),node.attr("class",nodeClass+mceNonEditableClass))},getInfo:function(){return{longname:"Content Fragment",author:"EPiServer AB",authorurl:"http://www.episerver.com",infourl:"http://www.episerver.com",version:"1.0"}}}),tinymce.PluginManager.add("epicontentfragment",tinymce.plugins.epicontentfragment)})(tinymce,epiJQuery);