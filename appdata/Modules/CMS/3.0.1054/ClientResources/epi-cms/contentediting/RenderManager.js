//>>built
define("epi-cms/contentediting/RenderManager",["dojo","dojo/_base/declare","dojo/_base/lang","dojo/_base/Deferred","dojo/_base/json","dojo/_base/array","epi","epi/dependency","epi/string","epi/datetime","dojox/encoding/digests/SHA1","dojo/Stateful","epi-cms/contentediting/PropertyRenderer"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d){return _2([_c],{_cache:null,_queue:null,defaultRenderer:null,_rendererPool:{},rendering:false,processQueueOnRenderValue:true,numberOfItemsInQueue:0,numberOfItemsRendering:0,concurrentProcessedItems:2,processInterval:200,_processIntervalId:0,_itemsBeingRendered:null,viewSettingsManager:null,_viewSettingsToCopy:["visitorgroup"],constructor:function(_e){this._cache={};this._queue=[];this._itemsBeingRendered={};_3.mixin(this,_e);this.defaultRenderer=this.defaultRenderer||new _d();},postscript:function(){this.viewSettingsManager=this.viewSettingsManager||_8.resolve("epi.viewsettingsmanager");},destroy:function(){this._stopRenderingInterval();this._isDestroyed=true;for(var i in this._cache){delete this._cache[i];}for(var j in this._itemsBeingRendered){delete this._itemsBeingRendered[j];}this._cache=null;this._itemsBeingRendered=null;this._queue=null;this.inherited(arguments);},_getRenderer:function(_f){var def=new _4();if(_f){if(this._rendererPool[_f]){return this._rendererPool[_f];}else{var _10=_9.slashName(_f);require([_10],function(_11){def.resolve(new _11());});}}else{return this.defaultRenderer;}return def;},renderValue:function(_12,_13,_14,_15,_16){var def;if(this._isSuspending){def=new _4();def.cancel();return def;}_14=_a.transformDate(_14);_15=this.cloneAndCompleteRenderSettings(_15||{});var _17=this._get(_13,_15,_14);if(_17){def=new _4();def.resolve(_17);}else{if(_15&&_15.isFullReload){def=new _4();def.resolve({doReload:true});}else{def=new _4();_4.when(this._getRenderer(_16),_3.hitch(this,function(_18){if(!_18){_18=this.defaultRenderer;}_4.when(this._queueItem(_18,_12,_13,_15,_14),function(_19){def.resolve(_19);});if(this.processQueueOnRenderValue&&!this._isSuspending){this._startRenderingInterval();}}));}}return def;},cloneAndCompleteRenderSettings:function(_1a){_1a.propertyRenderSettings=_1a.propertyRenderSettings||"";var _1b=_3.clone(_1a);if(this.viewSettingsManager.get("enabled")){_6.forEach(this.viewSettingsManager.getRenderingViewSettings(),_3.hitch(this,function(_1c){if(_1c.get("enabled")){var _1d=this.viewSettingsManager.getSettingProperty(_1c.key);if(_1d){this.updateRenderSettings(_1b,_1d,_1c.key,_1c.isTagItem);}}}));}return _1b;},updateRenderSettings:function(_1e,_1f,key,_20){var _21=[],_22=[],_23="",_24=(_20?"tag":key),_25=!_20,_26=null;if(_20){_1e.propertyRenderSettings=_1e.propertyRenderSettings||"";_26=(_1e.propertyRenderSettings?_1.fromJson(_1e.propertyRenderSettings):{});}else{_26=(_1e?_1e:{});}if(!_26[_24]||_25){_23=_1f;}else{_21=_26[_24].split(",");_6.forEach(_21,function(_27,idx){_27=_3.trim(_27);if(_27.toLowerCase()!=_1f.toLowerCase()){_22.push(_27);}});_22.push(_1f);_23=_22.join(", ");}_26[_24]=_23;if(_20){_1e.propertyRenderSettings=_1.toJson(_26);}},processQueue:function(){if(this._isSuspending){return;}if(this._queue.length===0){this._stopRenderingInterval();return;}if(this.numberOfItemsRendering>=this.concurrentProcessedItems){return;}var _28=this._nextItemToProcessIndex();while(_28>=0&&this.numberOfItemsRendering<this.concurrentProcessedItems){this._processItemInQueue(_28);_28=this._nextItemToProcessIndex();}},suspend:function(){if(this._isSuspending){return;}this._isSuspending=true;this._stopRenderingInterval();},clear:function(){this.set("numberOfItemsRendering",0);for(var key in this._itemsBeingRendered){this._itemsBeingRendered[key].deferred.cancel();delete this._itemsBeingRendered[key];}this._itemsBeingRendered={};this.set("numberOfItemsInQueue",0);for(var i=this._queue.length-1;i>=0;i--){delete this._queue[i];}this._queue=[];},resume:function(){if(!this._isSuspending){return;}this._isSuspending=false;this._startRenderingInterval();},_nextItemToProcessIndex:function(){var _29=-1;var i=0;while(i<this._queue.length&&_29==-1){var _2a=this._queue[i];var key=this._getRenderHash(_2a.propertyName,_2a.renderSettings);if(!(key in this._itemsBeingRendered)){_29=i;}i++;}return _29;},_processItemInQueue:function(_2b){var _2c=this._queue.splice(_2b,1)[0];this.set("numberOfItemsRendering",this.numberOfItemsRendering+1);this.set("numberOfItemsInQueue",this._queue.length);var key=this._getRenderHash(_2c.propertyName,_2c.renderSettings);this._itemsBeingRendered[key]=_2c;this.set("rendering",true);var _2d=_3.hitch(this,function(_2e){if(this._isDestroyed){_2c.deferred.cancel();return;}if(_2e&&_2e.innerHtml){this._put(_2c.propertyName,_2c.renderSettings,_2c.value,{doReload:false,innerHtml:_2e.innerHtml});}delete this._itemsBeingRendered[key];this.set("numberOfItemsRendering",this.numberOfItemsRendering-1);this.set("rendering",false);_2c.deferred.resolve(_2e);});var _2f=_3.hitch(this,function(err){if(this._isDestroyed){_2c.deferred.cancel();return;}delete this._itemsBeingRendered[key];this.set("numberOfItemsRendering",this.numberOfItemsRendering-1);this.set("rendering",false);_2c.deferred.reject(err);});_4.when(_2c.renderer.render(_2c.contentLink,_2c.propertyName,_2c.value,_2c.renderSettings),_2d,_2f);},cacheRender:function(_30,_31,_32,_33){data={innerHtml:_33,doReload:false};this._put(_30,_31,_32,data);},_queueItem:function(_34,_35,_36,_37,_38){var key=this._getRenderHash(_36,_37);var _39;var _3a=this._itemsBeingRendered[key];if(_3a&&!_3a.deferred.fired&&_3a.value===_38){_39=_3a.deferred;}else{var _3b=this._queueIndex(_34,_35,_36,_37,_38);if(_3b<0){_39=new _4();this._queue.push({contentLink:_35,renderer:_34,propertyName:_36,renderSettings:_37,renderSettingsString:_5.toJson(_37),value:_38,deferred:_39});this.set("numberOfItemsInQueue",this._queue.length);}else{var _3c=this._queue[_3b];_3c.contentLink=_35;_3c.renderer=_34;_3c.value=_38;_39=_3c.deferred;}}return _39;},_startRenderingInterval:function(){if(!this._processIntervalId){this.processQueue();this._processIntervalId=setInterval(_3.hitch(this,function(){this.processQueue();}),this.processInterval);}},_stopRenderingInterval:function(){if(this._processIntervalId){clearInterval(this._processIntervalId);this._processIntervalId=0;}this.set("rendering",false);},_getRenderHash:function(_3d,_3e){return _b(_5.toJson({p:_3d,r:_3e}));},_queueIndex:function(_3f,_40,_41,_42,_43){var _44=-1;var _45=_5.toJson(_42);_6.some(this._queue,function(_46,i){if((_46.propertyName===_41)&&(_46.renderSettingsString==_45)){_44=i;return true;}});return _44;},_put:function(_47,_48,_49,_4a){if(!_48.cacheResults){return;}var _4b=this._getCacheHash(_47,_48,_49);if(!this._cache){this._cache={};}this._cache[_4b]={data:_4a};},_get:function(_4c,_4d,_4e){var _4f=this._getCacheHash(_4c,_4d,_4e);var _50=this._cache[_4f];return (_50?_50.data:undefined);},_getCacheHash:function(_51,_52,_53){return _b(_5.toJson({p:_51,r:_52,v:_53}));}});});