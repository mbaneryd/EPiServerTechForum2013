//>>built
define("epi-cms/contentediting/ContentViewModel",["dojo/_base/array","dojo/_base/connect","dojo/_base/declare","dojo/_base/Deferred","dojo/_base/lang","dojo/on","dojo/when","dojo/Stateful","dijit/Destroyable","epi/dependency","epi/datetime","epi/string","epi/shell/UndoManager","epi/shell/conversion/ObjectConverterRegistry","epi/shell/widget/dialog/Alert","epi/shell/Stateful","../ApplicationSettings","./ContentActionSupport","./ContentEditingValidator","./ContentModelServerSync","./Operation","epi/i18n!epi/cms/nls/episerver.cms.contentediting","epi/i18n!epi/cms/nls/episerver.cms.components.versions"],function(_1,_2,_3,_4,_5,on,_6,_7,_8,_9,_a,_b,_c,_d,_e,_f,_10,_11,_12,_13,_14,res,_15){return _3([_7,_8],{contentModel:null,metadata:null,syncService:null,editorFactory:null,syncInterval:10000,validator:null,contentDataStore:null,profileHandler:null,languageContext:null,_converterRegistry:null,_contentVersionStore:null,_syncRetryTimeout:60000,undoManager:null,contextTypeName:"",contentLink:null,contentData:null,viewName:null,isCreatingNewVersion:false,hasUndoSteps:false,hasRedoSteps:false,isValid:true,hasPendingChanges:false,lastSaved:null,isSaved:true,isSaving:false,isOnline:true,hasErrors:false,isChangingContentStatus:false,_isSuspended:false,constructor:function(){},postscript:function(){this.inherited(arguments);this.profileHandler=this.profileHandler||_9.resolve("epi.shell.Profile");this.metadataManager=this.metadataManager||_9.resolve("epi.shell.MetadataManager");this.currentContentLanguage=this.currentContentLanguage||_10.currentContentLanguage;this.contentDataStore=this.contentDataStore||_9.resolve("epi.storeregistry").get("epi.cms.contentdata");if(!this._contentVersionStore){this._contentVersionStore=_9.resolve("epi.storeregistry").get("epi.cms.contentversion");}this.undoManager=this.undoManager||new _c();this.validator=this.validator||new _12({contextId:this.contentLink,contextTypeName:this.contextTypeName});if(!this.syncService){this._createSyncService();}var _16=_5.hitch(this,function(_17,_18,_19){this.set(_17,_19);});this._operation=new _14();this.own(this.syncService.watch("hasPendingChanges",_16),this.validator.watch("isValid",_16),this.validator.watch("hasErrors",_16),this.undoManager.watch("hasUndoSteps",_16),this.undoManager.watch("hasRedoSteps",_16),on(this._operation,"commit",_5.hitch(this,this._commitChanges)));},setActiveProperty:function(_1a){this.onSetActiveProperty(_1a);},suspend:function(){this._isSuspended=true;this.onContentChange();this.onSuspend();},onSuspend:function(){},wakeUp:function(){this._isSuspended=false;},destroy:function(){this.clear();this.inherited(arguments);},clear:function(){this.undoManager.clear();},_createSyncService:function(){var _1b=new _13({contentLink:this.contentLink,contentDataStore:this.contentDataStore});this.syncService=_1b;},connectLocal:function(_1c,obj,evt,_1d){if(!_5.isArray(_1c)){throw Error("First argument to connectLocal must be an Array");}return _1c.push(_2.connect(obj,evt,this,_1d));},disconnectLocal:function(_1e){if(_5.isArray(_1e)){var _1f;while(_1f=_1e.pop()){_2.disconnect(_1f);}}},resetNotifications:function(){this.validator.clearErrorsBySource(this.validator.validationSource.client);},beginOperation:function(){this._operation.begin();},endOperation:function(){this._operation.end();},abortOperation:function(){this._operation.abort();},getProperty:function(_20){return this.contentModel.get(_20);},setProperty:function(_21,_22,_23){this._setModelProperty(_21,_22,_23);},publishProperty:function(_24,_25){this.syncService.publishProperty(_24,_25).then(_5.hitch(this,function(){this.contentModel.set(_24,_25);this._patchContentDataStore(this.contentData.contentLink,_24,null,_25);_6(this.contentDataStore.refresh(this.contentData.contentLink),_5.hitch(this,function(_26){this.set("contentData",_26);}));}));},_commitChanges:function(_27){var _28=_1.map(_27,function(_29){return {propertyName:_29.propertyName,value:_29.oldValue,oldValue:_29.value};});this.undoManager.createStep(this,this._saveProperties,[_28],"Edit properties");},_saveProperties:function(_2a){this.beginOperation();_1.forEach(_2a,function(p){this._setModelProperty(p.propertyName,p.value,p.oldValue);},this);this.endOperation();},_setModelProperty:function(_2b,_2c,_2d){this.set("isSaved",false);this._operation.save({propertyName:_2b,value:_2c,oldValue:_2d||this.contentModel.get(_2b)});this.contentModel.set(_2b,_2c);this.syncService.scheduleForSync(_2b,_2c);this.onPropertyEdited(_2b,_2c);},onPropertyEdited:function(_2e,_2f){},_onSynchronizeSuccess:function(_30,_31,_32){_1.forEach(_31,_5.hitch(this,function(_33){this.validator.clearPropertyErrors(_33.name,this.validator.validationSource.server);this._patchContentDataStore(_30,_33.name,null,_33.value);}));this.validator.setGlobalErrors(_32.validationErrors,this.validator.validationSource.server);},_onSynchronizeFailure:function(_34,_35,_36,_37){_1.forEach(_35,function(_38){if("successful" in _38){if(_38.successful){this.validator.clearPropertyErrors(_38.name,this.validator.validationSource.server);}else{this.validator.setPropertyErrors(_38.name,[{"errorMessage":_38.validationErrors,severity:this.validator.severity.error}],this.validator.validationSource.server);}}else{}},this);if(_37){if(_37.validationErrors){this.validator.setGlobalErrors(_37.validationErrors,this.validator.validationSource.server);}else{this.validator.clearGlobalErrors(this.validator.validationSource.server);}}},_contentLinkChanged:function(_39,_3a){this.contentLink=_3a;this.syncService.contentLink=_3a;this.validator.setContextId(_3a);if(!this._isSuspended){var _3b={uri:"epi.cms.contentdata:///"+_3a};_2.publish("/epi/shell/context/request",[_3b,{sender:this,contextIdSyncChange:true,trigger:"internal"}]);}},ensureWritableVersion:function(){var _3c=this.contentLink;if(!this.contentData.isNewVersionRequired){return _3c;}this.isCreatingNewVersion=true;var def=new _4();_6(this._contentVersionStore.put({originalContentLink:_3c}),_5.hitch(this,function(_3d){this._contentLinkChanged(_3c,_3d.contentLink);this.isCreatingNewVersion=false;def.resolve(_3d);}),_5.hitch(this,function(){this.isCreatingNewVersion=false;def.reject();}));return def;},validate:function(){var def;if(!this.validator){def=new _4();def.resolve();}else{def=this.validator.validate();}return def;},revertToPublished:function(){var _3e=this.contentLink;_6(this._contentVersionStore.remove(_3e),_5.hitch(this,function(){this._loadPublishedVersion(_3e);}),_5.hitch(this,function(_3f){var _40;if(_3f.status===403){_40=_15.deleteversion.cannotdeletepublished;}else{if(_3f.status===404){_40=res.versionstatus.versionnotfound;}}if(_40){this.dialog=new _e({description:_40,onAction:_5.hitch(this,function(){this._loadPublishedVersion(_3e);})});this.dialog.show();}}));},_loadPublishedVersion:function(_41){_6(this._contentVersionStore.query({contentLink:_41,language:this.languageContext?this.languageContext.language:"",query:"getpublishedversion"}),_5.hitch(this,function(_42){if(_42!==null){var _43={uri:"epi.cms.contentdata:///"+_42.contentLink,context:this};_2.publish("/epi/shell/context/request",[_43,{sender:this,trigger:"internal"}]);}}));},createDraft:function(){var _44=this.contentLink;var _45=this.contentData.status;var _46=_11.versionStatus;var _47=_45===_46.DelayedPublish;return _6(this._contentVersionStore.put({originalContentLink:_44,isCommonDraft:_47}),_5.hitch(this,function(_48){var _49={uri:"epi.cms.contentdata:///"+_48.contentLink,context:this};_2.publish("/epi/shell/context/request",[_49,{sender:this}]);}));},editCommonDraft:function(){var _4a=this.contentLink;return _6(this._contentVersionStore.query({contentLink:_4a,query:"getcommondraftversion"}),_5.hitch(this,function(_4b){var _4c={uri:"epi.cms.contentdata:///"+_4b.contentLink,context:this};_2.publish("/epi/shell/context/request",[_4c,{sender:this}]);}));},_populateContentModel:function(_4d,_4e){var _4f={},_50,_51;for(var _52 in _4d){var _53=_4e.getPropertyMetadata(_52);var _54=_4d[_52];if(_53.hasSubProperties()){_4f[_52]=this._populateContentModel(_54,_53);}else{_4f[_52]=_54;_50=_53.customEditorSettings.converter;if(_50){_51=_d.getConverter(_50,"runtimeType");if(_51){_4f[_52]=_51.convert(_50,"runtimeType",_54);}}}}return _4f;},getPropertyMetaData:function(_55){if(this.metadata){return this.metadata.getPropertyMetadata(_55);}else{var _56=[],def=new _4();this.connectLocal(_56,this,"onMetadataResolve",function(_57){if(_57){def.resolve(this.metadata.getPropertyMetadata(_55));}else{def.reject();}this.disconnectLocal(_56);});return def;}},getContentModelAndMetadata:function(){var def=new _4();_6(this.metadataManager.getMetadataForType("EPiServer.Core.ContentData",{contentLink:this.contentLink}),_5.hitch(this,function(_58){this.set("metadata",_58);var _59=this.createContentModelObject(_58);this.set("contentModel",_59);this.onMetadataResolve(true);def.resolve();}),_5.hitch(this,function(){this.onMetadataResolve(false);def.reject();}));return def;},onMetadataResolve:function(_5a){},getMetadataThenUpdateModel:function(){var def=new _4();_6(this.metadataManager.getMetadataForType("EPiServer.Core.ContentData",{contentLink:this.contentLink}),_5.hitch(this,function(_5b){this.set("metadata",_5b);var _5c=this.createContentModelObject(_5b);this.set("contentModel",_5.mixin(this.contentModel,_5c));def.resolve();}),function(){def.reject();});return def;},createContentModelObject:function(_5d){var _5e=this._populateContentModel(this.contentData.properties,_5d);var _5f=new _f();_5f.set(_5e);return _5f;},save:function(){if(!this.isOnline){var def=new _4();def.resolve(true);return def;}return this._save();},_save:function(){var def=new _4(),_60=_5.hitch(this,function(_61){if(_61){if(_61.successful){this._onSynchronizeSuccess(_61.contentLink,_61.properties,_61);}else{this._onSynchronizeFailure(_61.contentLink,_61.properties,_61.validationErrors,_61);}if(_61&&_61.hasContentLinkChanged){this._contentLinkChanged(_61.contentLink,_61.oldContentLink);}}this.set("isOnline",true);this.set("lastSaved",new Date());this.set("isSaving",false);this.set("isSaved",true);def.resolve(true);}),_62=_5.hitch(this,function(_63){this.set("hasErrors",true);this.set("isSaving",false);this.set("isSaved",false);this.set("isOnline",false);if(_63){_1.forEach(_63.properties,_5.hitch(this,function(_64){if(!this.syncService.pendingSync(_64.name)){this.syncService.scheduleForSync(_64.name,_64.value);}}));}setTimeout(_5.hitch(this,function(){this.set("isOnline",true);this._save();}),this._syncRetryTimeout);def.reject(_63);});if(this.isCreatingNewVersion||!this.hasPendingChanges){_60();}else{_6(this.ensureWritableVersion(),_5.hitch(this,function(){this.set("isSaving",true);_6(this.syncService.save(),_60,_62);}),_62);}return def;},undo:function(){this.undoManager.undo();},redo:function(){this.undoManager.redo();},_patchContentDataStore:function(_65,_66,_67,_68){var _69={};_5.setObject(_66,_68,_69);return this.contentDataStore.patchCache({contentLink:_65,changedBy:this.profileHandler.userName,saved:_a.serialize(new Date()),properties:_69});},changeContentStatus:function(_6a){var _6b=this.contentLink;var def=new _4();this.set("isChangingContentStatus",true);var _6c=_5.hitch(this,function(_6d){var _6e=_6d&&_6d.success;var _6f=this.validator;if(_6e){if(_6a==_11.action.Publish||_6a==_11.action.CheckIn||_6a==(_11.saveAction.CheckIn|_11.saveAction.DelayedPublish|_11.saveAction.ForceCurrentVersion)){this.set("lastSaved",null);}if(_6f){_6f.clearGlobalErrors(_6f.validationSource.server);}def.resolve({id:_6d.id,oldId:_6b});}else{if(_6d&&_6d.validationErrors){if(_6f){_6f.setGlobalErrors(_6d.validationErrors,_6f.validationSource.server);_6f.validate();}def.reject(null);}else{def.reject((_6d&&_6d.errorMessage)?_6d.errorMessage:res.publish.error);}}this.set("isChangingContentStatus",false);});var _70=_5.hitch(this,function(_71){_2.publish("/epi/cms/action/showerror");def.reject((_71&&_71.errorMessage)?_71.errorMessage:res.publish.error);this.set("isChangingContentStatus",false);});this.onContentChange();_6(this.validate(),_5.hitch(this,function(){_6(this.save(),_5.hitch(this,function(){_6(this.contentDataStore.executeMethod("ChangeStatus",this.contentLink,{action:_6a}),_6c,_70);}),_70);}),_70);return def;},onContentChange:function(){},hasEditAccess:function(){return _11.hasAccess(this.contentData.accessMask,_11.accessLevel.Edit);},hasAccess:function(_72){var _73=!this.languageContext||!this.languageContext.isTranslationNeeded;return _73&&_11.isActionAvailable(this.contentData,_72||_11.action.Edit,_11.providerCapabilities.Edit);},canTranslateContent:function(){if(this.viewLanguage&&this.languageContext&&this.viewLanguage!=this.currentContentLanguage){return false;}return true;},canChangeContent:function(_74){return this.canEditCurrentLanguage()&&this.hasAccess(_74);},canEditCurrentLanguage:function(){if(!this.languageContext){return true;}return this.languageContext.language==this.currentContentLanguage;}});});