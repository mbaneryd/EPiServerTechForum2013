//>>built
define("epi-cms/contentediting/InUseNotificationManager",["dojo/_base/lang","dojo/_base/array","dojo/_base/declare","dojo/when","dojo/date","dojo/aspect","epi","epi/dependency","epi/datetime","epi-cms/ApplicationSettings","epi-cms/core/ContentReference","epi/i18n!epi/cms/nls/episerver.cms.contentediting.permanenteditindication"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c){return _3([],{contextTypeName:"",_postFlag:false,_inUseNotificationStore:null,_currentUsername:null,_messageService:null,currentModel:null,_eventHandlers:null,ignoreOthersNotifications:null,constructor:function(_d){this.inherited(arguments);_1.mixin(this,_d);this._inUseNotificationStore=this.store||_8.resolve("epi.storeregistry").get("epi.cms.inusenotification");this._currentUsername=this.username||_a.userName;this._messageService=this.messageService||_8.resolve("epi.shell.MessageService");this._eventHandlers=[];},updateCommandModel:function(_e){this.inherited(arguments);if(this.currentModel&&!_b.compareIgnoreVersion(this.currentModel.contentData.contentLink,_e.contentData.contentLink)){this.ignoreOthersNotifications=false;}this.currentModel=_e;_2.forEach(this._eventHandlers,function(_f){_f.remove();});this.updateMessageService(this.currentModel.contentData);this._eventHandlers=[_6.after(_e,"suspend",_1.hitch(this,this._onViewModelSuspended)),_6.after(_e,"destroyed",_1.hitch(this,this._onViewModelSuspended)),_6.after(_e,"onPropertyEdited",_1.hitch(this,this._onPropertyEdited)),_6.around(_e,"canChangeContent",_1.hitch(this,this._canChangeContentAdvisor))];},_canChangeContentAdvisor:function(_10){return _1.hitch(this,function(){if(!this.ignoreOthersNotifications){var _11=this.getOtherUsersInUseNotifications(this.currentModel.contentData.inUseNotifications);if(_11&&_11.length){return false;}}return _10.apply(this.currentModel,arguments);});},_onViewModelSuspended:function(){var _12=this.currentModel.contentData;this.removeAutomaticInUseNotification(_12);},_onPropertyEdited:function(){var _13=this.currentModel.contentData;this.ensureAutomaticInUseNotification(_13);},ensureAutomaticInUseNotification:function(_14){var _15;_2.some(_14.inUseNotifications,function(_16){if(_16.userName.toLowerCase()===this._currentUsername.toLowerCase()){_15=_16;return true;}},this);if(!_15){return this.put(this._createNotification(_14,false),_14.inUseNotifications);}else{if(_15.addedManually){return;}else{var _17=_9.deserialize(_15.modified);if(_5.difference(_17,new Date(),"minute")>30){return this.put(_15,_14.inUseNotifications);}}}},removeAutomaticInUseNotification:function(_18){_2.forEach(_18.inUseNotifications,function(_19){if(_19.userName.toLowerCase()===this._currentUsername.toLowerCase()&&!_19.addedManually){this.remove(_19,_18.inUseNotifications);}},this);},_createNotification:function(_1a,_1b){var _1c=_9.serialize(new Date());return {userName:this._currentUsername,contentLink:_1a.contentLink,languageBranch:_1a.currentLanguageBranch&&_1a.currentLanguageBranch.languageId,addedManually:_1b,created:_1c,modified:_1c};},put:function(_1d,_1e){_1d.modified=_9.serialize(new Date());if(!this._postFlag){this._postFlag=true;return _4(this._inUseNotificationStore.put(_1d),_1.hitch(this,function(_1f){var _20=_2.indexOf(_1e,_1d);if(_20>=0){_1e[_20]=_1d;}else{_1e.push(_1d);}this._updateDependentStores(_1d.contentLink,_1e);this._postFlag=false;}));}},remove:function(_21,_22){return _4(this._inUseNotificationStore.remove(_21.id),_1.hitch(this,function(){var _23=_2.indexOf(_22,_21);_22.splice(_23,1);this._updateDependentStores(_21.contentLink,_22);}));},_updateDependentStores:function(_24,_25){var _26={contentLink:_24,inUseNotifications:_25};this._inUseNotificationStore.updateDependentStores(_26);},togglePermanentEditIndication:function(_27,_28){var _29;var _2a=_2.some(_27.inUseNotifications,function(_2b){if(_2b.userName.toLowerCase()===this._currentUsername.toLowerCase()){_29=_2b;if(_2b.addedManually){return true;}}},this);if(_2a){if(_28&&_29.convertedFromAutomaticNotification){_29.addedManually=false;return this.put(_29,_27.inUseNotifications);}else{return this.remove(_29,_27.inUseNotifications);}}else{if(_29&&_28){_29.convertedFromAutomaticNotification=true;_29.addedManually=true;}else{_29=this._createNotification(_27,true);}return this.put(_29,_27.inUseNotifications);}},updateMessageService:function(_2c){var _2d=_2c.contentLink+"_permanentEdit";this._messageService.remove({externalItemId:_2d});var _2e=this._getManualInUseNotification(_2c.inUseNotifications);if(_2e){this._notificationHandlerId=this._messageService.put("note",_c.permanenteditison,this.contextTypeName,_2c.contentLink,_2d,null);}},_getManualInUseNotification:function(_2f){var _30;var _31=_2.forEach(_2f,function(_32){if(_32.userName.toLowerCase()===this._currentUsername.toLowerCase()&&_32.addedManually){_30=_32;}},this);return _30;},currentUserHasInUseNotification:function(_33,_34){return _2.some(_33,function(_35){return _35.userName.toLowerCase()===this._currentUsername.toLowerCase()&&(!_34||_35.addedManually);},this);},getOtherUsersInUseNotifications:function(_36){var _37=[];_2.forEach(_36,function(_38){if(_38.userName.toLowerCase()!==this._currentUsername.toLowerCase()){_37.push(_38.userName);}},this);return _37;},hasInUseNotificationWarning:function(_39){if(this.ignoreOthersNotifications){return false;}return this.getOtherUsersInUseNotifications(_39).length;}});});