//>>built
define("epi-cms/contentediting/ContentModelServerSync",["dojo/_base/array","dojo/_base/declare","dojo/_base/Deferred","dojo/_base/json","dojo/_base/lang","dojo/Stateful","epi/datetime","epi/string"],function(_1,_2,_3,_4,_5,_6,_7,_8){return _2([_6],{_queue:null,_isSynchronizing:false,hasPendingChanges:false,contentLink:null,contentDataStore:null,processInterval:200,_processIntervalId:0,_saveDeferred:null,_publish:false,constructor:function(_9){_5.mixin(this,_9);this._queue=[];},scheduleForSync:function(_a,_b){if(_b===undefined){return;}this.set("hasPendingChanges",true);_b=_7.transformDate(_b);var _c=this._propertyIndexInQueue(_a);if(_c<0){this._queue.push({name:_a,value:_b});}else{this._queue[_c].value=_b;}},publishProperty:function(_d,_e){this._publish=true;this.scheduleForSync(_d,_e);return this._synchronizeItem(true);},_propertyIndexInQueue:function(_f){var _10=-1;_1.some(this._queue,function(_11,i){if(_11.name===_f){_10=i;return true;}});return _10;},save:function(){return this._startSynchronizeInterval();},_startSynchronizeInterval:function(){if(this._processIntervalId>0){return this._saveDeferred;}var fn=_5.hitch(this,function(){return this._synchronizeItem();});var def=fn();if(this.processInterval>=0){this._processIntervalId=setInterval(fn,this.processInterval);}return def;},_stopSynchronizeInterval:function(){if(this._processIntervalId){clearInterval(this._processIntervalId);this._processIntervalId=0;}},_synchronizeItem:function(){if(this._isSynchronizing){return this._saveDeferred;}if(this._queue.length===0){return this._saveDeferred;}if(!this._saveDeferred){this._saveDeferred=new _3();}this._isSynchronizing=true;var _12=this._queue;this._queue=[];var _13=this.contentLink;var _14=_5.hitch(this,function(_15){var _16=true;var _17={};if(_15){_1.forEach(_15.properties,_5.hitch(this,function(_18){_18.name=_8.pascalToCamel(_18.name);}));var _19=_15.savedContentLink;_17=_5.mixin({successful:false,contentLink:_16?_15.savedContentLink:_13,hasContentLinkChanged:_15.savedContentLink&&_19!=this.contentLink},_15);if(_19&&_19!=this.contentLink){_17.oldContentLink=this.contentLink;this.contentLink=_19;}}else{_16=false;}this._isSynchronizing=false;if(this._queue.length===0){this._stopSynchronizeInterval();this.set("hasPendingChanges",false);var def=this._saveDeferred;this._saveDeferred=null;if(_16){def.resolve(_17);}else{def.reject({contentLink:_13,properties:_12,error:"Unexpected result returned from the server."});}}});var _1a=_5.hitch(this,function(_1b){var _1c={contentLink:_13,properties:_12,error:_1b};this._isSynchronizing=false;if(this._queue.length===0){var def=this._saveDeferred;this._saveDeferred=null;this._stopSynchronizeInterval();this.set("hasPendingChanges",false);def.reject(_1c);}});_3.when(this._saveProperties(_12),_14,_1a);return this._saveDeferred;},pendingSync:function(_1d){return this._propertyIndexInQueue(_1d)!==-1;},_saveProperties:function(_1e){var _1f=this.contentLink;var _20={};_1.forEach(_1e,_5.hitch(this,function(_21){_20[_21.name]=_4.toJson(_21.value);}));var _22={id:_1f,properties:_20,publishChanges:this._publish};this._publish=false;return this.contentDataStore.patch(_22,{id:_22.id});}});});