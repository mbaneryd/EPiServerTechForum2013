(function(){function handleContentEditableSelection(ed){function getContentEditable(node){var contentEditable;if(1===node.nodeType){if(contentEditable=node.getAttribute(internalName),contentEditable&&"inherit"!==contentEditable)return contentEditable;if(contentEditable=node.contentEditable,"inherit"!==contentEditable)return contentEditable}return null}function getNonEditableParent(node){for(var state;node;){if(state=getContentEditable(node))return"false"===state?node:null;node=node.parentNode}}function getEditableParent(node){for(var state;node;){if(state=getContentEditable(node))return"true"===state?node:null;node=node.parentNode}}function getParentCaretContainer(node){for(;node;){if(node.id===caretContainerId)return node;node=node.parentNode}}function findFirstTextNode(node){var walker;if(node)for(walker=new TreeWalker(node,node),node=walker.current();node;node=walker.next())if(3===node.nodeType)return node}function insertCaretContainerOrExpandToBlock(target,before){var caretContainer,rng;return"false"===getContentEditable(target)&&dom.isBlock(target)?(selection.select(target),void 0):(rng=dom.createRng(),"true"===getContentEditable(target)&&(target.firstChild||target.appendChild(ed.getDoc().createTextNode(" ")),target=target.firstChild,before=!0),caretContainer=dom.create("span",{id:caretContainerId,"data-mce-bogus":!0},invisibleChar),before?target.parentNode.insertBefore(caretContainer,target):dom.insertAfter(caretContainer,target),rng.setStart(caretContainer.firstChild,1),rng.collapse(!0),selection.setRng(rng),caretContainer)}function removeCaretContainer(caretContainer){var child,currentCaretContainer,lastContainer;if(caretContainer)rng=selection.getRng(!0),rng.setStartBefore(caretContainer),rng.setEndBefore(caretContainer),child=findFirstTextNode(caretContainer),child&&child.nodeValue.charAt(0)==invisibleChar&&(child=child.deleteData(0,1)),dom.remove(caretContainer,!0),selection.setRng(rng);else for(currentCaretContainer=getParentCaretContainer(selection.getStart());(caretContainer=dom.get(caretContainerId))&&caretContainer!==lastContainer;)currentCaretContainer!==caretContainer&&(child=findFirstTextNode(caretContainer),child&&child.nodeValue.charAt(0)==invisibleChar&&(child=child.deleteData(0,1)),dom.remove(caretContainer,!0)),lastContainer=caretContainer}function moveSelection(ed,e){function hasSideContent(element,left){var container,offset,walker,node,len;if(container=rng.startContainer,offset=rng.startOffset,3==container.nodeType){if(len=container.nodeValue.length,offset>0&&len>offset||(left?offset==len:0==offset))return}else{if(!(container.childNodes.length>offset))return left?null:element;var pos=!left&&offset>0?offset-1:offset;container=container.childNodes[pos],container.hasChildNodes()&&(container=container.firstChild)}for(walker=new TreeWalker(container,element);node=walker[left?"prev":"next"]();){if(3===node.nodeType&&node.nodeValue.length>0)return;"true"===getContentEditable(node)}return element}var nonEditableStart,nonEditableEnd,isCollapsed,rng,element;previousDirection=e?e.keyCode==VK.LEFT||e.keyCode==VK.UP:!1,removeCaretContainer(),isCollapsed=selection.isCollapsed(),nonEditableStart=getNonEditableParent(selection.getStart()),nonEditableEnd=getNonEditableParent(selection.getEnd()),nonEditableStart||nonEditableEnd?(rng=selection.getRng(!0),isCollapsed?(nonEditableStart=nonEditableStart||nonEditableEnd,selection.getStart(),(element=hasSideContent(nonEditableStart,!0))?insertCaretContainerOrExpandToBlock(element,!0):(element=hasSideContent(nonEditableStart,!1))?insertCaretContainerOrExpandToBlock(element,!1):selection.select(nonEditableStart)):(rng=selection.getRng(!0),nonEditableStart&&rng.setStartBefore(nonEditableStart),nonEditableEnd&&rng.setEndAfter(nonEditableEnd),selection.setRng(rng))):movedIn=void 0!==ed&&isCollapsed&&getEditableParent(selection.getStart())!==ed.getBody()}function handleKey(ed,e){function getNonEmptyTextNodeSibling(node,prev){for(;node=node[prev?"previousSibling":"nextSibling"];)if(3!==node.nodeType||node.nodeValue.length>0)return node}function positionCaretOnElement(element,start){selection.select(element),selection.collapse(start)}function canDelete(backspace){function removeNodeIfNotParent(node){for(var parent=container;parent;){if(parent===node)return;parent=parent.parentNode}dom.remove(node),ed.undoManager.add(),moveSelection()}function isNextPrevTreeNodeNonEditable(){var node,walker,nonEmptyElements=ed.schema.getNonEmptyElements();for(walker=new tinymce.dom.TreeWalker(container,ed.getBody());(node=backspace?walker.prev():walker.next())&&!nonEmptyElements[node.nodeName.toLowerCase()]&&!(3===node.nodeType&&tinymce.trim(node.nodeValue).length>0);)if("false"===getContentEditable(node))return removeNodeIfNotParent(node),!0;return getNonEditableParent(node)?!0:!1}var rng,container,offset,nonEditableParent;if(selection.isCollapsed()){if(rng=selection.getRng(!0),container=rng.startContainer,offset=rng.startOffset,container=getParentCaretContainer(container)||container,nonEditableParent=getNonEditableParent(container))return removeNodeIfNotParent(nonEditableParent),!1;if(3==container.nodeType&&(backspace?offset>0:container.nodeValue.length>offset))return!0;if(1==container.nodeType&&(container=container.childNodes[offset]||container),isNextPrevTreeNodeNonEditable())return!1}return!0}var nonEditableParent,caretContainer,startElement,endElement,keyCode=e.keyCode;if(startElement=selection.getStart(),endElement=selection.getEnd(),nonEditableParent=getNonEditableParent(startElement)||getNonEditableParent(endElement),nonEditableParent&&(112>keyCode||keyCode>124||keyCode===VK.ENTER)){if((tinymce.isMac?e.metaKey:e.ctrlKey)&&(67==keyCode||88==keyCode||86==keyCode))return;if(e.preventDefault(),keyCode==VK.LEFT||keyCode==VK.UP||keyCode==VK.RIGHT||keyCode==VK.DOWN){var left=keyCode==VK.LEFT||keyCode==VK.UP;if(ed.dom.isBlock(nonEditableParent)){var targetElement,walker,temp,movingIn=!movedIn&&previousDirection===left;if(movingIn&&nonEditableParent.childNodes.length)for(walker=new TreeWalker(nonEditableParent.firstChild,nonEditableParent);temp=walker.next();)if("true"===ed.dom.getAttrib(temp,internalName)){targetElement=temp;break}targetElement?movedIn=!0:(targetElement=left?nonEditableParent.previousSibling:nonEditableParent.nextSibling,movedIn=!1),walker=new TreeWalker(targetElement,targetElement);var caretElement=left?walker.prev():walker.next();positionCaretOnElement(caretElement,!left)}else insertCaretContainerOrExpandToBlock(nonEditableParent,left)}else(keyCode===VK.DELETE||keyCode===VK.BACKSPACE||keyCode===VK.ENTER)&&dom.remove(nonEditableParent)}else if(keyCode==VK.LEFT||keyCode==VK.RIGHT||keyCode==VK.BACKSPACE||keyCode==VK.DELETE){if(caretContainer=getParentCaretContainer(startElement)){if(keyCode==VK.LEFT||keyCode==VK.BACKSPACE)if(nonEditableParent=getNonEmptyTextNodeSibling(caretContainer,!0),nonEditableParent&&"false"===getContentEditable(nonEditableParent)){if(e.preventDefault(),keyCode!=VK.LEFT)return dom.remove(nonEditableParent),void 0;positionCaretOnElement(nonEditableParent,!0)}else removeCaretContainer(caretContainer);if(keyCode==VK.RIGHT||keyCode==VK.DELETE)if(nonEditableParent=getNonEmptyTextNodeSibling(caretContainer),nonEditableParent&&"false"===getContentEditable(nonEditableParent)){if(e.preventDefault(),keyCode!=VK.RIGHT)return dom.remove(nonEditableParent),void 0;positionCaretOnElement(nonEditableParent,!1)}else removeCaretContainer(caretContainer)}if((keyCode==VK.BACKSPACE||keyCode==VK.DELETE)&&!canDelete(keyCode==VK.BACKSPACE))return e.preventDefault(),!1}}function preventDropAndPaste(e){var target=e.srcElement||e.originalTarget;return target===ed.getBody()&&(target=ed.selection.isCollapsed()?ed.selection.getNode():target),getNonEditableParent(target)?(ed.dom.events.cancel(e),!1):void 0}var invisibleChar,previousDirection,movedIn,dom=ed.dom,selection=ed.selection,caretContainerId="mce_noneditablecaret",invisibleChar="﻿";ed.onMouseDown.addToTop(function(ed,e){var node=ed.selection.getNode();"false"===getContentEditable(node)&&node==e.target&&moveSelection()}),ed.onMouseUp.addToTop(moveSelection),ed.onKeyDown.addToTop(handleKey),ed.onKeyUp.addToTop(moveSelection),ed.dom.bind(ed.getBody(),"drop",preventDropAndPaste),ed.dom.bind(ed.getBody(),"paste",preventDropAndPaste);var doc=ed.getDoc();doc.attachEvent&&doc.attachEvent("oncontrolselect",function(e){return getNonEditableParent(e.srcElement)?!1:void 0});var originalNormalize=ed.selection.normalize;ed.selection.normalize=function(){var rng=ed.selection.getRng(),body=dom.getRoot();if(rng.startContainer!==body||rng.endContainer!==body)return originalNormalize.apply(this,arguments);var container=rng.startContainer,offset=rng.startOffset,selectedNode=container.childNodes[Math.min(offset,container.childNodes.length-1)];if(!getNonEditableParent(selectedNode))return originalNormalize.apply(this,arguments)},ed.onBeforeExecCommand.add(function(ed,cmd,ui,value,args){if("mceInsertContent"===cmd&&ed.selection.isCollapsed()){var target=ed.selection.getNode();getNonEditableParent(target)&&(args.terminate=!0)}})}var TreeWalker=tinymce.dom.TreeWalker,externalName="contenteditable",internalName="data-mce-"+externalName,VK=tinymce.VK;tinymce.create("tinymce.plugins.NonEditablePlugin",{init:function(ed){function convertRegExpsToNonEditable(ed,args){var i=nonEditableRegExps.length,content=args.content,cls=tinymce.trim(nonEditClass);if("raw"!=args.format){for(;i--;)content=content.replace(nonEditableRegExps[i],function(match){var args=arguments,index=args[args.length-2];return index>0&&'"'==content.charAt(index-1)?match:'<span class="'+cls+'" data-mce-content="'+ed.dom.encode(args[0])+'">'+ed.dom.encode("string"==typeof args[1]?args[1]:args[0])+"</span>"});args.content=content}}var editClass,nonEditClass,nonEditableRegExps;editClass=" "+tinymce.trim(ed.getParam("noneditable_editable_class","mceEditable"))+" ",nonEditClass=" "+tinymce.trim(ed.getParam("noneditable_noneditable_class","mceNonEditable"))+" ",nonEditableRegExps=ed.getParam("noneditable_regexp"),nonEditableRegExps&&!nonEditableRegExps.length&&(nonEditableRegExps=[nonEditableRegExps]),ed.onPreInit.add(function(){handleContentEditableSelection(ed),nonEditableRegExps&&(ed.selection.onBeforeSetContent.add(convertRegExpsToNonEditable),ed.onBeforeSetContent.add(convertRegExpsToNonEditable)),ed.parser.addAttributeFilter("class",function(nodes){for(var className,node,i=nodes.length;i--;)node=nodes[i],className=" "+node.attr("class")+" ",-1!==className.indexOf(editClass)?node.attr(internalName,"true"):-1!==className.indexOf(nonEditClass)&&node.attr(internalName,"false")}),ed.serializer.addAttributeFilter(internalName,function(nodes){for(var node,i=nodes.length;i--;)node=nodes[i],nonEditableRegExps&&node.attr("data-mce-content")?(node.name="#text",node.type=3,node.raw=!0,node.value=node.attr("data-mce-content")):(node.attr(externalName,null),node.attr(internalName,null))}),ed.parser.addAttributeFilter(externalName,function(nodes){for(var node,i=nodes.length;i--;)node=nodes[i],node.attr(internalName,node.attr(externalName)),node.attr(externalName,null)})})},getInfo:function(){return{longname:"Non editable elements",author:"Moxiecode Systems AB",authorurl:"http://tinymce.moxiecode.com",infourl:"http://wiki.moxiecode.com/index.php/TinyMCE:Plugins/noneditable",version:tinymce.majorVersion+"."+tinymce.minorVersion}}}),tinymce.PluginManager.add("noneditable",tinymce.plugins.NonEditablePlugin)})();