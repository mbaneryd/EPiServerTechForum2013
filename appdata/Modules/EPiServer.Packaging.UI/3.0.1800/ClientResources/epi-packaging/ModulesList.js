//>>built
define("epi-packaging/ModulesList",["dojo","dijit","dojo/cookie","dijit/_Widget","dijit/_TemplatedMixin","dojox/widget/Standby","epi-packaging/ModuleSummary","epi/i18n!epi/packaging/nls/EPiServer.Packaging.UI.ModulesList"],function(_1,_2,_3,_4,_5,_6,_7,_8){return _1.declare([_4,_5],{res:_8,antiForgeryData:null,templateString:"<div class=\"epi-listingContainer\"><ul data-dojo-attach-point=\"_modulesListPlaceholder\" class=\"epi-advancedListing\"></ul></div>",listItemTemplateString:null,listingUrl:null,feedName:null,hideModuleInListOnAction:false,emptyListMessage:"No add-on found.",_dataStore:null,_listItems:null,_standbyWigdet:null,startup:function(){if(this._started){return;}this._standbyWigdet=this._createStandbyWidget();document.body.appendChild(this._standbyWigdet.domNode);this._standbyWigdet.startup();this.inherited(arguments);},_createStandbyWidget:function(){return new dojox.widget.Standby({target:this._modulesListPlaceholder});},destroy:function(){this._destroyModuleList();this._standbyWigdet.destroyRecursive(false);this.inherited(arguments);},updateView:function(){this._listModules(true);},onSiteRestartRequired:function(){},onError:function(_9){},onSuccess:function(_a){},onModuleActionPerformed:function(){},_listModules:function(_b){if(this.listingUrl==""){return;}if(!this._dataStore||_b){var _c={feedName:this.feedName};this.antiForgeryData.AddAntiforgeryToken(_c);this._standbyWigdet.show();_1.xhrPost({content:_c,url:this.listingUrl,handleAs:"json",load:_1.hitch(this,function(_d,_e){if(!_d){return;}else{if(_d.errors&&_d.errors.length>0){this._showErrors(_d.errors);}this._dataStore=new _1.store.Memory({data:_d.modules});this._buildModuleList();}}),error:_1.hitch(this,function(_f,_10){var _11=_1.replace(this.res.addonlistreaderror,{error:_f});this._showErrors([_11]);_1.publish("onServerError",[_10]);}),handle:_1.hitch(this,function(_12,_13){this._standbyWigdet.hide();})});}else{this._buildModuleList();}},_buildModuleList:function(){var _14=this._dataStore.query({},{sort:[{attribute:"title",descending:false},{attribute:"versionMajor",descending:true},{attribute:"versionMinor",descending:true},{attribute:"versionBuild",descending:true},{attribute:"versionRevision",descending:true},{attribute:"versionSpecial",descending:false}]});this._renderModules(_14);},_createModuleSummary:function(_15,_16){var li=_1.create("li",{"class":"clearfix"},_16);var div=_1.create("div",{},li);return new _7(_15,div);},_renderModules:function(_17){_1.empty(this._modulesListPlaceholder);this._destroyModuleList();if(_17.length==0){this._showEmptyListMessage();return;}_1.forEach(_17,function(_18,i){var _19={module:_18,antiForgeryData:this.antiForgeryData,itemIndex:i};if(this.listItemTemplateString){_19.templateString=this.listItemTemplateString;}var _1a=this._createModuleSummary(_19,this._modulesListPlaceholder);_1a.startup();this._connectModuleSummaryEvents(_1a);},this);},_connectModuleSummaryEvents:function(_1b){var _1c=this.connect(_1b,"onInstall",function(_1d){this._onModuleAction(_1d);var _1e=_1.replace(this.res.installsuccess,_1d.module);this.onSuccess([_1e]);this._ensureReload();});var _1f=this.connect(_1b,"onUninstall",function(_20){this._onModuleAction(_20);var _21=_1.replace(this.res.uninstallsuccess,_20.module);this.onSuccess([_21]);this._ensureReload();});var _22=this.connect(_1b,"onUpdate",function(_23){this._onModuleAction(_23);var _24=_1.replace(this.res.updatesuccess,_23.module);this.onSuccess([_24]);this._ensureReload(_23);});var _25=this.connect(_1b,"onEnable",function(_26){this._onModuleAction(_26);var _27=_1.replace(this.res.enablesuccess,_26.module);this.onSuccess([_27]);this._ensureReload(_26);});var _28=this.connect(_1b,"onDisable",function(_29){this._onModuleAction(_29);var _2a=_1.replace(this.res.disablesuccess,_29.module);this.onSuccess([_2a]);this._ensureReload(_29);});var _2b=this.connect(_1b,"onInstallError",function(_2c){this.onModuleActionPerformed();var _2d=this._getErrorMessages(this.res.installationerror,_2c.module);this._showErrors(_2d);});var _2e=this.connect(_1b,"onUninstallError",function(_2f){this.onModuleActionPerformed();var _30=this._getErrorMessages(this.res.uninstallationerror,_2f.module);this._showErrors(_30);});var _31=this.connect(_1b,"onUpdateError",function(_32){this.onModuleActionPerformed();var _33=this._getErrorMessages(this.res.updateerror,_32.module);this._showErrors(_33);});var _34=this.connect(_1b,"onEnableError",function(_35){this.onModuleActionPerformed();var _36=this._getErrorMessages(this.res.enableerror,_35.module);this._showErrors([_36]);});var _37=this.connect(_1b,"onDisableError",function(_38){this.onModuleActionPerformed();var _39=this._getErrorMessages(this.res.disableerror,_38.module);this._showErrors([_39]);});var _3a={widget:_1b,handlers:[_1c,_1f,_22,_25,_28,_2b,_2e,_31,_34,_37]};this._listItems.push(_3a);},_getErrorMessages:function(_3b,_3c){var _3d=[_1.replace(_3b,_3c)];if(_3c.errors&&_3c.errors.length){_3d=_3d.concat(_3c.errors);}return _3d;},_ensureReload:function(){_1.publish("onReloadRequired");},_onModuleAction:function(_3e){if(this.hideModuleInListOnAction){this._removeModuleFromList(_3e);}this.onSiteRestartRequired();this.updateView();this.onModuleActionPerformed();},_removeModuleFromList:function(_3f){var _40=_1.filter(this._listItems,function(_41){return _41.widget==_3f;});_1.forEach(_40,function(_42,i){var _43=_42.widget.domNode.parentNode;this._destroyListItem(_42);var _44=_1.indexOf(this._listItems,_42);if(_44>-1){this._listItems.splice(_44,1);}_1.destroy(_43);},this);if(this._listItems.length==0){this._showEmptyListMessage();}},_destroyModuleList:function(){_1.forEach(this._listItems,function(_45,i){this._destroyListItem(_45);},this);this._listItems=[];},_destroyListItem:function(_46){_1.forEach(_46.handlers,function(_47){this.disconnect(_47);},this);_46.widget.destroyRecursive(false);},_showErrors:function(_48){this.onError(_48);},_showEmptyListMessage:function(){var li=_1.create("li",{},this._modulesListPlaceholder);var div=_1.create("div",{innerHTML:"<span>"+this.emptyListMessage+"</span>"},li);_1.addClass(div,"emptyListMessageContainer");}});});