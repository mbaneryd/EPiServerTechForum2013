//>>built
define("epi/shell/widget/GadgetWrapper",["epi","dojo","dijit","dijit/_Widget","dijit/_TemplatedMixin","dijit/_WidgetsInTemplateMixin","dojox/layout/ContentPane","epi/routes","epi/shell/Error","epi/clientResourcesLoader","dojo/NodeList-traverse","epi/i18n!epi/shell/ui/nls/EPiServer.Shell.UI.Resources.GadgetChrome","epi/i18n!epi/shell/nls/EPiServer.Shell.Resources.Texts"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d){_1.gadget=(function(){var _e={};_e.gadgetIdHash={};_e.getByElement=function(_f){_f=(_f.jquery?_f.context:_f);var _10=_2.query(_f).closest("div.epi-gadgetInner");if(_10.length==1){var _11=_3.byNode(_10[0]);return _11.getInstance();}else{return null;}};_e.getById=function(_12){var _13=_e.gadgetIdHash[_12];if(!_13){console.error("Gadget with ID "+_12+" is not found in the epi.gadget.gadgetIdHash");return null;}var _14=_3.byId(_13);return _14.getInstance();};_e.loadView=function(_15,_16){_e.getByElement(_15).loadView(_16);};_e.visibilityChanged=function(_17,_18){_e.getByElement(_17).triggerVisibilityChanged();};_e.unload=function(_19){_e.getByElement(_19).triggerUnload();};return _e;})();return _2.declare([_4,_5,_6],{res:_2.mixin({},_d,_c),componentId:null,element:null,defaultRouteParams:null,routeData:null,templateString:"<div class=\"epi-gadgetInner\" data-dojo-attach-point=\"gadgetContainer\">                              <div class=\"epi-gadgetFeedback\" data-dojo-attach-point=\"gadgetFeedback\">&nbsp;</div>                              <div class=\"epi-gadgetContent\" ioArgs=\"{ preventCache: true }\" data-dojo-type=\"dojox/layout/ContentPane\" data-dojo-attach-point=\"gadgetContent\"></div>                          </div>",stylePaths:null,scriptPaths:null,constructor:function(){this.stylePaths=[];this.scriptPaths=[];},startup:function(){if(this._started){return;}this.inherited(arguments);if(!this.routeData){this.set("content","Missing route data");return;}this.defaultRouteParams={};for(var _1a in this.routeData){if(_1a[0]!="_"){this.defaultRouteParams[_1a]=this.routeData[_1a];}}var _1b=_1.clientResourcesLoader.loadResources(this.stylePaths,this.scriptPaths);_2.when(_1b,_2.hitch(this,function(){_1.gadget.gadgetIdHash[this.componentId]=this.id;var _1c=this.getInstance();_1c.routeParams=_2.mixin(this.defaultRouteParams,{gadgetId:this.componentId});this.gadgetContent.set("id","gadget_"+_1c.id);$(_1c.element).bind("_epigadgetloadedinternal",_2.hitch(this,this._onEpiGadgetLoaded));try{if(typeof this.initMethod=="string"){var _1d=_2.getObject(this.initMethod);$(_1c.element).bind("epigadgetinit",_1d);}}catch(ex){this.setErrorMessage(ex.message);}$(_1c.element).trigger("epigadgetinit",_1c);this.connect(this.gadgetContent,"onDownloadEnd",function(){$(_1c.element).trigger("_epigadgetloadedinternal");});this.loadView(this.defaultRouteParams);}));},destroy:function(){delete _1.gadget.gadgetIdHash[this.componentId];this.inherited(arguments);},getInstance:function(){if(this.instance){return this.instance;}this.instance=this._gadgetInstance();return this.instance;},getId:function(){return this.componentId;},getActionPath:function(_1e){return _8.getActionPath(this._mergeRouteParameters(_1e),null);},_onEpiGadgetLoaded:function(){var _1f=this.getInstance();$("form.epi-gadgetform",_1f.element).validate({errorElement:"span"});$("form.epi-gadgetform",_1f.element).bind("submit",_1f,this._submitHandler);try{$(_1f.element).trigger("epigadgetloaded",_1f);}catch(err){this.setErrorMessage(this.res.gadgetinitfailed,{details:err.message,errorThrown:true});}},_mergeRouteParameters:function(_20){return _2.mixin({},this.defaultRouteParams,_20);},_submitHandler:function(e){var _21=e.data;var _22=this;if($(_22).valid()){var _23=jQuery.Event("epigadgetsubmit");_23.target=_22;$(_22).trigger(_23,_21);if(!_23.isDefaultPrevented()){var _24=$(_22).serializeArray();_24.push({name:"gadgetId",value:_21.id});_21.ajax({url:_22.action,dataType:"html",data:_24,success:function(_25){_21.routeParams={};_21.gadgetContent.set("content",_25.toString());$(_21.element).trigger("_epigadgetloadedinternal");}});}}e.preventDefault();},loadView:function(_26){this.isVisible=true;var _27=this.getInstance();if(_26){_27.routeParams=_26;}else{_27.routeParams=this.defaultRouteParams;}var url=_27.getActionPath(_27.routeParams);this.gadgetContent.set("href",url);},getIsVisible:function(){return this.isVisible;},setErrorMessage:function(_28,_29){_29=_2.mixin({details:"",status:0,errorThrown:false},_29);var _2a=_2.query(".epi-gadgetError",this.gadgetContainer);if(_2a.length===0){_2a=_2.create("div",{"class":"epi-feedbackContent-error epi-feedbackContent epi-gadgetError"},this.gadgetContainer,"before");}_9.createErrorMessage(_2a,_28,_29.details,_29.status,true);_2.style(_2a,"display","block");},clearErrorMessage:function(){var _2b=_2.query(".epi-gadgetError",this.gadgetContainer);_2.style(_2b,"display","none");},setFeedbackMessage:function(_2c,_2d){_2d=_2.mixin({ajaxLoader:false,feedbackMessage:_2c,feedbackTitle:"",feedbackHideDelay:0,feedbackFadeOut:false},_2d);this.gadgetFeedback.innerHTML=_2d.feedbackMessage;_2.style(this.gadgetFeedback,"display","block");if(_2d.ajaxLoader){_2.addClass(this.gadgetFeedback,"epi-gadgetLoader");}if(_2d.feedbackHideDelay>0){var _2e=this;setTimeout(function(){_2e.clearFeedbackMessage(_2d);},_2d.feedbackHideDelay);}else{if(_2d.feedbackFadeOut){this.clearFeedbackMessage(_2d);}}},clearFeedbackMessage:function(_2f){_2.removeClass(this.gadgetFeedback,"epi-gadgetLoader");if(_2f&&_2f.feedbackFadeOut&&_2.style(this.gadgetFeedback,"display")=="block"){var _30={node:this.gadgetFeedback,duration:4000,onEnd:_2.hitch(this,function(){_2.style(this.gadgetFeedback,"display","none");_2.style(this.gadgetFeedback,"opacity","1");})};_2.fadeOut(_30).play();}else{_2.style(this.gadgetFeedback,"display","none");}},triggerUnload:function(){$(this.getInstance().element).trigger("epigadgetunload",this.getInstance());},triggerVisibilityChanged:function(_31){this.isVisible=_31;$(this.getInstance().element).trigger("epigadgetvisibilitychanged",this.getInstance());},_gadgetInstance:function(){var _32=this;var pub={id:_32.componentId,element:_32.gadgetContainer,gadgetContent:_32.gadgetContent,routeParams:{}};pub.getActionPath=function(_33){return _32.getActionPath(_33);};pub.loadView=function(_34){_32.loadView(_34);};pub.isVisible=function(){return _32.getIsVisible();};pub.setErrorMessage=function(_35,_36){_32.setErrorMessage(_35,_36);};pub.clearErrorMessage=function(){_32.clearErrorMessage();};pub.setFeedbackMessage=function(_37,_38){_32.setFeedbackMessage(_37,_38);};pub.clearFeedbackMessage=function(){_32.clearFeedbackMessage();};pub.raiseErrorEvent=function(_39){this.error=_39;$(this.element).trigger("epigadgeterror",this);this.error=null;};pub.ajax=function(_3a){var _3b=this;var _3c={dataType:"json",feedbackMessage:"",cache:false,type:"POST",ajaxLoader:true,error:function(_3d,_3e,_3f){_3b.clearFeedbackMessage();_3b.raiseErrorEvent({xmlHttpRequest:_3d,status:_3e,errorThrown:_3f});_3b.setErrorMessage("<strong>"+_32.res.internalservererror+" ["+_3d.status+"]</strong>.",{details:_3d.responseText,status:_3e,errorThrown:_3f});},success:function(_40){_3b.clearFeedbackMessage();}};var _41=$("input[name=__RequestVerificationToken]",this.element);if(_41.length>0){var _42={__RequestVerificationToken:_41.val()};if(_3a.data){if(!_3a.data.__RequestVerificationToken){_3a.data=$.extend(_3a.data,_42);}}else{_3a.data=_42;}}if($.isFunction(_3a.success)){var _43=_3a.success;_3a.success=function(_44,_45){_3b.clearFeedbackMessage();_43.call(this,_44,_45);};}if($.isFunction(_3a.error)){var _46=_3a.error;_3a.error=function(_47,_48,_49){_3b.clearFeedbackMessage();_46.call(this,_47,_48,_49);};}_3c=$.extend(_3c,_3a);_3b.setFeedbackMessage("",_3c);$.ajax(_3c);};return pub;}});});