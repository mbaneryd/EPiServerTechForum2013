//>>built
define("epi/shell/dnd/_MarkerSource",["dojo/_base/array","dojo/_base/declare","dojo/dnd/Manager","dojo/dom-class","dojo/dom-construct","dojo/dom-geometry","dojo/dom-style"],function(_1,_2,_3,_4,_5,_6,_7){return _2(null,{_markerNode:null,markerTemplateString:"<div class=\"dojoDndItem-marker\"><div class=\"epi-dndDropMarker\"></div></div>",markerDelay:150,markOnlyAllowedDropLocations:false,_calculatedCurrent:false,destroy:function(){this.inherited(arguments);this.targetAnchorSibling=null;if(this._markerNode){_5.destroy(this._markerNode);this._markerNode=null;}},setHorizontal:function(_8){_4.toggle(this.node,"dojoDndHorizontal",_8);this.horizontal=_8;},onMouseOver:function(e){this.inherited(arguments);this._calculatedCurrent=false;},onMouseMove:function(e){if(this.isDragging&&this.targetState=="Disabled"){return;}dojo.dnd.Source.superclass.onMouseMove.call(this,e);var m=_3.manager();if(!this.isDragging){if(this.mouseDown&&this.isSource&&(Math.abs(e.pageX-this._lastX)>this.delay||Math.abs(e.pageY-this._lastY)>this.delay)){var _9=this.getSelectedNodes();if(_9.length){m.startDrag(this,_9,this.copyState(dojo.isCopyKey(e),true));}}}if(this.isDragging){var _a=false;if(this.current&&!this._calculatedCurrent){if(!this.targetBox||this.targetAnchor!=this.current){this.targetBox=_6.position(this.current,true);}if(this.horizontal){_a=(e.pageX-this.targetBox.x)<(this.targetBox.w/2);}else{_a=(e.pageY-this.targetBox.y)<(this.targetBox.h/2);}}else{_a=this._calculateCurrent({x:e.pageX,y:e.pageY});}if(this.current!=this.targetAnchor||_a!=this.before){this._markTargetAnchor(_a);m.canDrop(!this.current||m.source!=this||!this.markOnlyAllowedDropLocations||!(this.current.id in this.selection));}}},_calculateCurrent:function(_b){var _c=[],_d,_e;function _f(_10,_11){function _12(_13){return _13*_13;};return Math.sqrt(_12(_10.x-_11.x)+_12(_10.y-_11.y));};this.getAllNodes().forEach(function(_14){var pos=_6.position(_14);pos.x2=pos.x+pos.w;pos.xCentered=pos.x+pos.w/2;pos.y2=pos.y+pos.h;pos.yCentered=pos.y+pos.h/2;if(this.horizontal){_c.push({node:_14,before:true,x:pos.x,y:pos.yCentered},{node:_14,before:false,x:pos.x2,y:pos.yCentered});}else{_c.push({node:_14,before:true,x:pos.xCentered,y:pos.y},{node:_14,before:false,x:pos.xCentered,y:pos.y2});}},this);_1.forEach(_c,function(_15){_15.distance=_f(_b,_15);if(!_d||_15.distance<_e){_d=_15;_e=_15.distance;}},this);if(_d){this.current=_d.node;this._calculatedCurrent=true;return _d.before;}return false;},_markTargetAnchor:function(_16){var _17=true,_18=true;if(this.current===this.targetAnchor&&this.before===_16){return;}if(this.targetAnchor){this._removeItemClass(this.targetAnchor,this.before?"Before":"After");}if(this.targetAnchorSibling){this._removeItemClass(this.targetAnchorSibling,!this.before?"Before":"After");}this.targetAnchor=this.current;this.targetBox=null;this.before=_16;if(this.targetAnchor){this.targetAnchorSibling=_16?this.targetAnchor.previousSibling:this.targetAnchor.nextSibling;if(!(this.targetAnchorSibling&&this.targetAnchorSibling.nodeType===1&&_4.contains(this.targetAnchorSibling,"dojoDndItem"))){this.targetAnchorSibling=null;}if(this.markOnlyAllowedDropLocations){_17=!(this.targetAnchor.id in this.selection);_18=!this.targetAnchorSibling||!(this.targetAnchorSibling.id in this.selection);}if(_17&&_18){this._addItemClass(this.targetAnchor,this.before?"Before":"After");}if(this.targetAnchorSibling&&_17&&_18){this._addItemClass(this.targetAnchorSibling,!this.before?"Before":"After");}this._positionMarker(_17&&_18);}else{this._positionMarker(false);}},_unmarkTargetAnchor:function(){if(this.targetAnchor){this._removeItemClass(this.targetAnchor,this.before?"Before":"After");}if(this.targetAnchorSibling){this._removeItemClass(this.targetAnchorSibling,!this.before?"Before":"After");}this._positionMarker(false);this.targetAnchor=this.targetAnchorSibling=this.targetBox=null;this.before=true;},_positionMarker:function(_19){var _1a=this._markerNode,_1b,_1c,_1d,_1e,top,_1f,_20,gap=-1;if(_19){_1b=_6.position(this.targetAnchor,false);_1c=this.targetAnchorSibling?_6.position(this.targetAnchorSibling,false):{h:0,w:0};_1d=_6.position(this.node,false);if(this.horizontal){if(this.before){_1f=_1b.x-_1d.x;if(this.targetAnchorSibling){gap=(_1b.x-_1c.x-_1c.w)/2;}if(gap>=0){_1f-=gap;}}else{_1f=_1b.x+_1b.w-_1d.x;if(this.targetAnchorSibling){gap=(_1c.x-_1b.x-_1b.w)/2;}if(gap>=0){_1f+=gap;}}_20=gap>=0?Math.max(_1b.h,_1c.h):_1b.h;_1e={display:"block",top:_1b.y-_1d.y+"px",left:_1f+"px",height:_20+"px"};}else{if(this.before){top=_1b.y-_1d.y;if(this.targetAnchorSibling){gap=(_1b.y-_1c.y-_1c.h)/2;}if(gap>=0){top-=gap;}}else{top=_1b.y+_1b.h-_1d.y;if(this.targetAnchorSibling){gap=(_1c.x-_1b.x-_1b.w)/2;}if(gap>=0){top-=gap;}}width=gap>=0?Math.max(_1b.w,_1c.w):_1b.w;_1e={display:"block",top:top+"px",width:width+"px"};}}else{_1e={display:"none"};}if(!_1a){_1a=this._markerNode=_5.place(this.markerTemplateString,this.node);_7.set(_1a,_1e);}else{setTimeout(function(){_7.set(_1a,_1e);},this.markerDelay);}}});});