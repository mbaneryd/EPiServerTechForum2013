//>>built
define("epi/shell/store/Patchable",["dojo/_base/Deferred","dojo/_base/lang","dojo/store/Cache","dojo/store/Observable"],function(_1,_2,_3,_4){var _5=_2.getObject("epi.shell.store",true);return _5.Patchable=function(_6,_7,_8){var _9=_3(_6,_7,_8||{}),_a=[];var _b=function(_c,_d){if(typeof _d=="object"){_c[_e.idProperty]=_d[_e.idProperty];}else{_c[_e.idProperty]=_d;}};var _f=function(_10){_10._cached=new Date();return _10;};var _11=function(_12){if(!_12._cached){return false;}var now=new Date();now.setMinutes(now.getMinutes()-5);return now>_12._cached;};_9.get=function(id,_13){return _1.when(_7.get(id),function(_14){if(_14){if(_11(_14)){_9.evict(id,_13);_14=null;}}return _14||_1.when(_6.get(id,_13),function(_15){if(_15){_7.put(_f(_15),{id:id});}return _15;});});};_9.put=function(_16,_17){_7.remove((_17&&_17.id)||this.getIdentity(_16));return _1.when(_6.put(_16,_17),function(_18){_b(_16,_18);_7.put(typeof _18=="object"?_f(_18):_f(_16),_17);return _18;});};_9.add=function(_19,_1a){return _1.when(_6.add(_19,_1a),function(_1b){_b(_19,_1b);_7.add(typeof _1b=="object"?_f(_1b):_f(_19),_1a);return _1b;});};var _1c=function(obj){return obj&&_2.isObject(obj)&&!_2.isArray(obj)&&!_2.isFunction(obj);};var _1d=function(_1e,_1f){var _20,s,_21={};for(_20 in _1f){s=_1f[_20];if(_20 in _1e&&(_1e[_20]!==s&&(!(_20 in _21)||_21[_20]!==s))){if(_1c(s)&&_1c(_1e[_20])){_1d(_1e[_20],s);}else{_1e[_20]=s;}}}return _1e;};var _e=_2.delegate(_4(_9),{refresh:function(id){return _1.when(this.evict(id),_2.hitch(this,function(){return _1.when(this.get(id),_2.hitch(this,function(_22){if(_22){this.notify(_22,id);this.updateDependentStores(_22);this.onItemChanged(id,_22);}return _22;}));}));},patchCache:function(_23){if(!_23){return;}var id=this.getIdentity(_23);return _1.when(this.get(id),_2.hitch(this,function(_24){if(_24){_24=_1d(_24,_23);_1.when(_7.put(_24,{overwrite:true}),_2.hitch(this,function(){this.notify(_24,id);this.updateDependentStores(_23);this.onItemChanged(id,_24);}));}return _24;}));},addDependentStore:function(_25,_26){if(!_25.patchCache){throw new Error("addDependentStore: The store must implement the patch method.");}_a.push({store:_25,options:_26||{}});},updateDependentStores:function(_27){for(var i=_a.length-1;i>=0;i--){var _28=_a[i].store;if(_a[i].options.refreshOnPatch){var _29=_a[i].options.refresh;if(typeof _29==="function"){_29(_27);}else{_28.refresh(this.getIdentity(_27));}}else{var _2a=_a[i].options.transformDelegate;_28.patchCache(typeof _2a==="function"?_2a(_27):_27);}}},onItemChanged:function(id,_2b){}});return _e;};});