//>>built
define("dgrid/tree",["dojo/_base/declare","dojo/_base/array","dojo/_base/Deferred","dojo/query","dojo/on","dojo/aspect","./util/has-css3","./Grid","dojo/has!touch?./util/touch","put-selector/put"],function(_1,_2,_3,_4,on,_5,_6,_7,_8,_9){function _a(_b,_c,_d,_e){var _f=this.grid.isRTL?"right":"left",cls=".dgrid-expando-icon",_10;if(_c){cls+=".ui-icon.ui-icon-triangle-1-"+(_d?"se":"e");}_10=_9("div"+cls+"[style=margin-"+_f+": "+(_b*(this.indentWidth||9))+"px; float: "+_f+"]");_10.innerHTML="&nbsp;";return _10;};function _11(_12){var _13=this,_14=this.style.height;if(_14){this.style.display=_14=="0px"?"none":"block";}if(_12){_9(this,".dgrid-tree-resetting");setTimeout(function(){_9(_13,"!dgrid-tree-resetting");});}this.style.height="";};function _15(_16){var _17=_16.renderCell||_7.defaultRenderCell;var _18,_19;if(!_16){_16={};}_16.shouldExpand=_16.shouldExpand||function(row,_1a,_1b){return _1b;};_5.after(_16,"init",function(){var _1c=_16.grid,_1d=".dgrid-content .dgrid-column-"+_16.id,_1e=[];if(!_1c.store){throw new Error("dgrid tree column plugin requires a store to operate.");}if(!_16.renderExpando){_16.renderExpando=_a;}_1e.push(_1c.on(_16.expandOn||".dgrid-expando-icon:click,"+_1d+":dblclick,"+_1d+":keydown",function(_1f){var row=_1c.row(_1f);if((!_1c.store.mayHaveChildren||_1c.store.mayHaveChildren(row.data))&&(_1f.type!="keydown"||_1f.keyCode==32)&&!(_1f.type=="dblclick"&&_19&&_19.count>1&&row.id==_19.id&&_1f.target.className.indexOf("dgrid-expando-icon")>-1)){_1c.expand(row);}if(_1f.target.className.indexOf("dgrid-expando-icon")>-1){if(_19&&_19.id==_1c.row(_1f).id){_19.count++;}else{_19={id:_1c.row(_1f).id,count:1};}}}));if(_6("touch")){_1e.push(_1c.on(_8.selector(_1d,_8.dbltap),function(){_1c.expand(this);}));}if(!_1c._expanded){_1c._expanded={};}_1e.push(_5.after(_1c,"insertRow",function(_20){var row=this.row(_20),_21=_16.shouldExpand(row,_18,this._expanded[row.id]);if(_21){this.expand(_20,true,true);}return _20;}));_1e.push(_5.before(_1c,"removeRow",function(_22,_23){var _24=_22.connected;if(_24){_4(">.dgrid-row",_24).forEach(function(_25){_1c.removeRow(_25,true);});if(!_23){_9(_24,"!");}}}));if(_16.collapseOnRefresh){_1e.push(_5.after(_1c,"cleanup",function(){this._expanded={};}));}_1c._calcRowHeight=function(_26){var _27=_26.connected;return _26.offsetHeight+(_27?_27.offsetHeight:0);};_1c.expand=function(_28,_29,_2a){var row=_28.element?_28:_1c.row(_28),_2b=_6("transitionend");_28=row.element;_28=_28.className.indexOf("dgrid-expando-icon")>-1?_28:_4(".dgrid-expando-icon",_28)[0];if(_28&&_28.mayHaveChildren&&(_2a||_29!==!!this._expanded[row.id])){var _2c=_29===undefined?!this._expanded[row.id]:_29;_9(_28,".ui-icon-triangle-1-"+(_2c?"se":"e")+"!ui-icon-triangle-1-"+(_2c?"e":"se"));var _2d=_28.preloadNode,_2e=row.element,_2f,_30,_31,_32;if(!_2d){_2f=_2e.connected=_9("div.dgrid-tree-container");_2d=_28.preloadNode=_9(_2e,"+",_2f,"div.dgrid-preload");var _33=function(_34){return _1c.store.getChildren(row.data,_34);};_33.level=_28.level;if(_16.allowDuplicates){_32={parentId:row.id};}_3.when(_1c.renderQuery?_1c._trackError(function(){return _1c.renderQuery(_33,_2d,_32);}):_1c.renderArray(_33(_32),_2d,{query:_33}),function(){if(_1c._expanded[row.id]&&_2b){var _35=_2f.scrollHeight;_2f.style.height=_35?_35+"px":"auto";}});if(_2b){on(_2f,_2b,_11);}else{_11.call(_2f);}}_2f=_2e.connected;_2f.hidden=!_2c;_30=_2f.style;if(!_2b||_2a){_30.display=_2c?"block":"none";_30.height="";}else{if(_2c){_30.display="block";_31=_2f.scrollHeight;_30.height="0px";}else{_9(_2f,".dgrid-tree-resetting");_30.height=_2f.scrollHeight+"px";}setTimeout(function(){_9(_2f,"!dgrid-tree-resetting");_30.height=_2c?(_31?_31+"px":"auto"):"0px";});}if(_2c){this._expanded[row.id]=true;}else{delete this._expanded[row.id];}}};_5.after(_16,"destroy",function(){_2.forEach(_1e,function(l){l.remove();});delete _1c.expand;delete _1c._calcRowHeight;});});_16.renderCell=function(_36,_37,td,_38){var _39=_16.grid,_3a=Number(_38&&_38.query&&_38.query.level)+1,_3b=!_39.store.mayHaveChildren||_39.store.mayHaveChildren(_36),_3c=_38.parentId,_3d,_3e;_3a=_18=isNaN(_3a)?0:_3a;_3d=_16.renderExpando(_3a,_3b,_39._expanded[(_3c?_3c+"-":"")+_39.store.getIdentity(_36)],_36);_3d.level=_3a;_3d.mayHaveChildren=_3b;_3e=_17.call(_16,_36,_37,td,_38);if(_3e&&_3e.nodeType){_9(td,_3d);_9(td,_3e);}else{td.insertBefore(_3d,td.firstChild);}};return _16;};_15.defaultRenderExpando=_a;return _15;});