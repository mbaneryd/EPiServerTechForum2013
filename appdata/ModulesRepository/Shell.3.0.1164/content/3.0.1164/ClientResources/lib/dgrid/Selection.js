//>>built
define("dgrid/Selection",["dojo/_base/kernel","dojo/_base/declare","dojo/_base/Deferred","dojo/on","dojo/has","dojo/aspect","./List","dojo/has!touch?./util/touch","put-selector/put","dojo/query","dojo/_base/sniff"],function(_1,_2,_3,on,_4,_5,_6,_7,_8){_4.add("mspointer",function(_9,_a,_b){return "onmspointerdown" in _b;});_4.add("css-user-select",function(_c,_d,_e){var _f=_e.style,_10=["Khtml","O","ms","Moz","Webkit"],i=_10.length,_11="userSelect";do{if(typeof _f[_11]!=="undefined"){return _11;}}while(i--&&(_11=_10[i]+"UserSelect"));return false;});_4.add("dom-selectstart",typeof document.onselectstart!=="undefined");var _12=_4("mac")?"metaKey":"ctrlKey",_13=_4("css-user-select"),_14=_4("mspointer")?"MSPointerDown":"mousedown",_15=_4("mspointer")?"MSPointerUp":"mouseup";function _16(_17,_18){var _19=_17.unselectable=_18?"on":"",_1a=_17.getElementsByTagName("*"),i=_1a.length;while(--i){if(_1a[i].tagName==="INPUT"||_1a[i].tagName==="TEXTAREA"){continue;}_1a[i].unselectable=_19;}};function _1b(_1c,_1d){var _1e=_1c.bodyNode,_1f=_1d?"text":_4("ff")<21?"-moz-none":"none";if(_13){_1e.style[_13]=_1f;}else{if(_4("dom-selectstart")){if(!_1d&&!_1c._selectstartHandle){_1c._selectstartHandle=on(_1e,"selectstart",function(evt){var tag=evt.target&&evt.target.tagName;if(tag!=="INPUT"&&tag!=="TEXTAREA"){evt.preventDefault();}});}else{if(_1d&&_1c._selectstartHandle){_1c._selectstartHandle.remove();delete _1c._selectstartHandle;}}}else{_16(_1e,!_1d);if(!_1d&&!_1c._unselectableHandle){_1c._unselectableHandle=_5.after(_1c,"renderRow",function(row){_16(row,true);return row;});}else{if(_1d&&_1c._unselectableHandle){_1c._unselectableHandle.remove();delete _1c._unselectableHandle;}}}}};return _2(null,{selectionDelegate:".dgrid-row",selectionEvents:_14+","+_15+",dgrid-cellfocusin",deselectOnRefresh:true,allowSelectAll:false,selection:{},selectionMode:"extended",allowTextSelection:undefined,create:function(){this.selection={};return this.inherited(arguments);},postCreate:function(){this.inherited(arguments);var _20=this.selectionMode;this.selectionMode="";this._setSelectionMode(_20);this._initSelectionEvents();},destroy:function(){this.inherited(arguments);if(this._selectstartHandle){this._selectstartHandle.remove();}if(this._unselectableHandle){this._unselectableHandle.remove();}if(this._deselectionHandle){this._deselectionHandle.remove();}},_setSelectionMode:function(_21){if(_21==this.selectionMode){return;}this.clearSelection();this.selectionMode=_21;this._selectionHandlerName="_"+_21+"SelectionHandler";this._setAllowTextSelection(this.allowTextSelection);},setSelectionMode:function(_22){_1.deprecated("setSelectionMode(...)","use set(\"selectionMode\", ...) instead","dgrid 0.4");this.set("selectionMode",_22);},_setAllowTextSelection:function(_23){if(typeof _23!=="undefined"){_1b(this,_23);}else{_1b(this,this.selectionMode==="none");}this.allowTextSelection=_23;},_handleSelect:function(_24,_25){if(!this[this._selectionHandlerName]||(_24.type==="dgrid-cellfocusin"&&_24.parentType==="mousedown")||(_24.type===_15&&_25!=this._waitForMouseUp)){return;}this._waitForMouseUp=null;this._selectionTriggerEvent=_24;if(!_24.keyCode||!_24.ctrlKey||_24.keyCode==32){if(!_24.shiftKey&&_24.type===_14&&this.isSelected(_25)){this._waitForMouseUp=_25;}else{this[this._selectionHandlerName](_24,_25);}}this._selectionTriggerEvent=null;},_singleSelectionHandler:function(_26,_27){var _28=_26.keyCode?_26.ctrlKey:_26[_12];if(this._lastSelected===_27){this.select(_27,null,!_28||!this.isSelected(_27));}else{this.clearSelection();this.select(_27);this._lastSelected=_27;}},_multipleSelectionHandler:function(_29,_2a){var _2b=this._lastSelected,_2c=_29.keyCode?_29.ctrlKey:_29[_12],_2d;if(!_29.shiftKey){_2d=_2c?null:true;_2b=null;}this.select(_2a,_2b,_2d);if(!_2b){this._lastSelected=_2a;}},_extendedSelectionHandler:function(_2e,_2f){if(_2e.button===2?!this.isSelected(_2f):!(_2e.keyCode?_2e.ctrlKey:_2e[_12])){this.clearSelection(null,true);}this._multipleSelectionHandler(_2e,_2f);},_toggleSelectionHandler:function(_30,_31){this.select(_31,null,null);},_initSelectionEvents:function(){var _32=this,_33=this.selectionDelegate;if(_4("touch")){on(this.contentNode,_7.selector(_33,_7.tap),function(evt){_32._handleSelect(evt,this);});}else{on(this.contentNode,on.selector(_33,this.selectionEvents),function(_34){_32._handleSelect(_34,this);});}if(this.addKeyHandler){this.addKeyHandler(32,function(_35){_32._handleSelect(_35,_35.target);});}if(this.allowSelectAll){this.on("keydown",function(_36){if(_36[_12]&&_36.keyCode==65){_36.preventDefault();_32[_32.allSelected?"clearSelection":"selectAll"]();}});}if(this._setStore){_5.after(this,"_setStore",function(){_32._updateDeselectionAspect();});}this._updateDeselectionAspect();},_updateDeselectionAspect:function(){var _37=this,_38=this.store;if(this._deselectionSignal){this._deselectionSignal.remove();}if(_38&&_38.notify){this._deselectionSignal=_5.after(_38,"notify",function(_39,_3a){var id=_3a||(_39&&_39[this.idProperty||"id"]);if(id){var row=_37.row(id),_3b=row&&_37.selection[row.id];if(_3b){_37[(_39?"":"de")+"select"](row,null,_3b);}}},true);}else{this._deselectionSignal=_5.before(this,"removeRow",function(_3c,_3d){var row;if(!_3d){row=this.row(_3c);if(row&&(row.id in this.selection)){this.deselect(row);}}});}},allowSelect:function(row){return true;},_selectionEventQueue:function(_3e,_3f){var _40=this,_41="dgrid-"+(_3e?"select":"deselect"),_42=this[_41],_43=this._selectionTriggerEvent;if(_43){_43=_43.type;}if(_42){return _42;}setTimeout(this._fireSelectionEvent=function(){if(!_42){return;}var _44={bubbles:true,grid:_40};if(_43){_44.parentType=_43;}_44[_3f]=_42;on.emit(_40.contentNode,_41,_44);_42=null;delete _40[_41];},0);return (_42=this[_41]=[]);},select:function(row,_45,_46){if(_46===undefined){_46=true;}if(!row.element){row=this.row(row);}if(_46===false||this.allowSelect(row)){var _47=this.selection;var _48=_47[row.id];if(_46===null){_46=!_48;}var _49=row.element;if(!_46&&!this.allSelected){delete this.selection[row.id];}else{_47[row.id]=_46;}if(_49){if(_46){_8(_49,".dgrid-selected.ui-state-active");}else{_8(_49,"!dgrid-selected!ui-state-active");}}if(_46!=_48&&_49){this._selectionEventQueue(_46,"rows").push(row);}if(_45){if(!_45.element){_45=this.row(_45);}var _4a=_45.element;var _4b=row.element;var _4c=(_4a&&(_4a.compareDocumentPosition?_4a.compareDocumentPosition(_4b)==2:_4a.sourceIndex>_4b.sourceIndex))?"down":"up";while(row.element!=_4a&&(row=this[_4c](row))){this.select(row,null,_46);}}}},deselect:function(row,_4d){this.select(row,_4d,false);},clearSelection:function(_4e,_4f){this.allSelected=false;for(var id in this.selection){if(_4e!==id){this.deselect(id);}}if(!_4f){this._lastSelected=null;}},selectAll:function(){this.allSelected=true;this.selection={};for(var i in this._rowIdToObject){var row=this.row(this._rowIdToObject[i]);this.select(row.id);}},isSelected:function(_50){if(typeof _50==="undefined"||_50===null){return false;}if(!_50.element){_50=this.row(_50);}return (_50.id in this.selection)?!!this.selection[_50.id]:this.allSelected&&(!_50.data||this.allowSelect(_50));},refresh:function(){if(this.deselectOnRefresh){this.clearSelection();this._fireSelectionEvent&&this._fireSelectionEvent();}this._lastSelected=null;return this.inherited(arguments);},renderArray:function(){var _51=this,_52=this.inherited(arguments);_3.when(_52,function(_53){var _54=_51.selection,i,row,_55;for(i=0;i<_53.length;i++){row=_51.row(_53[i]);_55=row.id in _54?_54[row.id]:_51.allSelected;if(_55){_51.select(row,null,_55);}}});return _52;}});});