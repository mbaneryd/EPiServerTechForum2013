//>>built
define("dgrid/editor",["dojo/_base/kernel","dojo/_base/lang","dojo/_base/array","dojo/_base/Deferred","dojo/on","dojo/aspect","dojo/has","dojo/query","./Grid","put-selector/put","dojo/_base/sniff"],function(_1,_2,_3,_4,on,_5,_6,_7,_8,_9){var _a,_b,_c;function _d(_e,_f){_e.value=_f;if(_e.type=="radio"||_e.type=="checkbox"){_e.checked=_e.defaultChecked=!!_f;}};function _10(_11,_12){if(typeof _12=="number"){_11=isNaN(_11)?_11:parseFloat(_11);}else{if(typeof _12=="boolean"){_11=_11=="true"?true:_11=="false"?false:_11;}else{if(_12 instanceof Date){var _13=new Date(_11);_11=isNaN(_13.getTime())?_11:_13;}}}return _11;};function _14(_15,cmp){if(typeof cmp.get=="function"){return _10(cmp.get("value"));}else{return _10(cmp[cmp.type=="checkbox"||cmp.type=="radio"?"checked":"value"]);}};function _16(_17,_18,_19,_1a,_1b){var _1c,row,_1d,_1e;if((_19&&_19.valueOf())!=(_1a&&_1a.valueOf())){_1c=_17.cell(_18);row=_1c.row;_1d=_1c.column;if(_1d.field&&row){_1e={grid:_17,cell:_1c,rowId:row.id,oldValue:_19,value:_1a,bubbles:true,cancelable:true};if(_1b&&_1b.type){_1e.parentType=_1b.type;}if(on.emit(_18,"dgrid-datachange",_1e)){if(_17.updateDirty){_17.updateDirty(row.id,_1d.field,_1a);_1d.autoSave&&setTimeout(function(){_17._trackError("save");},0);}else{row.data[_1d.field]=_1a;}}else{var cmp;if(cmp=_18.widget){cmp._dgridIgnoreChange=true;cmp.set("value",_19);setTimeout(function(){cmp._dgridIgnoreChange=false;},0);}else{if(cmp=_18.input){_d(cmp,_19);}}return _19;}}}return _1a;};function _1f(_20,_21,cmp,_22){var _23,id,_24;if(!cmp.isValid||cmp.isValid()){_23=_16(_20,(cmp.domNode||cmp).parentNode,_a?_b:cmp._dgridLastValue,_14(_21,cmp),_22);if(_a){_b=_23;}else{cmp._dgridLastValue=_23;}if(cmp.type==="radio"&&cmp.name&&!_21.editOn&&_21.field){_24=_20.row(cmp);_7("input[type=radio][name="+cmp.name+"]",_20.contentNode).forEach(function(_25){var row=_20.row(_25);if(_25!==cmp&&_25._dgridLastValue){_25._dgridLastValue=false;if(_20.updateDirty){_20.updateDirty(row.id,_21.field,false);}else{row.data[_21.field]=false;}}});for(id in _20.dirty){if(_24.id!==id&&_20.dirty[id][_21.field]){_20.updateDirty(id,_21.field,false);}}}}};function _26(_27){var _28=_27.editor,_29=_27.editOn,_2a=_27.grid,_2b=typeof _28!="string",_2c,cmp,_2d,_2e,_2f;_2c=_27.editorArgs||{};if(typeof _2c=="function"){_2c=_2c.call(_2a,_27);}if(_2b){cmp=new _28(_2c);_2d=cmp.focusNode||cmp.domNode;_2d.className+=" dgrid-input";cmp.connect(cmp,_29?"onBlur":"onChange",function(){if(!cmp._dgridIgnoreChange){_1f(_2a,_27,this,{type:"widget"});}});}else{_2f=function(evt){var _30=evt.target;if("_dgridLastValue" in _30&&_30.className.indexOf("dgrid-input")>-1){_1f(_2a,_27,_30,evt);}};if(!_27.grid._hasInputListener){_2a._hasInputListener=true;_2a.on("change",function(evt){_2f(evt);});}_2e=_28=="textarea"?"textarea":"input[type="+_28+"]";cmp=_2d=_9(_2e+".dgrid-input",_2.mixin({name:_27.field,tabIndex:isNaN(_27.tabIndex)?-1:_27.tabIndex},_2c));if(_6("ie")<9||(_6("ie")&&_6("quirks"))){if(_28=="radio"||_28=="checkbox"){on(cmp,"click",function(evt){_2f(evt);});}else{on(cmp,"change",function(evt){_2f(evt);});}}}on(_2d,"mousedown",function(evt){evt.stopPropagation();});return cmp;};function _31(_32,_33){var cmp=_26(_32),_34=_32.grid,_35=cmp.domNode,_36=cmp.domNode||cmp,_37=cmp.focusNode||_36,_38=_35?function(){cmp.set("value",cmp._dgridLastValue);}:function(){_d(cmp,cmp._dgridLastValue);_1f(_32.grid,_32,cmp);},_39;function _3a(){var _3b=_a;_37.blur();if(typeof _34.focus==="function"){setTimeout(function(){_34.focus(_3b);},_35&&_6("ie")<9?15:0);}};function _3c(){var _3d=_36.parentNode,i=_3d.children.length-1,_3e={alreadyHooked:true},_3f=_34.cell(_36);on.emit(_3f.element,"dgrid-editor-hide",{grid:_34,cell:_3f,column:_32,editor:cmp,bubbles:true,cancelable:false});_32._editorBlurHandle.pause();_3d.removeChild(_36);_9(_3f.element,"!dgrid-cell-editing");while(i--){_9(_3d.firstChild,"!");}_8.appendIfNode(_3d,_32.renderCell(_32.grid.row(_3d).data,_b,_3d,_c?_2.delegate(_3e,_c):_3e));_a=_b=_c=null;};function _40(evt){var key=evt.keyCode||evt.which;if(key==27){_38();_b=cmp._dgridLastValue;_3a();}else{if(key==13&&_32.dismissOnEnter!==false){_3a();}}};_39=on(_37,"keydown",_40);(_32._editorBlurHandle=on.pausable(cmp,"blur",_3c)).pause();return cmp;};function _41(cmp,_42,_43,_44){var _45=cmp.domNode,_46=_42.grid;if(!_45){_d(cmp,_44);}_43.innerHTML="";_9(_43,".dgrid-cell-editing");_9(_43,cmp.domNode||cmp);if(_45){if(!cmp._started){cmp.startup();}cmp._dgridIgnoreChange=true;cmp.set("value",_44);setTimeout(function(){cmp._dgridIgnoreChange=false;},0);}cmp._dgridLastValue=_44;if(_a){_b=_44;on.emit(_43,"dgrid-editor-show",{grid:_46,cell:_46.cell(_43),column:_42,editor:cmp,bubbles:true,cancelable:false});}};function _47(_48){var row,_49,_4a,_4b,_4c,_4d,cmp,dfd;if(!_48.column){_48=this.cell(_48);}if(!_48||!_48.element){return null;}_49=_48.column;_4c=_49.field;_4a=_48.element.contents||_48.element;if((cmp=_49.editorInstance)){if(_a!=_4a&&(!_49.canEdit||_49.canEdit(_48.row.data,_4d))){_a=_4a;row=_48.row;_4b=this.dirty&&this.dirty[row.id];_4d=(_4b&&_4c in _4b)?_4b[_4c]:_49.get?_49.get(row.data):row.data[_4c];_41(_49.editorInstance,_49,_4a,_4d);dfd=new _4();setTimeout(function(){if(cmp.focus){cmp.focus();}if(_49._editorBlurHandle){_49._editorBlurHandle.resume();}dfd.resolve(cmp);},0);return dfd.promise;}}else{if(_49.editor){cmp=_4a.widget||_4a.input;if(cmp){dfd=new _4();if(cmp.focus){cmp.focus();}dfd.resolve(cmp);return dfd.promise;}}}return null;};return function(_4e,_4f,_50){var _51=_4e.renderCell||_8.defaultRenderCell,_52=[],_53;if(!_4e){_4e={};}_4e.editor=_4f=_4f||_4e.editor||"text";_4e.editOn=_50=_50||_4e.editOn;_53=typeof _4f!="string";if(_4e.widgetArgs){_1.deprecated("column.widgetArgs","use column.editorArgs instead","dgrid 0.4");_4e.editorArgs=_4e.widgetArgs;}_5.after(_4e,"init",_50?function(){var _54=_4e.grid;if(!_54.edit){_54.edit=_47;}_4e.editorInstance=_31(_4e,_51);}:function(){var _55=_4e.grid;if(!_55.edit){_55.edit=_47;}if(_53){_52.push(_5.before(_55,"removeRow",function(_56){var _57=_55.cell(_56,_4e.id).element,_58=_57&&(_57.contents||_57).widget;if(_58){_58.destroyRecursive();}}));}});_5.after(_4e,"destroy",function(){_3.forEach(_52,function(l){l.remove();});if(_4e._editorBlurHandle){_4e._editorBlurHandle.remove();}if(_50&&_53){_4e.editorInstance.destroyRecursive();}});_4e.renderCell=_50?function(_59,_5a,_5b,_5c){if(!_5c||!_5c.alreadyHooked){on(_5b.tagName=="TD"?_5b:_5b.parentNode,_50,function(){_c=_5c;_4e.grid.edit(this);});}return _51.call(_4e,_59,_5a,_5b,_5c);}:function(_5d,_5e,_5f,_60){if(!_4e.canEdit||_4e.canEdit(_5d,_5e)){var cmp=_26(_4e);_41(cmp,_4e,_5f,_5e);_5f[_53?"widget":"input"]=cmp;}else{return _51.call(_4e,_5d,_5e,_5f,_60);}};return _4e;};});