//>>built
define("dgrid/extensions/DnD",["dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/_base/Deferred","dojo/aspect","dojo/on","dojo/topic","dojo/has","dojo/dnd/Source","dojo/dnd/Manager","dojo/_base/NodeList","put-selector/put","../Selection","dojo/has!touch?../util/touch","dojo/has!touch?./_DnD-touch-autoscroll","xstyle/css!dojo/resources/dnd.css"],function(_1,_2,_3,_4,_5,on,_6,_7,_8,_9,_a,_b,_c,_d){var _e=_1(_8,{grid:null,getObject:function(_f){var _10=this.grid;return _10.store.get(_f.id.slice(_10.id.length+5));},_legalMouseDown:function(evt){var _11=this.inherited(arguments);return _11&&evt.target!=this.grid.bodyNode;},onDrop:function(_12,_13,_14){var _15=this,_16=this._targetAnchor=this.targetAnchor,_17=this.grid,_18=_17.store;if(!this.before&&_16){_16=_16.nextSibling;}_16=_16&&_17.row(_16);_4.when(_16&&_18.get(_16.id),function(_19){if(_15!=_12){_15.onDropExternal(_12,_13,_14,_19);}else{_15.onDropInternal(_13,_14,_19);}});},onDropInternal:function(_1a,_1b,_1c){var _1d=this.grid.store,_1e=this,_1f=this.grid,_20=_1e._targetAnchor,_21;if(_20){_21=this.before?_20.previousSibling:_20.nextSibling;}if(!_1b&&(_21===_1a[0]||(!_1c&&_1f.down(_1f.row(_1a[0])).element==_1a[0]))){return;}_1a.forEach(function(_22){_4.when(_1e.getObject(_22),function(_23){_1d[_1b&&_1d.copy?"copy":"put"](_23,{before:_1c});});});},onDropExternal:function(_24,_25,_26,_27){var _28=this.grid.store,_29=_24.grid;_25.forEach(function(_2a,i){_4.when(_24.getObject(_2a),function(_2b){if(!_26){if(_29){_4.when(_29.store.getIdentity(_2b),function(id){!i&&_24.selectNone();_24.delItem(_2a.id);_29.store.remove(id);});}else{_24.deleteSelectedNodes();}}_28[_28.copy?"copy":"put"](_2b,{before:_27});});});},onDndStart:function(_2c,_2d,_2e){this.inherited(arguments);if(_2c==this){if(this.grid.cancelTouchScroll){this.grid.cancelTouchScroll();}_9.manager().avatar.node.style.width=this.grid.domNode.offsetWidth/2+"px";}},onMouseDown:function(evt){if(_7("touch")&&this.isDragging&&_d.countCurrentTouches(evt,this.grid.touchNode)>1){_6.publish("/dnd/cancel");_9.manager().stopDrag();}else{this.inherited(arguments);}},onMouseMove:function(evt){if(!_7("touch")||_d.countCurrentTouches(evt,this.grid.touchNode)===1){this.inherited(arguments);}},checkAcceptance:function(_2f,_30){return _2f.getObject&&_8.prototype.checkAcceptance.apply(this,arguments);},getSelectedNodes:function(){if(!this.grid.selection){return this.inherited(arguments);}var t=new _a(),id;for(id in this.grid.selection){t.push(this._selectedNodes[id]);}return t;}});var DnD=_1(_c,{dndSourceType:"dgrid-row",dndParams:null,dndConstructor:_e,postMixInProperties:function(){this.inherited(arguments);this.dndParams=_2.mixin({accept:[this.dndSourceType]},this.dndParams);},postCreate:function(){this.inherited(arguments);this.dndSource=new (this.dndConstructor||_e)(this.bodyNode,_2.mixin(this.dndParams,{grid:this,dropParent:this.contentNode}));var _31=this.dndSource._selectedNodes={};function _32(row){_31[row.id]=row.element;};function _33(row){delete _31[row.id];};this.on("dgrid-select",function(_34){_3.forEach(_34.rows,_32);});this.on("dgrid-deselect",function(_35){_3.forEach(_35.rows,_33);});_5.after(this,"destroy",function(){delete this.dndSource._selectedNodes;_31=null;this.dndSource.destroy();},true);},insertRow:function(_36){var row=this.inherited(arguments),_37=typeof this.getObjectDndType=="function"?this.getObjectDndType(_36):[this.dndSourceType];_b(row,".dojoDndItem");this.dndSource.setItem(row.id,{data:_36,type:_37 instanceof Array?_37:[_37]});return row;},removeRow:function(_38){this.dndSource.delItem(this.row(_38));this.inherited(arguments);}});DnD.GridSource=_e;return DnD;});