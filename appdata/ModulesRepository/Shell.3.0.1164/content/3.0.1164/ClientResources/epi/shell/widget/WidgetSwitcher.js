//>>built
define("epi/shell/widget/WidgetSwitcher",["dojo/_base/array","dojo/_base/declare","dojo/_base/Deferred","dojo/_base/lang","dojo/store/Memory","dojo/topic","dojo/when","epi/shell/_ContextMixin","epi/shell/layout/AnimatedCardContainer","epi/shell/TypeDescriptorManager"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a){return _2([_9,_8],{componentConstructorArgs:null,supportedContextTypes:null,constructor:function(_b){this.store=this.createStore();this.own(this.store);},postMixInProperties:function(){this.inherited(arguments);if(this.supportedContextTypes){if(!_4.isArray(this.supportedContextTypes)){this.supportedContextTypes=[this.supportedContextTypes];}if(!_1.every(this.supportedContextTypes,function(_c){return typeof _c=="string";})){throw new Error("supportedContextTypes must be string, array of strings or null.");}}},postCreate:function(){this.inherited(arguments);_3.when(this.getCurrentContext(),_4.hitch(this,this.contextChanged));this.own(_6.subscribe("/epi/shell/action/changeview",_4.hitch(this,"viewComponentChangeRequested")));this.own(_6.subscribe("/epi/shell/action/changeview/back",_4.hitch(this,"_viewComponentBackRequested")));},contextChanged:function(_d,_e){if(!this._isContextTypeSupported(_d)){return;}var _f=_d.customViewType||(!!_e?_e.viewType:null);var _10=this._getCurrentWidgetInfo();if(_e&&_e.contextIdSyncChange){_10&&(_f=_10.type);}if(!_f&&_d.dataType){_f=_a.getValue(_d.dataType,"mainWidgetType");}if(_f){this._getObject(_f,null,_d,_e);}else{var _11=_a.getValue(_d.dataType,"defaultView"),_12=this._getAvailableViews(_d.dataType),_13=_e?_e.viewName:null;if(_10&&_10.viewName=="view"){_1.some(_12,function(_14){if(_14.key==_10.viewName){_11="view";return true;}return false;});}var _15=this._getViewByKey(_13||_11,_12);if(!_15){throw "No default view found for "+_d.dataType;}this._loadViewComponentByConfiguration(_15,_12,null,_d,_e);}},_getViewByKey:function(key,_16){return _1.filter(_16,function(_17){return _17.key===key;})[0];},_getAvailableViews:function(_18){var _19=_a.getAndConcatenateValues(_18,"availableViews"),_1a=_a.getValue(_18,"disabledViews");var _1b=_1.filter(_19,function(_1c){return _1.every(_1a,function(_1d){return _1c.key!==_1d;});});return _1b.sort(function(x,y){return x.sortOrder<y.sortOrder?-1:1;});},_loadViewComponentByConfiguration:function(_1e,_1f,_20,_21,_22){_22=_4.mixin(_22,{viewName:_1e.key,availableViews:_1f});this._getObject(_1e.controllerType,_20,_21,_22);},viewComponentChangeRequested:function(_23,_24,_25){_7(this.getCurrentContext(),_4.hitch(this,function(_26){var _27=_26?_26.dataType:null;var _28=this._getAvailableViews(_27),_29=this._getViewByKey(_23,_28);if(_29){this._loadViewComponentByConfiguration(_29,_28,_24,_26,_25);}else{this._getObject(_23,_24,_26,_25);}}));},_viewComponentBackRequested:function(_2a){var _2b=this._getPreviousWidgetInfo();if(_2b){if(typeof _2a==="undefined"){_2a=false;}var _2c={skipUpdateView:!_2a,availableViews:_2b.availableViews,viewName:_2b.viewName};_7(this.getCurrentContext(),_4.hitch(this,function(_2d){this._getObject(_2b.type,null,_2d,_2c);}));}},_getPreviousWidgetInfo:function(){var _2e=this._getWidgetHistory();return (_2e&&_2e.length>1)?_2e[1]:null;},_getCurrentWidgetInfo:function(){var _2f=this._getWidgetHistory();return (_2f&&!!_2f.length)?_2f[0]:null;},_getWidgetHistory:function(){return this.store.query({},{count:2,sort:[{attribute:"dateAdded",descending:true}]});},_isContextTypeSupported:function(_30){if(!_30){return false;}if(!this.supportedContextTypes){return true;}return _1.some(this.supportedContextTypes,function(_31){return _30.type===_31;});},_getObject:function(_32,_33,_34,_35){if(!_32){return;}var _36=this.selectedChildWidget;var _37=_4.hitch(this,function(){_3.when(this._testComponentInstanceOf(_36,_32),_4.hitch(this,function(_38){if(_38){this._updateStore(_32,_35,_34);this._updateView(_36,_34,_35);this._onViewChanged(_32,_33,_35);}else{this._changeViewComponent(_32,_33,_34,_35);}}));});if(_36&&_36.savePendingChanges){_3.when(_36.savePendingChanges(),_37);}else{_37();}},_changeViewComponent:function(_39,_3a,_3b,_3c){_3.when(this._getChildByType(_39),_4.hitch(this,function(_3d){var _3e=this.selectedChildWidget;if(_3e){_3e.set("isActive",false);}if(_3d){_3d.set("isActive",true);if(_3c&&_3c.treatAsSecondaryView){this.selectSecondaryChild(_3d);}else{this.selectChild(_3d);}this._updateStore(_39,_3c,_3b);this._updateView(_3d,_3b,_3c,true);this._onViewChanged(_39,_3a,_3c);}else{require([_39],_4.hitch(this,function(_3f){var _40=_4.mixin(_4.mixin({},this.componentConstructorArgs),_3a);_3d=new _3f(_40);_3d.fitContainer=true;this.addChild(_3d);var _41;if(_3c&&_3c.treatAsSecondaryView){_41=this.selectSecondaryChild(_3d);}else{_41=this.selectChild(_3d);}_7(_41,_4.hitch(this,function(){this._updateStore(_39,_3c,_3b);this._updateView(_3d,_3b,_3c,true);this._onViewChanged(_39,_3a,_3c);}));}));}}));},_updateView:function(_42,_43,_44,_45){if(_42&&!!!_42._started&&typeof _42.startup==="function"){_42.startup();}if(_42&&typeof _42.updateView==="function"){_42.updateView(_44,_43,{widgetResumed:_45});}},_getChildByType:function(_46){var def=new _3();require([_46],_4.hitch(this,function(_47){var _48=_1.filter(this.getChildren(),function(_49,_4a){return _49.constructor===_47;},this);def.resolve(_48.length?_48[0]:null);}));return def;},_testComponentInstanceOf:function(_4b,_4c){var def=new _3();if(_4b){if(typeof _4c==="string"){require([_4c],function(_4d){def.resolve(_4b&&_4b.constructor===_4d);});}else{def.resolve(_4b&&_4b.constructor===_4c.constructor);}}else{def.resolve(false);}return def;},_onViewChanged:function(_4e,_4f,_50){_6.publish("/epi/shell/action/viewchanged",_4e,_4f,_50);},createStore:function(){return new _5({data:[],idProperty:"id"});},_updateStore:function(_51,_52,_53){var _54=this.store;_54.put(this.createStoreItem(_51,_52,_53),{overwrite:true});if(_54.data.length>2){var _55=_54.query({},{sort:[{attribute:"dateAdded",descending:false}]});_54.remove(_54.getIdentity(_55[0]));}},createStoreItem:function(_56,_57,_58){var _59={type:_56,dateAdded:new Date(),id:_56};if(_57){var _5a=_57.availableViews||(_58&&this._getAvailableViews(_58.dataType));var _5b=_57.viewName||this._getViewName(_5a,_58);_59=_4.mixin(_59,{availableViews:_5a,viewName:_5b});_59.id+="#"+_5b;}return _59;},_getViewName:function(_5c,_5d){if(!_5d){return null;}var _5e=this._getViewByKey(_a.getValue(_5d.dataType,"defaultView"),_5c);if(!_5e){return null;}return _5e.key;}});});