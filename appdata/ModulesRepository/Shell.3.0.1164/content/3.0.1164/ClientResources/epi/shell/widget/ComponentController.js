//>>built
define("epi/shell/widget/ComponentController",["dojo","dojo/_base/array","dojo/_base/Deferred","dojo/promise/all","dojo/when","dijit","epi","epi/dependency","epi/routes","epi/shell/ViewSettings","dijit/_Widget","dijit/layout/ContentPane","dojo/store/JsonRest","dojo/store/Memory"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e){return _1.declare(_b,{moduleArea:null,widgetFactory:null,_componentsMemoryStore:null,_componentsStore:null,_componentsSortOrderStore:null,_saveComponentRequestQueue:[],_isSaveComponentRequestInProgress:false,postMixInProperties:function(){this.inherited(arguments);this.widgetFactory=this.widgetFactory||_8.resolve("epi.shell.widget.WidgetFactory");var _f=_8.resolve("epi.storeregistry");this._componentsStore=_f.get("epi.shell.component");this._componentsSortOrderStore=_f.get("epi.shell.componentsortorder");var _10=new _e();this._componentsMemoryStore=_10;},postCreate:function(){this.inherited(arguments);_1.connect(this.widgetFactory,"onWidgetCreated",this,this.onComponentCreated);},startup:function(){this.inherited(arguments);},onComponentCreated:function(_11,_12){var cd=_1.clone(_12);cd._widgetId=_11.get("id");this._componentsMemoryStore.put(cd);},_queryComponentDefinitions:function(_13){return this._componentsMemoryStore.query(_13);},_runSaveComponentRequest:function(_14){if(_14||!this._isSaveComponentRequestInProgress){this._isSaveComponentRequestInProgress=true;var _15=this;var _16=this._saveComponentRequestQueue.shift();if(_16){this._componentsStore.put(_16.item).then(function(_17){if(_16.promise!=null){_16.promise.resolve(_17);}_15._runSaveComponentRequest(true);},function(_18){if(_16.promise!=null){_16.promise.reject(_18);}_15._runSaveComponentRequest(true);});}else{this._isSaveComponentRequestInProgress=false;}}},getComponentDefinition:function(_19){return this._queryComponentDefinitions({_widgetId:_19})[0];},getComponentDefinitionById:function(id){return this._queryComponentDefinitions({id:id})[0];},getEmptyComponentDefinition:function(_1a,_1b){_1.when(this._componentsStore.query({componentTypeName:_1a}),_1b);},getComponentsForContainer:function(_1c){var _1d=this.getComponentDefinition(_1c.id).id;return this._componentsStore.query({viewName:_a.viewName,parentId:_1d});},getComponentsForView:function(_1e,_1f){return this._componentsStore.query({viewName:_1e});},removeComponent:function(_20){var _21=this;return _5(this._componentsStore.remove(_20+"?viewName="+_a.viewName),function(){_21._componentsMemoryStore.remove(_20);});},saveComponent:function(_22){var _23=_1.clone(_22);delete _23["components"];var _24=new _3();this._saveComponentRequestQueue.push({"item":_23,"promise":_24});this._runSaveComponentRequest(false);return _24.promise;},sortComponents:function(_25,_26,_27){var _28=this.getComponentDefinition(_25.id).id;_1.when(this._componentsSortOrderStore.put({id:_28,viewName:_a.viewName,components:_26}),_27);},addComponent:function(_29,_2a,_2b,_2c){var _2d=this.getComponentDefinition(_29.id).id;var _2e=_1.clone(_2a);delete _2e["id"];_2e.parentId=_2d;_2e.viewName=_a.viewName;var _2f=this;_5(this._componentsStore.put(_2e),function(){if(_2e.settings["routeData"]){_2e.settings.routeData.gadgetId=_2e.id;}if(_2b){_5(_2f.createComponents([_2e],_29),function(def){if(def){if(typeof _2c=="function"){_2c(true,_2e);}}});}},function(){alert("Error: could not add component");if(typeof _2c=="function"){_2c(false,_2e);}});},loadComponents:function(_30){if(!_1.isArray(_30)){_30=[_30];}var _31=this;var def=new _3();_1.when(this.getComponentsForView(_a.viewName),function(_32){var _33=_31._convertListToHierarchyByMatchingParent(_32,"id","parentId","components");_5(_31.createComponents(_33,_30),function(){def.resolve();},function(e){console.error(e.stack||e);def.reject(e);});},function(){def.reject();});return def;},_convertListToHierarchyByMatchingParent:function(_34,_35,_36,_37){var map={};var _38=[];_2.forEach(_34,function(_39){var id=_39[_35];map[id]=_39;});_2.forEach(_34,function(_3a){var _3b;var id=_3a[_35];var _3c=_3a[_36];if(!(_37 in _3a)){_3a[_37]=[];}_3b=map[_3c];if(!_3b||_3b==_3a){if(_2.indexOf(_38,_3a)<0){_38.push(_3a);}}else{if(!_3b[_37]){_3b[_37]=[];}_3b[_37].push(_3a);}});return _38;},createComponents:function(_3d,_3e){var _3f=this.widgetFactory;var _40=_3d;if(_1.isArray(_40)&&_40.length>0){if(_1.isArray(_40[0])){var _41=[];for(var i=0;i<_40.length;i++){var _42=_40[i];_41.push(_3f.createWidgets(_3e[i],_42));}return _4(_41);}else{var _43=_3e;if(_1.isArray(_43)){_43=_43[0];}return _3f.createWidgets(_43,_40);}}return [];}});});