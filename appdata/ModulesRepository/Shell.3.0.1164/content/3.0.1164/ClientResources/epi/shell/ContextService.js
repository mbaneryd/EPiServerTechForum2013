//>>built
define("epi/shell/ContextService",["dojo","dojo/_base/array","dojo/_base/declare","dojo/_base/lang","dojo/DeferredList","dojo/topic","epi/dependency","epi/shell/widget/dialog/Confirmation","epi/UriParser","epi/i18n!epi/shell/ui/nls/EPiServer.Shell.UI.Resources.ContextService"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a){return _3([],{currentContext:null,_contextStore:null,_listeners:[],_profile:null,_routes:{},res:_a,_requestQueue:null,_requestInterceptors:null,constructor:function(_b,_c){this._contextStore=_b;if(_c===undefined){this._profile=_7.resolve("epi.shell.Profile");}this._requestInterceptors=[];this._requestQueue=[];this._initialize();},destroy:function(){if(this._listeners){this._listeners.forEach(function(_d){_d.remove();},this);}},_initialize:function(){this._listeners.push(_6.subscribe("/epi/shell/context/request",_4.hitch(this,this._handleContextChangeRequest)));this._listeners.push(_6.subscribe("/epi/shell/context/updateRequest",_4.hitch(this,this._handleContextUpdateRequest)));this._listeners.push(_6.subscribe("/epi/shell/context/requestcurrent",_4.hitch(this,this._handleRequestCurrentContext)));},registerRoute:function(_e,_f){this._routes[_e]=_f;},registerRequestInterceptor:function(_10){var _11=_2.indexOf(this._requestInterceptors,_10);if(_11==-1){this._requestInterceptors.push(_10);}return {remove:_4.hitch(this,function(){this.unregisterRequestInterceptor(_10);})};},unregisterRequestInterceptor:function(_12){var _13=_2.indexOf(this._requestInterceptors,_12);if(_13!=-1){this._requestInterceptors.splice(_12,1);return _12;}return null;},_handleContextChangeRequest:function(_14,_15){if(_14===null){this.currentContext={};this._publishContextChanged(this.currentContext);return;}if(this._requestInterceptors.length===0){this._loadNewContext(_14,_15,this._publishContextChanged);return;}var _16=_2.map(this._requestInterceptors,function(_17){return _17(_14,_15);},this);var _18=new _5(_16);_18.then(_4.hitch(this,function(_19){var _1a=!_2.some(_19,function(_1b){if(_1b[0]===false){return true;}});if(_1a){this._loadNewContext(_14,_15,this._publishContextChanged);}else{this._publishRequestFailed(_14,_15);}}));},_handleContextUpdateRequest:function(_1c,_1d){if(_1c===null){return;}this._loadNewContext(_1c,_1d,this._publishContextUpdated);},_handleRequestCurrentContext:function(_1e){if(this.currentContext){_6.publish("/epi/shell/context/current",this.currentContext,_1e);}},_loadNewContext:function(_1f,_20,_21){var _22={success:null,request:null,response:null,contextParameters:_1f,callerData:_20,callback:_21};var _23=_4.hitch(this,function(_24){if(_24){_22.response=_24;_22.success=true;this._handleContextLoaded();}else{_25(_24);}});var _25=_4.hitch(this,function(_26){_22.response=_26;_22.success=false;this._handleContextLoaded();});if(this._profile&&!this._profile.get("view_publicsite")){_1f.epiworkspaceactive=true;}this._requestQueue.push(_22);var _27=this._getContextStore();var rq=_27.query(_1f);rq.then(_23,_25);_22.request=rq;},_handleContextLoaded:function(){var _28=(this._requestQueue.length>0)?this._requestQueue[0]:null;while(_28&&_28.success!=null){this._requestQueue.shift();var _29=_28.callback;var _2a=_28.response;var _2b=_28.contextParameters;var _2c=_28.callerData;var _2d=_28.success;var _2e=_28.request;if(_2d){var uri=new _9(_2a.uri);_2a.type=uri.getType();_2a.id=uri.getId();this.currentContext=_28.response;if(this._routes&&this._routes[_2a.type]){this._routes[_2a.type](this.currentContext,_2c,uri);}if(_29){_29(_2a,_2c,_2e);}}else{if(_2c&&!_2c.suppressFailure){this._contextLoadFailed(_2a,_2b,_2c);}}_28=(this._requestQueue.length>0)?this._requestQueue[0]:null;}},_contextLoadFailed:function(_2f,_30,_31){var _32=_4.hitch(this,function(_33){if(_33){this._loadNewContext(_30,_31,this._publishContextChanged);}else{this._publishRequestFailed(_30,_31,_30);}});var _34=this.res.errors.couldnotloadcontext.description,_35=this.res.errors.couldnotloadcontext["descriptioncontent"+_2f.status],_36=this.res.errors.couldnotloadcontext["description"+_2f.status];if(_35&&_31.sender&&_31.sender.requestedContent){var _37=_31.sender.requestedContent;_34=_4.replace(_35,[_37.typeName,_37.name]);}else{if(_36){_34=_4.replace(_36,[_30.uri||_30.url]);}}var _38=new _8({title:this.res.errors.couldnotloadcontext.title,description:_34,confirmActionText:this.res.errors.couldnotloadcontext.retry,cancelActionText:epi.resources.action.ignore,onAction:_32,destroyOnHide:true});_38.show();},_getContextStore:function(){if(!this._contextStore){var _39=_7.resolve("epi.storeregistry");this._contextStore=_39.get("epi.shell.context");}return this._contextStore;},_publishContextChanged:function(_3a,_3b,_3c){_6.publish("/epi/shell/context/changed",_3a,_3b,_3c);},_publishContextUpdated:function(_3d,_3e,_3f){_6.publish("/epi/shell/context/updated",_3d,_3e,_3f);},_publishRequestFailed:function(_40,_41){_6.publish("/epi/shell/context/requestfailed",this.currentContext,_40,_41);}});});