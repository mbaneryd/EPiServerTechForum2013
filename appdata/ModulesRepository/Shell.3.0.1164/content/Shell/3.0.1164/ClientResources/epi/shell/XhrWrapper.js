//>>built
define("epi/shell/XhrWrapper",["dojo","dojo/_base/array","dojo/_base/connect","dojo/_base/declare","dojo/_base/lang","dojo/_base/Deferred","epi","epi/dependency","epi/shell/widget/dialog/Dialog","epi/shell/widget/LoginForm"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a){var _b;var _c=_4(null,{xhrHandler:null,_headerKeys:{validation:"X-EpiRestAntiForgeryToken",loginScreen:"X-EPiLogOnScreen",postUrl:"X-EPiLogOnScreen-PostUrl",language:"X-EPiContentLanguage"},constructor:function(_d){_4.safeMixin(this,_d);if(!this.xhrHandler){this.xhrHandler=_1.xhr;}},xhr:function(_e,_f,_10){var _11=arguments;_f.headers=_f.headers||{};if(_f.xsrfProtection){var _12=new _6();_6.when(this._getXsrfHeader(_f.url),_5.hitch(this,function(_13){_f.headers=_5.mixin({},_f.headers,_13);this._setLanguageHeader(_f.headers);_6.when(this._xhr.apply(this,_11),_12.resolve,_12.reject);}),_12.reject);return _12;}else{this._setLanguageHeader(_f.headers);return this._xhr.apply(this,_11);}},xhrDelete:function(_14){return this.xhr("DELETE",_14);},xhrGet:function(_15){return this.xhr("GET",_15);},xhrPost:function(_16){return this.xhr("POST",_16,true);},xhrPut:function(_17){return this.xhr("PUT",_17,true);},_getXsrfHeader:function(_18){if(_c.sharedXsrfHeader){return _c.sharedXsrfHeader;}var _19={url:_18,handleAs:"json",headers:{}};_19.headers[this._headerKeys.validation]="_CreateToken_";var _1a=new _6();this.xhrGet(_19).then(_5.hitch(this,function(){_1a.resolve(_c.sharedXsrfHeader);}),_1a.reject);return _1a;},_setLanguageHeader:function(_1b){if(this.preventLocalizationHeader){return;}var _1c=_8.resolve("epi.shell.Profile");var _1d=_1c.contentLanguage;if(_1d){_1b[this._headerKeys.language]=_1d;}},_xhr:function(_1e,_1f,_20){var _21=arguments;var _22=this.xhrHandler.apply(this,arguments);var _23=new _6();_23.ioArgs=_22.ioArgs;_6.when(_22,_5.hitch(this,function(_24){var _25=_22.ioArgs.xhr.getResponseHeader(this._headerKeys.validation);if(_25){if(!_c.sharedXsrfHeader){_c.sharedXsrfHeader={};}_c.sharedXsrfHeader[this._headerKeys.validation]=_25;}_23.ioArgs=_22.ioArgs;_23.resolve(_24);}),_5.hitch(this,function(err){var _26=_22.ioArgs.xhr.getResponseHeader(this._headerKeys.loginScreen);if(_26==="true"||_22.ioArgs.xhr.status=="401"){var _27={postUrl:_22.ioArgs.xhr.getResponseHeader(this._headerKeys.postUrl)};_c.sharedXsrfHeader=undefined;var _28=this._showLogin(_27);_6.when(_28,_5.hitch(this,function(){_6.when(this.xhr.apply(this,_21),_23.resolve,_23.reject);}),function(){_23.reject(err);});}else{_23.reject(err);}}));return _23;},_showLogin:function(_29){if(!_b){_b=new _6();var _2a=new _a();var _2b=new _9({title:_7.resources.action.login,confirmActionText:_7.resources.action.login,content:_2a,dialogClass:"",destroyOnHide:true,_onAfterShow:function(){}});var _2c=[];var _2d=function(_2e){_2.forEach(_2c,_3.disconnect);_2a.destroyRecursive();_2b.hide();if(_2e){_b.resolve();}else{_b.reject();}_b=null;};_2b.addValidator(_5.hitch(this,function(){var _2f=new _6();var _30=_2a.serializeForm();var _31=this.xhr("POST",{url:_29.postUrl,content:_30,xsrfProtection:false,handleAs:"json"},true);_6.when(_31,function(_32){if(_32.authenticationSuccessful){_2d(true);_2f.resolve();}else{_2a.authenticationFailed();_2f.reject();}},function(){_2d(false);_2f.reject();});return _2f;}));_2b.show();_2c.push(_3.connect(_2b,"onCancel",function(){_2d(false);}));}return _b;}});_c.sharedXsrfHeader=undefined;return _c;});