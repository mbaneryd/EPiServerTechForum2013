//>>built
define("epi/shell/widget/WidgetFactory",["dojo/_base/array","dojo/_base/Deferred","dojo/_base/declare","dojo/_base/lang","dojo/dom","dojo/promise/all","dojo/when","epi/string","epi/dependency","dijit/_Widget","dijit/_Container","dojox/layout/GridContainerLite","epi/shell/widget/ToolbarDropDownButton","epi/shell/widget/ToolbarSet"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9){return _3(null,{_domNodeName:"[domnode]",_handlers:null,moduleManager:null,messageService:undefined,onWidgetHierarchyCreated:null,onWidgetCreated:null,constructor:function(_a){_3.safeMixin(this,_a);this._handlers=[];this._addDefaultHandlers();this.messageService=this.messageService||_9.resolve("epi.shell.MessageService");this.moduleManager=this.moduleManager||_9.resolve("epi.ModuleManager");},createWidgets:function(_b,_c){if(typeof (_b)==="string"){_b=_5.byId(_b);}if(_c&&!_4.isArray(_c)){_c=[_c];}var _d=[];var _e=[];var _f=_4.hitch(this,function(_10){if(_10 instanceof Array){for(var i in _10){_f(_10[i]);}}if(_10.components instanceof Array){_f(_10.components);}if(_10.moduleName){_e.push(this.moduleManager.startModules(_10.moduleName));}if(_10.widgetPackage){_d.push(_8.slashName(_10.widgetPackage));}else{if(_10.widgetType){_d.push(_8.slashName(_10.widgetType));}}});_f(_c);var _11=new _2();var _12=require.on("error",function(_13){console.error(_13.stack||_13);_12.remove();_11.reject(_13);});_6(_e).then(_4.hitch(this,function(){require(_d,_4.hitch(this,function(){_12.remove();this._createWidgets(_b,_c).then(function(_14){try{_1.forEach(_14,function(w){if(!w._started&&w.startup){w.startup();}});_11.resolve(_14);}catch(err){_11.reject(err);}},_11.reject);}));}));return _11;},_createWidgets:function(_15,_16){var dfd=new _2();var _17=[];var _18=this.getHandler(_15);if(!_18||!_4.isArray(_16)){dfd.resolve(_17);return dfd;}var _19=_1.map(_16,_4.hitch(this,function(_1a){var _1b=new _2();var _1c=this._createInternal(_15,_1a,_18);_1c.then(function(_1d){if(_1d){_17.push(_1d);}_1b.resolve(_1d);},function(e){console.error(e.stack||e);_1b.reject(e);});return _1b;}));_6(_19).then(function(){dfd.resolve(_17);},function(_1e){console.error("WidgetFactory: Could not resolve one or more widgets");dfd.reject(_1e);});return dfd;},_createInternal:function(_1f,_20,_21){var _22=new _2();_7(_21.instantiateWidgetFunction(_20),_4.hitch(this,function(_23){if(_23){try{if(typeof this.onWidgetCreated=="function"){this.onWidgetCreated(_23,_20);}var _24=(_21.type==this._domNodeName);if(!_24){_21.addWidgetToRootFunction(_1f,_23);}}catch(e){_22.reject(e);return;}var _25=new _2();if(_20.components&&_4.isArray(_20.components)&&_20.components.length>0){_25=this._createWidgets(_23,_20.components);}else{_25.resolve();}_25.then(_4.hitch(this,function(){try{if(_24){_21.addWidgetToRootFunction(_1f,_23);}if(typeof this.onWidgetHierarchyCreated=="function"){this.onWidgetHierarchyCreated(_23,_20);}_22.resolve(_23);}catch(e){_22.reject(e);}}),_22.reject);}else{_22.reject();}}),function(_26){console.error(_26.stack||_26);_22.reject(_26);});return _22;},defaultWidgetInstantiator:function(_27){var def=new _2();var _28=_4.mixin({},_27.settings,{componentId:_27.id});var _29=_8.slashName(_27.widgetType);var _2a=_27.widgetPackage&&_4.getObject(_27.widgetType);var _2b=require.on("error",function(_2c){console.error(_2c.stack||_2c);_2b.remove();def.reject(_2c);});function _2d(_2e){var _2f=new _2e(_28);if(_27.connections){for(var evt in _27.connections){if(_27.connections[evt]){_2f.connect(_2f,evt,_27.connections[evt]);}}}_2b.remove();def.resolve(_2f);};if(_2a){_2d(_2a);}else{require([_29],_4.hitch(this,_2d));}return def;},_notifyError:function(msg){if(this.messageService){this.messageService.put("error",msg);}},_addDefaultHandlers:function(){this.addHandler(this._domNodeName,function(_30,_31){_31.placeAt(_30);},null,function(){return true;});this.addHandler("dijit/_Widget",function(_32,_33){_32.set("content",_33);});this.addHandler("dijit/_Container",function(_34,_35){_34.addChild(_35);});this.addHandler("dojox/layout/GridContainerLite",function(_36,_37){_36.addChild(_37,_37.params.column);});this.addHandler("epi/shell/widget/ToolbarDropDownButton",function(_38,_39){_38.addChild(_39);});this.addHandler("epi/shell/widget/ToolbarSet",function(_3a,_3b){_3a.addChild(_3b);});},addHandler:function(_3c,_3d,_3e,_3f){var _40=function(_41,_42){return _42&&_4.isFunction(_41.isInstanceOf)&&_41.isInstanceOf(_42);};var _43=_4.hitch(this,function(_44){var _45=this.getHandlerByTypeName(_3c);var _46=_3f||_40;var _47=_45?true:false;if(!_47){_45={};}var _48=_3e||_4.hitch(this,this.defaultWidgetInstantiator);_45.type=_3c;_45.instantiateWidgetFunction=_48;_45.addWidgetToRootFunction=_3d;_45.widgetConstructor=_44;_45.canHandle=_46;if(!_47){this._handlers.push(_45);}});if(_3c!=this._domNodeName){require([_8.slashName(_3c)],_43);}else{_43();}},getHandler:function(_49){var _4a=this._handlers;for(var i=_4a.length-1;i>=0;i--){if(_4a[i].canHandle(_49,_4a[i].widgetConstructor)){return _4a[i];}}return null;},getHandlerByTypeName:function(_4b){var _4c=this._handlers;for(var i=0;i<_4c.length;i++){if(_4c[i].type===_4b){return _4c[i];}}return null;},removeHandler:function(_4d){var _4e=this._handlers;for(var i=0;i<_4e.length;i++){if(_4e[i].type===_4d){_4e.splice(i,1);}}},listHandlers:function(){var _4f=this._handlers;return _1.map(_4f,function(_50){return _50.type;});}});});