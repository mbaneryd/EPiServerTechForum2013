//>>built
define("dgrid/_StoreMixin",["dojo/_base/kernel","dojo/_base/declare","dojo/_base/lang","dojo/_base/Deferred","dojo/on","dojo/aspect","put-selector/put"],function(_1,_2,_3,_4,_5,_6,_7){function _8(_9){return _9;};function _a(_b){if(typeof _b!=="object"){_b=new Error(_b);}else{if(_b.dojoType==="cancel"){return;}}_b.grid=this;if(_5.emit(this.domNode,"dgrid-error",{grid:this,error:_b,cancelable:true,bubbles:true})){console.error(_b);}};return _2(null,{store:null,query:null,queryOptions:null,getBeforePut:true,noDataMessage:"",loadingMessage:"",constructor:function(){this.query={};this.queryOptions={};this.dirty={};this._updating={};this._columnsWithSet={};_6.before(this,"configStructure",_3.hitch(this,function(){this._columnsWithSet={};}));},postCreate:function(){this.inherited(arguments);if(this.store){this._updateNotifyHandle(this.store);}},destroy:function(){this.inherited(arguments);if(this._notifyHandle){this._notifyHandle.remove();}},_configColumn:function(_c){if(_c.set){this._columnsWithSet[_c.field]=_c;}},_updateNotifyHandle:function(_d){if(this._notifyHandle){this._notifyHandle.remove();delete this._notifyHandle;}if(_d&&typeof _d.notify==="function"){this._notifyHandle=_6.after(_d,"notify",_3.hitch(this,"_onNotify"),true);}},_setStore:function(_e,_f,_10){this._updateNotifyHandle(_e);this.store=_e;this.dirty={};this.set("query",_f,_10);},_setQuery:function(_11,_12){var _13=_12&&_12.sort;this.query=_11!==undefined?_11:this.query;this.queryOptions=_12||this.queryOptions;_13?this.set("sort",_13):this.refresh();},setStore:function(_14,_15,_16){_1.deprecated("setStore(...)","use set(\"store\", ...) instead","dgrid 0.4");this.set("store",_14,_15,_16);},setQuery:function(_17,_18){_1.deprecated("setQuery(...)","use set(\"query\", ...) instead","dgrid 0.4");this.set("query",_17,_18);},_getQueryOptions:function(){var _19=_3.delegate(this.queryOptions,{});if(this._sort.length){_19.sort=this._sort;}return _19;},_getQuery:function(){var q=this.query;return typeof q=="object"&&q!=null?_3.delegate(q,{}):q;},_setSort:function(_1a,_1b){if(this.store){this._lastCollection=null;}this.inherited(arguments);},_onNotify:function(_1c,_1d){this.inherited(arguments);if(_1c&&this._numObservers<1){this.refresh({keepScrollPosition:true});}},insertRow:function(_1e,_1f,_20,i,_21){var _22=this.store,_23=this.dirty,id=_22&&_22.getIdentity(_1e),_24;if(id in _23&&!(id in this._updating)){_24=_23[id];}if(_24){_1e=_3.delegate(_1e,_24);}return this.inherited(arguments);},updateDirty:function(id,_25,_26){var _27=this.dirty,_28=_27[id];if(!_28){_28=_27[id]={};}_28[_25]=_26;},setDirty:function(id,_29,_2a){_1.deprecated("setDirty(...)","use updateDirty() instead","dgrid 0.4");this.updateDirty(id,_29,_2a);},save:function(){var _2b=this,_2c=this.store,_2d=this.dirty,dfd=new _4(),_2e=dfd.promise,_2f=function(id){var _30;return (_2b.getBeforePut||!(_30=_2b.row(id).data))?function(){return _2c.get(id);}:function(){return _30;};};function _31(id,_32){return function(_33){var _34=_2b._columnsWithSet,_35=_2b._updating,key,_36;if(typeof _33.set==="function"){_33.set(_32);}else{for(key in _32){_33[key]=_32[key];}}for(key in _34){_36=_34[key].set(_33);if(_36!==undefined){_33[key]=_36;}}_35[id]=true;return _4.when(_2c.put(_33),function(){delete _2d[id];delete _35[id];});};};for(var id in _2d){var put=_31(id,_2d[id]);_2e=_2e.then(_2f(id)).then(put);}dfd.resolve();return _2e;},revert:function(){this.dirty={};this.refresh();},_trackError:function(_37){var _38;if(typeof _37=="string"){_37=_3.hitch(this,_37);}try{_38=_37();}catch(err){_a.call(this,err);}return _4.when(_38,_8,_3.hitch(this,_a));},newRow:function(){var row=this.inherited(arguments);if(this.noDataNode){_7(this.noDataNode,"!");delete this.noDataNode;}return row;},removeRow:function(_39,_3a){var row={element:_39};if(!_3a&&this.noDataMessage&&(this.up(row).element===_39)&&(this.down(row).element===_39)){this.noDataNode=_7(this.contentNode,"div.dgrid-no-data");this.noDataNode.innerHTML=this.noDataMessage;}return this.inherited(arguments);}});});