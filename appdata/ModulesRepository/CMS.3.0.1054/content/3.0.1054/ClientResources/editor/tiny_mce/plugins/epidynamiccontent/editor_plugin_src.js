(function(tinymce,$){tinymce.dom.Event,tinymce.PluginManager.requireLangPack("epidynamiccontent"),tinymce.create("tinymce.plugins.epidynamiccontent",{_onInitCalled:!1,init:function(ed,url){var self=this;if("undefined"!=typeof EPi&&"function"==typeof EPi.ResolveUrlFromUI){if("undefined"==typeof epiContentBlockUtilities){var scriptUrl=tinymce.baseURI.toAbsolute("plugins/epipersonalizedcontent/epicontentblockutilities.js");tinymce.ScriptLoader.load(scriptUrl,function(){this._init(ed,url)},this),tinymce.ScriptLoader.loadQueue()}else this._init(ed,url);ed.addButton("epidynamiccontent",{title:"epidynamiccontent.desc",cmd:"mceEPiDynamicContent"}),ed.onInit.add(function(){self._onInitCalled=!0}),ed.onPreInit.addToTop(function(){var mceNonEditableClass=tinymce.trim(ed.getParam("noneditable_noneditable_class","mceNonEditable"));ed.parser.addAttributeFilter("class",function(nodes){for(var i=nodes.length;i--;)self._convertDCToMceNonEditable(nodes[i],mceNonEditableClass)})})}},_init:function(ed,url){$.extend(this,epiContentBlockUtilities);var dynamicContentClass,self=this;self._url=url,self.ed=ed,self._disabled=!1,dynamicContentClass=self._dynamicContentClass=ed.getParam("epidynamiccontent_cssclass","epi_dc"),self._enabledControls=ed.getParam("epidynamiccontent_enabledcontrols",""),ed.addCommand("mceEPiDynamicContent",function(){var ctx=$.extend({},ed.settings.epi_page_context);$(document).trigger("epi.loading.page_context",ctx);var dialogURL=EPi.ResolveUrlFromUI("Editor/Dialogs/DynamicContent.aspx")+"?"+$.param(ctx),selectedNode=null,onDialogComplete=function(returnData){var selection=ed.selection;if(!returnData)return ed.windowManager.onClose.dispatch(),void 0;selectedNode&&selection.select(selectedNode),ed.getWin().focus();var dynamicContent=self._getParentContentBlock(selection.getNode());dynamicContent&&ed.dom.remove(dynamicContent),ed.execCommand("mceInsertContent",!1,returnData),self._onContentChanged(),ed.windowManager.onClose.dispatch()},selection=ed.selection;selectedNode=self._getParentContentBlock(selection.getStart());var dialogFeatures={width:600,height:640},allContentGroups=self._getAllContentGroups(ed);if(selectedNode){var systemCSS=EPi.ResolveUrlFromUtil("../App_Themes/Default/Styles/system.css"),groupAttribute=selectedNode.getAttribute("data-groups"),groupValue=groupAttribute?groupAttribute.replace(/"/g,"&quot;"):"",contentgroupAttribute=selectedNode.getAttribute("data-contentgroup"),contentgroupValue=contentgroupAttribute?contentgroupAttribute.replace(/"/g,"&quot;"):"",formString='<html xmlns="http://www.w3.org/1999/xhtml"><head><link href="'+systemCSS+'" type="text/css" rel="stylesheet" /><title></title></head><body>'+'<form action="'+dialogURL+'" method="post">'+'<input name="state" type="hidden" value="'+selectedNode.getAttribute("data-state").replace(/"/g,"&quot;")+'" />'+'<input name="hash" type="hidden" value="'+selectedNode.getAttribute("data-hash").replace(/"/g,"&quot;")+'" />'+'<input name="dynamicclass" type="hidden" value="'+selectedNode.getAttribute("data-dynamicclass").replace(/"/g,"&quot;")+'" />'+'<input name="groups" type="hidden" value="'+groupValue+'" />'+'<input name="contentgroup" type="hidden" value="'+contentgroupValue+'" />'+'<input name="allcontentgroups" type="hidden" value="'+allContentGroups+'" />'+"</form></body></html>",onOpenLegacyDialog=function(epiLegacyDialog){if(epiLegacyDialog){var wrapper=epiLegacyDialog.wrapper,content=wrapper.containerIframe.contentWindow;content.document.write(formString),content.document.close(),content.document.forms[0].submit()}};ed.windowManager.open({url:"",width:dialogFeatures.width,height:dialogFeatures.height,onCallback:onDialogComplete,onReady:onOpenLegacyDialog})}else dialogURL+="&allcontentgroups="+allContentGroups,ed.windowManager.open({url:dialogURL,width:dialogFeatures.width,height:dialogFeatures.height,onCallback:onDialogComplete})});var pluginInit=function(ed){var DOM=tinymce.DOM,Event=tinymce.dom.Event;Event.add(DOM.doc,"mousedown",self._handleButtonsClick,self),$(ed.dom.doc).click(function(e){self._handleButtonsClick(e)}),ed.onNodeChange.add(function(ed,controlManager,currentNode,isSelectionCollapsed){var selection=ed.selection,dynamicContent=null;dynamicContent=selection.isCollapsed()?self._getParentContentBlock(selection.getNode()):self._getParentContentBlock(selection.getStart())||self._getParentContentBlock(selection.getEnd()),dynamicContent?(self._updateCommandState(!1),self._showButton(ed,controlManager,!0,!0)):(self._updateCommandState(!0),self._showButton(ed,controlManager,isSelectionCollapsed,!1))})};self._onInitCalled?pluginInit(ed):ed.onInit.add(pluginInit)},_showButton:function(ed,controlManager,enabled,active){var isHidden=ed.dom.isHidden(ed.container);controlManager.setDisabled("epidynamiccontent",isHidden||!enabled),controlManager.setActive("epidynamiccontent",!isHidden&&active)},_handleButtonsClick:function(e){return this.ed.dom.hasClass(e.target,"epi_dc_editBtn")&&0===e.button?(this._hidePreview(e),tinyMCE.execCommand("mceEPiDynamicContent"),tinymce.dom.Event.cancel(e)):$(e.target).is(".epi_dc_previewBtn")&&0===e.button?(this._showPreview(e),tinymce.dom.Event.cancel(e)):(this._hidePreview(e),void 0)},_getParentContentBlock:function(node){return this._getParentNode(node,this._dynamicContentClass)},_convertDCToMceNonEditable:function(node,mceNonEditableClass){var nodeClass=node.attr("class")+" ";-1===nodeClass.indexOf("epi_dc ")||nodeClass.indexOf(mceNonEditableClass)>=0||(node.attr("contenteditable",null),node.attr("class",nodeClass+mceNonEditableClass))},_url:null,_previewedDynamicContent:null,_previewVisible:!1,_lastSelection:null,_showPreview:function(evt){var node=evt.target;this._hidePreview(evt)&&$(window["epi-dcPreview"].document.documentElement).remove();var dynamicContent=$("<div/>",this.ed.contentDocument).append($(node).closest(".epi_dc").clone()),dynamicContentHtml=$(dynamicContent).html();this._previewedDynamicContent=dynamicContentHtml;var self=this;setTimeout(function(){if(dynamicContentHtml!==self._previewedDynamicContent)return $(dynamicContent).remove(),void 0;self._previewVisible=!0,self._lastSelection=node;var iframe=$("iframe",self.ed.container),popupPosition=self._getPositionInParentFrame(node,self.ed.contentWindow,iframe,window),dialogWidth=self.ed.settings.editorwidth?self.ed.settings.editorwidth:self.ed.settings.width,frame=self._createPopupIframe(popupPosition,"epi-dcPreview",dialogWidth,[{onclick:function(){self._openEditDialog(self.ed),self._hidePreview()},text:self.ed.translate("epidynamiccontent.edit")},{onclick:function(){self._hidePreview()},text:self.ed.translate("epidynamiccontent.close")}]),previewUrl=self._getPreviewUrl(),previewData={DynamicContent:dynamicContentHtml};self._postFrameTo(frame,previewUrl,previewData),$(dynamicContent).remove(),$(window).bind("resize.dynamicContent",function(){var position=self._getPositionInParentFrame(node,self.ed.contentWindow,iframe,window),previewBorder=$("#epi-dcPreview");previewBorder.css(position)})},250)},_getPreviewUrl:function(){var url="Editor/Dialogs/DynamicContentPreview.aspx",ctx=jQuery.extend({content_css:this.ed.settings.content_css},this.ed.settings.epi_page_context);return $(document).trigger("epi.loading.page_context",ctx),EPi.ResolveUrlFromUI(url+"?"+jQuery.param(ctx))},_openEditDialog:function(){this.ed.focus();var dynamicContent=this._getParentContentBlock(this._lastSelection);this.ed.selection.select(dynamicContent),tinyMCE.execCommand("mceEPiDynamicContent")},_hidePreview:function(evt){return this._previewedDynamicContent=null,evt&&this._isChildOfDCPreview(evt.target)||!this._previewVisible?!1:(this._previewVisible=!1,this._lastSelection=null,$("#epi-dcPreview").hide(),$(window).unbind("resize.dynamicContent"),!0)},_getPositionInParentFrame:function(element,childWindow,childIframe,parentWindow){var framePosition=$(childIframe).offset(),dcPosition=$(element).position(),windowScroll={y:$(parentWindow).scrollTop(),x:$(parentWindow).scrollLeft()},frameScroll={y:Math.max($(childWindow.document.body).scrollTop(),$(childWindow.document.documentElement).scrollTop()),x:$(childWindow.document.body).scrollLeft()},position={top:framePosition.top+dcPosition.top-windowScroll.y-frameScroll.y,left:framePosition.left+dcPosition.left+Math.min($(element).width()+10,$(childIframe).width())-windowScroll.x-frameScroll.x};windowScroll.y>0&&(tinymce.isGecko||tinymce.isWebKit)&&(position.top+=frameScroll.y),tinymce.isIE&&(position.top+=windowScroll.y);var $parentWindow=$(parentWindow),lowerBound=position.top+300,windowBottomY=windowScroll.y+$parentWindow.height();lowerBound>windowBottomY&&(position.top=Math.max(windowScroll.y,position.top-lowerBound+windowBottomY));var dialogWidth=this.ed.settings.editorwidth?this.ed.settings.editorwidth:this.ed.settings.width;lowerBound=position.left+parseInt(dialogWidth,10)+24;var windowRightX=windowScroll.x+$parentWindow.width();return lowerBound>windowRightX&&(position.left=Math.max(windowScroll.x,position.left-lowerBound+windowRightX)),position},_createPopupIframe:function(popupPosition,frameName,width,buttons){var self=this,previewBorder=$("#"+frameName).show();if(0===previewBorder.length&&(previewBorder=$("<div id='"+frameName+"' class='epi-dcPreviewBorder'><iframe frameborder='0' style='height:300px;' class='episystemiframe' name='"+frameName+"' src=''></iframe><div id='epi-dcPreviewButtons'></div><div id='epi-dcPreviewDescription'></div></div>").appendTo(window.document.body),$(window.document.body).click(function(evt){self._hidePreview(evt)})),previewBorder.css({position:"absolute",top:popupPosition.top,left:popupPosition.left,width:width}).children("iframe").css({height:"250px",width:"100%"}),buttons){$("#epi-dcPreviewButtons").html("");for(var i in buttons)$("<span class='epi-cmsButton'><input type='button' value='"+buttons[i].text+"'/></span>").appendTo("#epi-dcPreviewButtons").click(buttons[i].onclick)}var frame=window[frameName];return frame},_isChildOfDCPreview:function(target){var targetObject=$(target),dcPreviewContainerClass=".epi-dcPreviewBorder";return targetObject.is(dcPreviewContainerClass)||targetObject.parents().is(dcPreviewContainerClass)},_postFrameTo:function(frame,url,data){var formString='<html xmlns="http://www.w3.org/1999/xhtml" style="height:100%;background:#fff url('+EPi.ResolveUrlFromUtil("../App_Themes/Default/Images/General/AjaxLoader.gif")+') no-repeat 50% 50%"><head><title></title></head><body>';formString+='<form action="'+url+'" method="post">';var key;for(key in data)formString+='<input name="'+key+'" id="'+key+'" type="hidden" />';formString+="</form></body></html>",frame.document.write(formString);for(key in data)frame.document.getElementById(key).value=data[key];frame.document.forms[0].submit()},getInfo:function(){return{longname:"Dynamic content plugin",author:"EPiServer AB",authorurl:"http://www.episerver.com",infourl:"http://www.episerver.com",version:1.1}}}),tinymce.PluginManager.add("epidynamiccontent",tinymce.plugins.epidynamiccontent)})(tinymce,epiJQuery);