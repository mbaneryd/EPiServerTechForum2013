//>>built
define("epi-cms/component/MediaViewModel",["dojo/_base/array","dojo/_base/declare","dojo/_base/lang","dojo/dom-class","dojo/when","epi/shell/widget/dialog/Dialog","epi-cms/core/ContentReference","epi-cms/widget/ContextualContentForestStoreModel","epi-cms/widget/viewmodel/HierarchicalListViewModel","epi-cms/widget/viewmodel/MultipleFileUploadViewModel","epi-cms/widget/MultipleFileUpload","epi-cms/widget/UploadUtil","epi-cms/command/UploadContent","epi-cms/command/EditImage","epi-cms/command/DownloadMedia","epi/i18n!epi/cms/nls/episerver.cms.components.media"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e,_f,_10){return _2([_9],{treeStoreModelClass:_8,_dialog:null,_getTypesToCreate:function(){return [];},_setupCommands:function(){this.inherited(arguments);var _11={selection:this.selection,model:this};var _12={uploadDefault:{command:new _d(_3.mixin({iconClass:"epi-iconPlus",label:_10.command.label,resources:_10,viewModel:this},_11))},upload:{command:new _d(_3.mixin({category:"context",iconClass:"epi-iconUpload",label:_10.linktocreateitem,viewModel:this},_11)),isAvailable:this.menuType.ROOT|this.menuType.TREE,order:2},editImage:{command:new _e(_3.mixin({category:"context",forceContextChange:true,label:_10.command.openineditor},_11)),isAvailable:this.menuType.LIST,order:3},download:{command:new _f(_3.mixin({category:"context",label:_10.command.download},_11)),isAvailable:this.menuType.LIST,order:4}};this._commandRegistry=_3.mixin(this._commandRegistry,_12);this.pseudoContextualCommands.push(this._commandRegistry.uploadDefault.command);this.pseudoContextualCommands.push(this._commandRegistry.upload.command);},_updateTreeContextCommandModels:function(_13){this.inherited(arguments);this._commandRegistry.uploadDefault.command.set("model",_13);this._commandRegistry.upload.command.set("model",_13);},upload:function(_14,_15,_16){var _17=new _b({model:new _a({store:this.get("store"),query:this.get("listQuery")})});_17.on("beforeUploaderChange",_3.hitch(this,function(){this._uploading=true;}));_17.on("close",_3.hitch(this,function(_18){this._dialog&&(_18?this._dialog.hide():this._dialog.destroy());}));_17.on("uploadComplete",_3.hitch(this,function(_19){if(_17.createAsLocalAsset){_5(this.treeStoreModel&&typeof this.treeStoreModel.refreshRoots==="function"&&this.treeStoreModel.refreshRoots(this),_3.hitch(this,function(){_17.set("createAsLocalAsset",false);_17.set("uploadDirectory",this.get("currentTreeItem").id);_17.model.set("query",this.get("listQuery"));}));}else{this.onListItemUpdated(_19);this.set("currentTreeItem",this.get("currentTreeItem"));}if(this._dialog&&!this._dialog.open){this._dialog.destroy();}this._uploading=false;}));this._dialog=new _6({title:_10.linktocreateitem,content:_17,autofocus:_c.supportNativeDndFiles(),defaultActionsVisible:false,closeIconVisible:false});_4.add(this._dialog.domNode,"epi-multiFileUploadDialog");this._dialog.definitionConsumer.add({name:"close",label:"Close",action:function(){_17.close();}});this._dialog.resize({w:700});this._dialog.show();var _1a=_16?this.selection.data[0].data:this.store.get(_15);_5(_1a,_3.hitch(this,function(_1b){this._buildBreadcrumb(_1b,_17);_17.set("uploadDirectory",_15||this.get("currentTreeItem").id);_17.set("createAsLocalAsset",_16);_17.upload(_14);}));},onListItemUpdated:function(_1c){var _1d=this.store;return _5(this.getCurrentContext(),function(_1e){var _1f=(new _7(_1e.id)).createVersionUnspecificReference().toString();return _5(_1d.get(_1f),function(_20){var _21=_1.filter(_1c,function(_22){return _20.name.toLowerCase()===_22.fileName.toLowerCase();})[0];return _21?_20:null;});});},_buildBreadcrumb:function(_23,_24){if(!_24){return;}if(this.treeStoreModel.isTypeOfRoot(_23)){_24.set("breadcrumb",[_23]);return;}this.treeStoreModel.getAncestors(_23.contentLink,_3.hitch(this,function(_25){var _26,_27=[_23];for(var i=_25.length-1;i>=0;i--){_26=_25[i];_27.unshift(_26);if(this.treeStoreModel.isTypeOfRoot(_26)){break;}}_24.set("breadcrumb",_27);}));}});});