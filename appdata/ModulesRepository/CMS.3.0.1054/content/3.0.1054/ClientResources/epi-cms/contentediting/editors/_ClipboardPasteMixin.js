//>>built
define("epi-cms/contentediting/editors/_ClipboardPasteMixin",["dojo/_base/array","dojo/_base/declare","dojo/_base/event","dojo/_base/lang","dojo/dom-attr","dojo/dom-class","dojo/dom-construct","dojo/on","dojo/query","dojo/sniff","dijit/Destroyable","epi/string"],function(_1,_2,_3,_4,_5,_6,_7,on,_8,_9,_a,_b){return _2(_a,{_editingKey:"",_editingNode:null,_editingContainer:null,_beginEditingPoint:null,_endEditingPoint:null,_pasteEventActive:false,_editingCSSClass:"epi-content-editable-container",_beginEditingPointCSSClass:"epi-content-editable-begin-edit",_endEditingPointCSSClass:"epi-content-editable-end-edit",_endSuffix:"###epiendtext",canAccessClipboard:function(_c){return !!this.getClipboard(_c);},getClipboard:function(_d){return (_d&&_d.clipboardData)||window.clipboardData;},getClipboardData:function(_e){var _f=this.getClipboard(_e);return (_f&&_9("ie"))?_f.getData("Text"):_f.getData("text/plain");},destroy:function(){this.inherited(arguments);this._destroyRedundantNodes([this._beginEditingPoint||this._getEditingPoint("before"),this._endEditingPoint||this._getEditingPoint("after")]);this._editingNode=this._editingContainer=this._beginEditingPoint=this._endEditingPoint=null;},pasteMixinSetup:function(_10,_11){if(!_11){return;}this._editingKey=_10;this._editingNode=_11;this._editingContainer=this._editingNode.parentNode;this.own(on(this._editingNode,"beforepaste",_4.hitch(this,this._onBeforePaste)),on(this._editingNode,"paste",_4.hitch(this,this._onPaste)),on(this._editingNode,"input",_4.hitch(this,this._onInput)));},_onBeforePaste:function(evt){if(this.canAccessClipboard(evt)&&_9("ie")){this.getClipboard(evt).setData("Text",_b.stripHtmlTags(this.getClipboardData(evt)));}},_onPaste:function(evt){if(_9("ie")){return;}if(this.canAccessClipboard(evt)){this._processNativePaste(evt);_3.stop(evt);return;}this._setupManualPaste();},_onInput:function(evt){if(this.canAccessClipboard(evt)||!this._pasteEventActive){return;}this._processManualPaste();},_setupManualPaste:function(){this._pasteEventActive=true;this._preparePastePosition();this._setupEditingPoints();},_processNativePaste:function(evt){var _12=this._editingNode.ownerDocument,_13=_b.stripHtmlTags(this.getClipboardData(evt));if(!_b.isNullOrEmpty(_13)){_12.execCommand("insertText",false,_13);}},_processManualPaste:function(){this._pasteEventActive=false;_6.add(this._editingNode,this._editingCSSClass);var _14=this._getRenderedNodes();if(_14 instanceof Array&&_14.length>0){_14.length===1?this._processPasteNormalContent():this._processPasteAbnormalContent(_14);this._destroyRedundantNodes(this._getRedundantNodes(_14));}},_processPasteNormalContent:function(){this._editingNode.textContent=this._editingNode.textContent;this._setCaretPosition(this._editingNode,this._startAt);var _15=_b.isNullOrEmpty(this._contentEnd)?this._editingNode.textContent.length:this._editingNode.textContent.indexOf(_4.trim(this._contentEnd));var _16=this._editingNode.textContent,_17=_16.substring(0,this._startAt),_18=_16.substring(this._startAt,_15),_19=_b.stripHtmlTags(_18);this._editingNode.textContent=_17+_19+this._contentEnd.substring(0,this._contentEnd.length-this._endSuffix.length);this._setCaretPosition(this._editingNode,(_17+_19).length);},_processPasteAbnormalContent:function(_1a){var _1b=_1a.map(function(_1c){if(_5.get(_1c,"contenteditable")==="true"&&_6.contains(_1c,"epi-editContainer")){return _1c.textContent;}return _b.stripHtmlTags(_1c.innerText||_1c.textContent);}).join("");this._editingNode.textContent=_1b.substring(0,_1b.length-this._endSuffix.length);},_setCaretPosition:function(_1d,_1e){var _1f=_1d.ownerDocument,_20=_1f.createRange(),_21=_1f.getSelection();_1d.firstChild&&_20.setStart(_1d.firstChild,_1e);_20.collapse(true);_21.removeAllRanges();_21.addRange(_20);},_preparePastePosition:function(){var _22=this._editingNode.ownerDocument.getSelection(),_23=_22.toString(),_24=this._editingNode.textContent;_22.deleteFromDocument();_22.collapseToStart();if(_22.anchorNode.nodeType!==document.TEXT_NODE){this._editingNode.textContent&&this._setCaretPosition(this._editingNode,_24.length);_22=this._editingNode.ownerDocument.getSelection();}this._startAt=_22.anchorOffset;this._editingNode.textContent=_24=this._editingNode.textContent+this._endSuffix;this._setCaretPosition(this._editingNode,this._startAt);this._contentEnd=this._editingNode.textContent.substring(this._startAt,_24.length);},_getRenderedNodes:function(){var _25=_8("span."+this._getEditingPointClass("before"),this._editingContainer).nextAll(),_26=null,_27=[];_25.some(function(_28){if(_28===this._endEditingPoint){return true;}_27.push(_28);},this);return _27;},_getRedundantNodes:function(_29){var _2a=_29.filter(function(_2b){return !_6.contains(_2b,this._editingCSSClass);},this);var _2c=_29.filter(function(_2d){return _6.contains(_2d,this._editingCSSClass);},this);if(_2c.length>1){_2c.pop();_2a=_2a.concat(_2c);}return _2a;},_setupEditingPoints:function(){this._beginEditingPoint=this._getEditingPoint("before")||this._createEditingPoint("before");this._endEditingPoint=this._getEditingPoint("after")||this._createEditingPoint("after");},_getEditingPoint:function(_2e){return _8("span."+this._getEditingPointClass(_2e),this._editingContainer)[0];},_getEditingPointClass:function(_2f){var _30=(_2f==="before"?this._beginEditingPointCSSClass:this._endEditingPointCSSClass);if(!_b.isNullOrEmpty(this._editingKey)){_30+="-"+this._editingKey;}return _30;},_createEditingPoint:function(_31){var _32=_7.create("span",{"class":this._getEditingPointClass(_31),"style":"display:none;position:absolute;left:-99em;"},this._editingNode,_31==="before"?"before":"after");return _32;},_destroyRedundantNodes:function(_33){if(_33 instanceof Array&&_33.length>0){_33.forEach(_7.destroy);}}});});