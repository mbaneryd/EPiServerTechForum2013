//>>built
define("epi-cms/contentediting/EditingBase",["dojo/_base/array","dojo/_base/connect","dojo/_base/declare","dojo/_base/Deferred","dojo/_base/event","dojo/_base/json","dojo/_base/lang","dojo/date/stamp","dojo/dom-attr","dojo/on","dojo/query","dojo/topic","dojo/when","dijit/_Widget","epi/dependency","epi/datetime","epi/string","epi/Url","epi/shell/DestroyableByKey","epi-cms/contentediting/_View","epi-cms/contentediting/AutoSaveButton","epi-cms/contentediting/MappingManager","epi-cms/contentediting/RenderManager","epi-cms/contentediting/UpdateController","epi-cms/widget/overlay/overlayFactory","epi/i18n!epi/cms/nls/episerver.cms.contentediting"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,on,_a,_b,_c,_d,_e,_f,_10,Url,_11,_12,_13,_14,_15,_16,_17,res){return _3([_12,_11],{toolbar:null,editorFactory:null,syncInterval:10000,activePropertyOnStartup:null,createOverlays:true,_renderManager:null,_mappingManager:null,_activeEditorWrapper:null,_autoSaveButton:null,_reloadRequiredProperty:null,_eventHandlers:null,constructor:function(){this.defaultQueryParameters={epieditmode:true};},postMixInProperties:function(){this.inherited(arguments);this.editorFactory=this.editorFactory||_e.resolve("epi.cms.contentediting.EditorFactory");this._mappingManager=new _14();this._eventHandlers=[];},postCreate:function(){this.inherited(arguments);if(this.syncInterval>0){this._syncIntervalId=window.setInterval(_7.hitch(this,"_save"),this.syncInterval);}this.subscribe("/epi/cms/action/save",this._save);this.subscribe("/epi/cms/action/undo",this._undo);this.subscribe("/epi/cms/action/redo",this._redo);this.subscribe("/epi/cms/action/disableundoredoactions",this._toggleUndoRedoActions);},destroy:function(){this._unwatchViewModelHandles();this._stopActiveEditorWrapper();if(this._renderManager){this._renderManager.destroy();}if(this._autoSaveButton){this._autoSaveButton.destroyRecursive();}this._mappingManager.clear();if(this.toolbar){this.toolbar=null;}if(this._syncIntervalId){clearInterval(this._syncIntervalId);}this.inherited(arguments);},_setCommandEnabled:function(_18,_19){if(this.toolbar){this.toolbar.setItemProperty(_18,"disabled",!_19);}},onContentLinkSyncChange:function(){this.inherited(arguments);this._setButtonState();},_setViewModelAttr:function(_1a){if(_1a===this.viewModel){return;}this.inherited(arguments);this.destroyByKey("viewModel");this.ownByKey("viewModel",_2.connect(this.viewModel,"onContentChange",this,this._stopActiveEditorWrapper));this.ownByKey("viewModel",_2.connect(this.viewModel,"onSetActiveProperty",this,this.onSetActiveProperty));this.ownByKey("viewModel",_b.subscribe("/dnd/start",_7.hitch(this.viewModel,"beginOperation")));this.ownByKey("viewModel",_b.subscribe("/dnd/stop",_7.hitch(this,function(){if(this._activeEditorWrapper){return;}this.viewModel.endOperation();})));},_stopActiveEditorWrapper:function(){if(this._activeEditorWrapper!=null){_c(this._activeEditorWrapper.tryToStopEditing(),_7.hitch(this,function(){this._activeEditorWrapper=null;}));}},onSetActiveProperty:function(_1b){var _1c=this._mappingManager.findOne("propertyName",_1b);if(_1c){if(_1c.wrapper){_1c.wrapper.startEdit();}else{if(_1c.overlayItem){this._onOverlayItemClick(_1c.overlayItem);}}}},onPreviewReady:function(_1d,doc){if(_1d!=this.viewModel){this.set("viewModel",_1d);this.setupEditMode(doc);}else{if(_1d){this.remapEditMode(doc);}}},_setButtonState:function(){this._setCommandEnabled("reverttopublished",this.viewModel&&!this.viewModel.contentData.isPendingPublish);},setupEditMode:function(doc){this.viewModel.getContentModelAndMetadata().then(_7.hitch(this,function(){this._mappingManager.clear();this._renderManager=new _15();if(this.toolbar&&!this._autoSaveButton){this._autoSaveButton=new _13({button:this.toolbar._getWidget("autosave"),model:this.viewModel});}else{if(this._autoSaveButton){this._autoSaveButton.set("model",this.viewModel);}}var _1e=_7.hitch(this,function(){this._toggleUndoRedoActions(this.viewModel.hasUndoSteps,this.viewModel.hasRedoSteps);});this.viewModel.resetNotifications();this._unwatchViewModelHandles();this._viewModelHandles=[this.viewModel.watch("hasUndoSteps",_1e),this.viewModel.watch("hasRedoSteps",_1e)];_1e();this.onReadySetupEditMode(doc);this._setButtonState();this.onPrepareOverlayComplete();}));},remapEditMode:function(doc){this.viewModel.getMetadataThenUpdateModel().then(_7.hitch(this,function(){this._renderManager.resume();if(doc){setTimeout(_7.hitch(this,function(){this._remapUpdateControllers(doc);this.onPrepareOverlayComplete();this._toggleUndoRedoActions(this.viewModel.hasUndoSteps,this.viewModel.hasRedoSteps);this._autoSaveButton.set("model",this.viewModel);}),1);}}));},_unwatchViewModelHandles:function(){if(this._viewModelHandles){_1.forEach(this._viewModelHandles,function(_1f){_1f.unwatch();});this._viewModelHandles=null;}},onReadySetupEditMode:function(doc){this._createUpdateControllers(doc);},onSetupEditModeComplete:function(){if(this.activePropertyOnStartup){this.onSetActiveProperty(this.activePropertyOnStartup);this.activePropertyOnStartup=null;}},_getPropertyNodes:function(doc){var _20=_a("[data-epi-property-name]",doc);var _21=_a("[data-epi-property-name] [data-epi-property-name]",doc);return _1.filter(_20,function(_22){return _21.indexOf(_22)===-1;});},_getEditableNodes:function(doc){if(!doc||!this.viewModel.canChangeContent()){return [];}var _23=this._getPropertyNodes(doc);var _24=[];_1.forEach(_23,function(_25){var _26=_10.pascalToCamel(_9.get(_25,"data-epi-property-name"));var _27=this.viewModel.getPropertyMetaData(_26);if(!_27){return;}var _28=_10.pascalToCamel(_27.name);var _29=_9.get(_25,"data-epi-property-display-name");if(_29){_27=_7.delegate(_27,{displayName:_29});}if(_27!=null&&_27.showForEdit){var _2a={cacheResults:true,rerenderOnCancel:false,propertyRenderSettings:_9.get(_25,"data-epi-property-rendersettings")||undefined,useMvc:_9.has(_25,"data-epi-use-mvc")?_9.get(_25,"data-epi-use-mvc").toLowerCase()==="true":false};_2a=_7.mixin(_2a,_27.additionalValues.renderSettings);var _2b=_9.has(_25,"data-epi-property-editorsettings")?_6.fromJson(_9.get(_25,"data-epi-property-editorsettings")):null;var _2c=_9.has(_25,"data-epi-property-overlaysettings")?_6.fromJson(_9.get(_25,"data-epi-property-overlaysettings")):null;_2c=_7.mixin(_2c,_27.overlaySettings);_24.push({node:_25,disabled:(_9.get(_25,"data-epi-disabled")=="true"),useOverlay:(_9.get(_25,"data-epi-useoverlay")=="true"),overlayZIndex:parseInt(_9.get(_25,"data-epi-overlay-z-index"),10)||0,property:{name:_28,contentLink:this.viewModel.contentLink,contentModel:this.viewModel.contentModel,type:_9.get(_25,"data-epi-property-type"),wrapperType:_9.get(_25,"data-epi-property-edittype"),editorParams:_2b,overlayParams:_2c,editorWidgetType:_9.get(_25,"data-epi-property-editor"),renderSettings:_2a,rendererClass:(_9.get(_25,"data-epi-property-render")==="client")?"epi.cms.contentediting.ClientRenderer":_27.customEditorSettings.rendererClass,metadata:_27,propertyNodeName:_26}});}},this);_24.sort(function(a,b){if(a.overlayZIndex<b.overlayZIndex){return -1;}else{if(a.overlayZIndex>b.overlayZIndex){return 1;}else{return 0;}}});return _24;},_createUpdateControllers:function(doc){var _2d=this._createFullPageUpdateController(doc);if(_2d){this._connectUpdateControllerAndOverlayEvents(_2d,null);this._mappingManager.add({updateController:_2d});}var _2e=this._getEditableNodes(doc);_1.forEach(_2e,function(_2f){var _30=_2f.property;var _31=_2f.node.innerHTML;var _32=this._createNodeUpdateController(_2f);_c(this._createNodeOverlay(_2f),_7.hitch(this,function(_33){this._connectUpdateControllerAndOverlayEvents(_32,_33);this._mappingManager.add({blockPropertyInfo:_30,node:_2f.node,updateController:_32,overlayItem:_33});}));this._renderManager.cacheRender(_30.name,_30.renderSettings,this.viewModel.getProperty(_30.name),_31);},this);},_createNodeOverlay:function(_34){var _35=new _4();if(!this.createOverlays){_35.resolve(null);return _35;}_c(_17.create(_34),_7.hitch(this,function(_36){this.overlay.addChild(_36);_35.resolve(_36);}));return _35;},_createNodeUpdateController:function(_37){var _38=_37.property;var _39=_38.metadata;var _3a=new _16({displayName:_39.displayName,renderManager:this._renderManager,contentModel:_38.contentModel,contentLink:_38.contentLink,modelPropertyName:_38.name,nodePropertyName:_38.propertyNodeName,renderSettings:_38.renderSettings,rendererClass:_38.rendererClass,displayNode:_37.node});return _3a;},_createFullPageUpdateController:function(doc){var _3b=[];if(doc){var _3c=_a("input[data-epi-full-refresh-property-names][type='hidden']",doc);_1.forEach(_3c,function(tag){_1.forEach(_9.get(tag,"data-epi-full-refresh-property-names").split(","),function(_3d){if(!_1.some(_3b,function(p){return p===_3d;})){_3b.push(_10.pascalToCamel(_3d));}});});}_1.forEach(this.viewModel.metadata.properties,function(_3e){if(_3e.additionalValues["reloadOnChange"]===true){_3b.push(_10.pascalToCamel(_3e.name));}});if(!_3b.length){return null;}var _3f=new _16({displayName:"",renderManager:this._renderManager,contentModel:this.viewModel.contentModel,modelPropertyName:_3b,renderSettings:{isFullReload:true}});return _3f;},_remapUpdateControllers:function(doc){var _40=this._getEditableNodes(doc);var _41=this._mappingManager.remap(_40);_1.forEach(_41,function(_42){var _43=_42.property;var _44=this._createNodeUpdateController(_42);var _45=this._mappingManager.find(function(m){return (m.updateController===undefined||m.updateController===null)&&(m.propertyName.indexOf(_43.name)===0);});_c(this._createNodeOverlay(_42),_7.hitch(this,function(_46){this._connectUpdateControllerAndOverlayEvents(_44,_46);if(_45&&_45.length){this._mappingManager.update(_45[0],{updateController:_44,overlayItem:_46,node:_42.node});}else{this._mappingManager.add({blockPropertyInfo:_43,node:_42.node,updateController:_44,overlayItem:_46});}}));this._renderManager.cacheRender(_43.name,_43.renderSettings,this.viewModel.getProperty(_43.name),_42.node.innerHTML);},this);var _47=this._createFullPageUpdateController(doc);if(_47){this._connectUpdateControllerAndOverlayEvents(_47,null);this._mappingManager.add({updateController:_47});}},_connectUpdateControllerAndOverlayEvents:function(_48,_49){if(_48){this.connect(_48,"onReloadRequired",this._onBlockReloadRequired);this.connect(_48,"onRender",this._onBlockRender);}if(_49){this.connect(_49,"onClick",this._onOverlayItemClick);this.connect(_49,"onValueChange",function(_4a){this._onOverlayValueChange(_49,_4a);});}},_getEditor:function(_4b){var _4c=this._mappingManager.findOne("overlayItem",_4b);return (_4c.wrapper&&_4c.wrapper.editorWidget)?_4c.wrapper.editorWidget:null;},onEditorWrapperCreated:function(_4d){},_onOverlayItemClick:function(_4e,e){if(e){_5.stop(e);}var _4f=this._mappingManager.findOne("overlayItem",_4e);var _50=_4f.blockPropertyInfo;var val=this.viewModel.getProperty(_4f.propertyName);var _51=_7.clone(val,true);var _52;var _53=_7.hitch(this,function(_54){_4f.wrapper=_54;this._activeEditorWrapper=_54;_b.publish("/epi/layout/pinnable/propertyEditor/show",null);_1.forEach(this._mappingManager.find(),function(m){if(m.overlayItem){m.overlayItem.set("active",false);}});_4f.overlayItem.set("active",true);var _55={value:_51,parent:_54};_54.startEdit(_55);this.overlay.set("readOnly",_54.isOverlayDisabled);this.viewModel.set("disableUndo",_54.isUndoDisabled);});if(_4f.wrapper){_52=_4f.wrapper;if(_52&&_52.editorWidget&&!_52.editorWidget.overlayItem){_52.editorWidget.overlayItem=_4e;}_52.set("blockDisplayNode",_4f.node);_53(_52);}else{_c(this._createEditorWrapper(_50,_4e,_4f.node,_51),_7.hitch(this,function(_56){_53(_56);this.onEditorWrapperCreated(_56);}));}},_createEditorWrapper:function(_57,_58,_59,_5a){var def=new _4(),_5b={overlayItem:_58};_c(this.editorFactory.createEditor(_57,_59,_5a,_5b),_7.hitch(this,function(_5c){this.connect(_5c,"onValueChange","_onWrapperValueChange");this.connect(_5c,"onCancel","_onWrapperCancel");this.connect(_5c,"onStopEdit","_onWrapperStopEdit");def.resolve(_5c);}),def.reject);return def;},_onBlockReloadRequired:function(_5d){var rm=this._renderManager;setTimeout(function(){rm.suspend();rm.clear();},1);this._reloadRequiredProperty=_5d.modelPropertyName;this._reloadPropertyPreview();},_onBlockRender:function(_5e){var _5f=this._mappingManager.findOne("updateController",_5e);if(_5f&&_5f.overlayItem){_5f.overlayItem.refresh();}},_saveEditorChanges:function(_60,_61){var _62=this._getEditor(_60);if(_62&&!_62.overlayItem){_62.overlayItem=_60;}if(_62&&_62.saveChanges){_62.saveChanges(_62,_61);}},_onOverlayValueChange:function(_63,_64){this._saveEditorChanges(_63,_64.value);this.viewModel.setProperty(_64.propertyName,_64.value);},_onWrapperValueChange:function(_65,_66,_67){var _68=this._mappingManager.findOne("wrapper",_65),_69=_68.propertyName;if(_68.overlayItem){_68.overlayItem.set("updated",true);}this.viewModel.beginOperation();this.viewModel.setProperty(_69,_66,_67);},_onWrapperStopEdit:function(_6a,_6b,_6c,_6d){var _6e=this._mappingManager.findOne("wrapper",_6a);this.viewModel.endOperation();this._save();if(_6e.overlayItem){_6e.overlayItem.set("active",false);}this._activeEditorWrapper=null;this.overlay.set("readOnly",false);this.viewModel.set("disableUndo",false);},_onWrapperCancel:function(_6f,_70){this.viewModel.abortOperation();var _71=this._mappingManager.findOne("wrapper",_6f);var _72=_71.updateController;if(_72&&_72.renderSettings&&_72.renderSettings.rerenderOnCancel){_72.render();}if(_6f.get("isModified")){this._save();}if(_71.overlayItem){_71.overlayItem.set("active",false);}this._activeEditorWrapper=null;this.overlay.set("readOnly",false);this.viewModel.set("disableUndo",false);},_undo:function(){setTimeout(_7.hitch(this,function(){this.viewModel.undo();}),0);},_redo:function(){setTimeout(_7.hitch(this,function(){this.viewModel.redo();}),0);},_toggleUndoRedoActions:function(_73,_74){this._setCommandEnabled("undo",!!_73);this._setCommandEnabled("redo",!!_74);},_save:function(){if(!this.viewModel||!this.viewModel.hasPendingChanges){return;}_c(this.viewModel.save(),_7.hitch(this,this._reloadPropertyPreview));},_reloadPropertyPreview:function(){if(!this.viewModel.isSaved){this._save();return;}var _75=this._activeEditorWrapper&&(this._activeEditorWrapper.propertyName===this._reloadRequiredProperty);var _76=this._activeEditorWrapper&&this._activeEditorWrapper.hasInlineEditor;if(this._reloadRequiredProperty&&!(_75&&_76)){this._toggleUndoRedoActions(false,false);this.onReloadRequired();this._reloadRequiredProperty=null;}}});});