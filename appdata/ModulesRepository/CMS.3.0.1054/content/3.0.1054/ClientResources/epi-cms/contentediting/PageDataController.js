//>>built
require({cache:{"url:epi-cms/contentediting/templates/PageDataController.html":"<div style=\"width: 100%; height: 100%;\">\r\n    <div data-dojo-attach-point=\"layoutContainer\" data-dojo-type=\"dijit/layout/BorderContainer\" data-dojo-props=\"gutters: false, livesplitters: false\" style=\"width: 100%; height: 100%\">\r\n        <div data-dojo-attach-point=\"toolbar\" data-dojo-type=\"epi-cms/contentediting/EditToolbar\" data-dojo-props=\"region:'top'\"></div>\r\n        <div data-dojo-attach-point=\"notificationBar\" data-dojo-type=\"epi-cms/contentediting/NotificationBar\" data-dojo-props=\"region:'top'\"></div>\r\n        <div data-dojo-attach-point=\"editLayout\" data-dojo-type=\"epi/shell/layout/CardContainer\" data-dojo-props=\"region: 'center'\">\r\n            <div data-dojo-attach-point=\"iframeWithOverlay\" data-dojo-type=\"epi/shell/widget/IframeWithOverlay\" data-dojo-props=\"fitContainer: true\">\r\n            </div>\r\n        </div>\r\n    </div>\r\n</div>"}});define("epi-cms/contentediting/PageDataController",["dojo/_base/array","dojo/_base/declare","dojo/_base/lang","dojo/dom-class","dojo/dom-style","dojo/Deferred","dojo/promise/all","dojo/topic","dojo/when","dijit/_TemplatedMixin","dijit/_Widget","dijit/_WidgetsInTemplateMixin","dijit/layout/BorderContainer","epi/dependency","epi/string","epi/Url","epi/shell/layout/CardContainer","epi/shell/widget/IframeWithOverlay","epi-cms/_ContentContextMixin","epi-cms/contentediting/ContentReferencesNotification","epi-cms/contentediting/ContentViewModel","epi-cms/contentediting/EditToolbar","epi-cms/contentediting/ExpirationNotification","epi-cms/contentediting/LanguageNotification","epi-cms/contentediting/NotificationBar","epi-cms/contentediting/ShortcutNotification","epi-cms/contentediting/ViewSettingsNotification","epi-cms/contentediting/WorkflowTaskNotification","epi-cms/contentediting/command/Editing","epi/i18n!epi/cms/nls/episerver.cms.contentediting","dojo/text!./templates/PageDataController.html"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e,_f,Url,_10,_11,_12,_13,_14,_15,_16,_17,_18,_19,_1a,_1b,_1c,res,_1d){return _2([_b,_a,_c,_12],{templateString:_1d,contextTypeName:"epi.cms.contentdata",pendingNotificationTimeOutId:null,isActive:true,defaultEditCssRules:[{selector:".epi-injected-minSize",css:"min-height: 30px;"},{selector:".epi-injected-minSize-inline",css:"min-height: 30px; min-width: 100px; display: inline-block !important;"},{selector:"[contenteditable=true]:focus",css:"outline: 3px #b4c600 solid;"}],_currentViewComponent:null,_viewModels:null,_notificationHandlerId:null,_messageService:null,_editingCommands:null,_currentViewModel:null,_pageDataStore:null,_contentReferencesNotification:null,_shortcutNotification:null,_languageNotification:null,_expirationNotification:null,_workflowTaskNotification:null,_availableViews:null,_previewQueryParameters:null,_viewSettingsManager:null,_inUseNotificationManager:null,_showOverlay:true,postMixInProperties:function(){this.inherited(arguments);var _1e=_e.resolve("epi.storeregistry");this._viewSettingsManager=_e.resolve("epi.viewsettingsmanager");this._messageService=this._messageService||_e.resolve("epi.shell.MessageService");this._profile=this._profile||_e.resolve("epi.shell.Profile");this._pageDataStore=_1e.get("epi.cms.contentdata");this._editingCommands=_1c;if(!this._viewModels){this._viewModels=[];}this._inUseNotificationManager=this.inUseNotificationManager||_e.resolve("epi.cms.contentediting.inUseNotificationManager");this._contentReferencesNotification=new _13();this._languageNotification=new _17();this._expirationNotification=new _16();this._shortcutNotification=new _19();this._viewSettingsNotification=new _1a();this._workflowTaskNotification=new _1b();},postCreate:function(){this.inherited(arguments);this.subscribe("/epi/cms/action/switcheditmode",_3.hitch(this,this._switchEditMode));var cs=_e.resolve("epi.shell.ContextService");this._interceptorHandle=cs.registerRequestInterceptor(_3.hitch(this,this._interceptRequestContext));this.notificationBar.on("notificationsChanged",_3.hitch(this,function(){this.layoutContainer.layout();}));this.own(this._contentReferencesNotification.watch("notification",_3.hitch(this,this._contentReferencesNotificationWatchHandler)),this._languageNotification.watch("notification",_3.hitch(this,this._defaultNotificationWatchHandler)),this._expirationNotification.watch("notification",_3.hitch(this,this._defaultNotificationWatchHandler)),this._shortcutNotification.watch("notification",_3.hitch(this,this._shortcutNotificationWatchHandler)),this._viewSettingsNotification.watch("notification",_3.hitch(this,this._defaultNotificationWatchHandler)),this._workflowTaskNotification.watch("notification",_3.hitch(this,this._workflowTaskNotificationWatchHandler)));},startup:function(){if(this._started){return;}this.inherited(arguments);var url=new Url(window.location.href),_1f=url.getQueryParameterValue("view");this.iFrame=this.iframeWithOverlay.iframe;this.connect(this.iFrame,"onLoad","_iFrameLoaded");this.connect(this.iFrame,"onUnload","_iFrameUnLoaded");_4.add(this.toolbar.domNode,"epi-localToolbar epi-viewHeaderContainer");this._injectCssRules();_9(this.getCurrentContext(),_3.hitch(this,function(_20){this.contextChanged(_20);}));},_defaultNotificationWatchHandler:function(_21,_22,_23){if(_22){this.notificationBar.remove(_22);}if(_23&&_23.content){this.notificationBar.add(_23);}},_shortcutNotificationWatchHandler:function(_24,_25,_26){this._defaultNotificationWatchHandler(_24,_25,_26);this._showOverlay=_19.LinkTypes[_26.shortcutType]!=="fetchdata";},_contentReferencesNotificationWatchHandler:function(_27,_28,_29){this._defaultNotificationWatchHandler(_27,_28,_29);this.notificationBar.set("viewModel",this._currentViewModel.contentData);},_workflowTaskNotificationWatchHandler:function(_2a,_2b,_2c){if(_2b instanceof Array){_1.forEach(_2b,function(_2d){this.notificationBar.remove(_2d);},this);}if(_2c instanceof Array){_1.forEach(_2c,function(_2e){this.notificationBar.add(_2e);},this);}},_switchEditMode:function(_2f,_30){var _31,_32=this._currentViewModel.viewName,_33=null,_34="view",_35="onpageedit",_36="formedit";if(_32===_34){_8.publish("/epi/cms/action/disablepreview");}if(_32===_36){_31=_35;_33=this._getPreviewUrl(this._currentContentContext,_31);}else{_31=_36;}this._ensurePreviewReady(this.setView(_31,_30),_33,function(_37){});},destroy:function(){this._interceptorHandle.remove();this._destroyCurrentViewComponent();this._viewModels=null;this.inherited(arguments);},_iFrameLoaded:function(url,_38){if(!!url&&!_38){this._requestContextChangeByUrl(url,true,true);}},_iFrameUnLoaded:function(url){this.iframeWithOverlay.overlay.set("enabled",false);},_destroyCurrentViewComponent:function(){if(this._currentViewComponentReloadRequireHandle){this._currentViewComponentReloadRequireHandle.remove();this._currentViewComponentReloadRequireHandle=null;}if(this._currentViewComponent){this._currentViewComponent.destroyRecursive();this._currentViewComponent=null;}},_getViewModelIndex:function(id){var _39=-1;_1.some(this._viewModels,function(_3a,idx){if(_3a.contentLink==id){_39=idx;return true;}});return _39;},_getViewModel:function(id){var _3b=this._getViewModelIndex(id);if(_3b>=0){return this._viewModels[_3b];}else{return null;}},_removeViewModel:function(id){var _3c=this._getViewModelIndex(id);if(_3c>=0){var _3d=this._viewModels.splice(_3c,1)[0];_3d.clear();}},_createViewModel:function(_3e,ctx){var _3f=new _14({contentLink:_3e.contentLink,contextTypeName:this.contextTypeName});_3f.set("contentData",_3e);_3f.set("languageContext",ctx.languageContext);this._viewModels.push(_3f);return _3f;},contentContextUpdated:function(ctx,_40){var _41=ctx.id;this._pageDataStore.refresh(_41).then(_3.hitch(this,function(_42){if(this._currentViewModel){this._updateContentViewModel(_42,ctx.languageContext);this._refreshModel(_42,ctx);}}));},updateView:function(_43,ctx,_44){if(_43&&_43.skipUpdateView){return;}if(_44&&_44.widgetResumed){_5.set(this.domNode,"visibility","hidden");}if(_43&&_43.contextIdSyncChange){this._pageDataStore.refresh(ctx.id).then(_3.hitch(this,function(_45){this._updateContentViewModel(_45,ctx.languageContext);this._currentViewComponent.onContentLinkSyncChange();this._refreshModel(_45,ctx);}));}else{this._previousEditMode=null;if(this._currentViewModel){this._currentViewModel.suspend();}var _46;if(_43&&_43.viewName){if(_43.availableViews){this._availableViewsLookup={};_1.forEach(_43.availableViews,_3.hitch(this,function(_47){this._availableViewsLookup[_47.key]=_47;}));}_46=_43.viewName;}this.toolbar.update({currentContext:ctx,viewConfigurations:{availableViews:_43.availableViews,viewName:_43.viewName}});if(this._currentViewComponent&&this._currentViewComponent.isSticky){_46=this._currentViewModel.viewName;}var _48=this._getPreviewUrl(ctx,_46);this._ensurePreviewReady(this._loadContentDataAndSetView(ctx.id,_46,ctx),_48);}},_getPreviewUrl:function(_49,_4a){return (_4a==="view"&&_49.previewUrl)?_49.previewUrl:_49.editablePreviewUrl;},_ensurePreviewReady:function(_4b,_4c){var _4d=[];if(_4b){_4d.push(_4b);}if(_4c!==null&&_4c!==undefined){_4d.push(this._changeUrl(_4c));}_7(_4d).then(_3.hitch(this,function(){var doc=this.iframeWithOverlay.iframe.getDocument();var _4e=this.connect(this._currentViewComponent,"onPrepareOverlayComplete",function(){this.disconnect(_4e);_4e=null;this.iframeWithOverlay.overlay.set("enabled",this._showOverlay&&this.iframeWithOverlay.iframe.isInspectable());this.iframeWithOverlay.layout(true);});_5.set(this.domNode,"visibility","visible");this._viewSettingsManager.onPreviewReady(this.iframeWithOverlay);this._currentViewComponent.onPreviewReady(this._currentViewModel,doc);this._viewSettingsNotification.set("invokeActionValue",{viewModel:this._currentViewModel,viewSetting:this._viewSettingsManager});}));},_loadContentDataAndSetView:function(_4f,_50,ctx){var def=new _6();_9(this._pageDataStore.refresh(_4f),_3.hitch(this,function(_51){if(!_51){return;}this._currentViewModel=this._getViewModel(_51.contentLink);this.notificationBar.clear();if(!this._currentViewModel){this._currentViewModel=this._createViewModel(_51,ctx);}else{this._updateContentViewModel(_51,ctx.languageContext);}this._currentViewModel.set("viewLanguage",this._viewSettingsManager.get("enabled")?this._viewSettingsManager.getSettingProperty("viewlanguage"):null);this._refreshModel(_51,ctx);_9(this.setView(_50),function(){def.resolve();},function(){def.cancel();});}),function(){def.reject();});return def;},_updateContentViewModel:function(_52,_53){this._currentViewModel.wakeUp();this._currentViewModel.set("contentData",_52);this._currentViewModel.set("languageContext",_53);},_refreshModel:function(_54,_55){var _56=this._currentViewModel;if(_56){this.toolbar.set("contentViewModel",_56);this._inUseNotificationManager.updateCommandModel(_56);this._editingCommands.set("model",_56);this._contentReferencesNotification.set("invokeActionValue",_56.contentData);this._languageNotification.set("invokeActionValue",_55);this._shortcutNotification.set("invokeActionValue",_56);this._workflowTaskNotification.set("invokeActionValue",_56.contentData);this._expirationNotification.set("invokeActionValue",_56);}},itemChanged:function(id,_57){},setView:function(_58,_59){var def=new _6();if(_58==="onpageedit"&&(!this._currentViewModel.contentData.hasTemplate||!(_58 in this._availableViewsLookup))){_58="formedit";}if(_58&&!(_58 in this._availableViewsLookup)){return;}var _5a=_3.hitch(this,function(){_9(this._setView(_58,_59),function(){def.resolve();},function(){def.cancel();});});var _5b=_3.hitch(this,function(){_8.publish("/epi/cms/action/showerror");def.cancel();});_9(this._savePendingChanges(),_5a,_5b);return def;},_setView:function(_5c,_5d){var def=new _6(),_5e=this._currentViewComponent,_5f=_5e&&_5e.viewModel&&_5e.viewModel.viewName===_5c;_5f=false;if(_5f){this._currentViewModel.viewName=_5c;this.toolbar.set("contentViewModel",this._currentViewModel);def.resolve();}else{this._destroyCurrentViewComponent();var _60=_f.slashName(this._availableViewsLookup[_5c].viewType);require([_60],_3.hitch(this,function(_61){this._currentViewComponent=new _61(_3.mixin({layoutContainer:this.editLayout,iframeWithOverlay:this.iframeWithOverlay,contextTypeName:this.contextTypeName,toolbar:this.toolbar},_5d));this._currentViewComponentReloadRequireHandle=this.connect(this._currentViewComponent,"onReloadRequired",this._onViewRequireReload);this._currentViewComponent.startup();this._currentViewModel.viewName=_5c;this.toolbar.set("contentViewModel",this._currentViewModel);if(this.editLayout.leftOver&&!this._currentViewComponent.canHandleLeftOver){_9(this.editLayout.selectedChildWidget===this.editLayout.leftOver?this.editLayout.selectChild(this.iframeWithOverlay):null,_3.hitch(this,function(){this.editLayout.removeChild(this.editLayout.leftOver);this.editLayout.leftOver.destroyRecursive();this.editLayout.leftOver=null;}));}def.resolve();}));}return def;},_onViewRequireReload:function(){var _62=this._getPreviewUrl(this._currentContentContext,this._currentViewModel.viewName);this._ensurePreviewReady(null,_62);},resize:function(_63){this.inherited(arguments);this.layoutContainer.resize(_63);},onShow:function(){this.iframeWithOverlay.overlay.set("enabled",this._showOverlay);},onHide:function(){this.iframeWithOverlay.overlay.set("enabled",false);},_clearNotifications:function(){if(this._currentViewModel&&this._currentViewModel.validator){this._currentViewModel.validator.clear();}},_requestContextChangeByUrl:function(url,_64,_65,_66,_67){var _68=new Url(url,_66,_67),_69={url:_68.toString()},_6a={sender:this,forceContextChange:_64,suppressFailure:_65,viewName:this._currentViewModel&&this._currentViewModel.viewName};_8.publish("/epi/shell/context/request",_69,_6a);},_changeUrl:function(url){var _6b=_3.mixin(this._previewQueryParameters,this._viewSettingsManager.get("previewParams"));return this.iframeWithOverlay.iframe.load(url,{query:_6b},true,true);},_interceptRequestContext:function(_6c,_6d){if(!(_6d&&_6d.sender&&_6d.sender===this)){return this._savePendingChanges();}else{var def=new _6();def.resolve();return def;}},_savePendingChanges:function(){if(this._currentViewModel&&!this._currentViewModel.isSaved){return this._currentViewModel.save();}else{var def=new _6();def.resolve();return def;}},savePendingChanges:function(){return this._savePendingChanges();},_injectCssRules:function(){this.iFrame.addCssRules(this.defaultEditCssRules);}});});