(function(tinymce,$){tinymce.create("tinymce.plugins.epipersonalizedcontent",{_onInitCalled:!1,_pcDragging:!1,_pcInClipboard:!1,init:function(ed,url){var self=this;if("undefined"==typeof epiContentBlockUtilities){var scriptUrl=tinymce.baseURI.toAbsolute("plugins/epipersonalizedcontent/epicontentblockutilities.js");tinymce.ScriptLoader.load(scriptUrl,function(){this._init(ed,url)},this),tinymce.ScriptLoader.loadQueue()}else this._init(ed,url);ed.addButton("epipersonalizedcontent",{title:"epipersonalizedcontent.epipersonalizedcontent_desc",cmd:"epipersonalizedcontent","class":"mce_epipersonalizedcontent"}),ed.onInit.add(function(){self._onInitCalled=!0}),ed.onPreInit.addToTop(function(){var mceNonEditableClass=tinymce.trim(ed.getParam("noneditable_noneditable_class","mceNonEditable")),mceEditableClass=tinymce.trim(ed.getParam("noneditable_editable_class","mceEditable"));ed.parser.addAttributeFilter("class",function(nodes){for(var i=nodes.length;i--;)self._convertPCToMceNonEditable(nodes[i],mceNonEditableClass,mceEditableClass)})})},_init:function(ed){$.extend(this,epiContentBlockUtilities);var self=this;self._personalizedContentHeaderClass=ed.getParam("epipersonalizedcontent_headercssclass","epi_pc_h"),self._personalizedContentFooterClass=ed.getParam("epipersonalizedcontent_footercssclass","epi_pc_f"),self._personalizedContentClass=ed.getParam("epipersonalizedcontent_cssclass","epi_pc"),self._personalizedContentHolderClass=ed.getParam("epipersonalizedcontent_holdercssclass","epi_pc_content"),self.ed=ed,self._disabled=!1,self._enabledControls=ed.getParam("epipersonalizedcontent_enabledcontrols",""),ed.addCommand("epipersonalizedcontent",function(){if(!self._validateAndCorrectSelection())return ed.windowManager.alert(ed.translate("epipersonalizedcontent.invalidselectionwarning")),void 0;var pc=self._getParentNode(self._getCommonAncestor(),self._personalizedContentClass),onDialogComplete=function(returnData){if(returnData){var innerContent,html,contentNode,body=ed.getBody(),last=body&&body.lastChild;ed.selection.getNode()===last&&body.appendChild(ed.dom.create("p",null,'<br _mce_bogus="1" />')),returnData.removePersonalization?pc&&(contentNode=ed.dom.select("."+self._personalizedContentHolderClass,pc)[0],innerContent=contentNode.innerHTML,ed.dom.remove(pc),ed.execCommand("mceInsertContent",!1,innerContent)):pc?(contentNode=ed.dom.select("."+self._personalizedContentHolderClass,pc),innerContent=$(contentNode).html(),html=returnData.replace("[personalizedContentPlaceHolder]",innerContent),ed.dom.remove(pc),ed.execCommand("mceInsertContent",!1,html)):(innerContent=ed.selection.getContent(),""===innerContent&&(innerContent='<p><br mce_bogus="1" /></p>'),html=returnData.replace("[personalizedContentPlaceHolder]",innerContent),ed.selection.getStart()===ed.selection.getEnd()&&ed.dom.remove(ed.selection.getNode()),ed.execCommand("mceInsertContent",!1,html)),self._onContentChanged()}},dialogFeatures={width:600,height:450},dialogURL=EPi.ResolveUrlFromUI("Editor/Dialogs/PersonalizedContent.aspx"),parameters={allContentGroups:self._getAllContentGroups()};if(pc)parameters.groups=ed.dom.getAttrib(pc,"data-groups",""),parameters.contentGroup=ed.dom.getAttrib(pc,"data-contentgroup","");else if(ed.selection.isCollapsed())return;ed.windowManager.open({url:dialogURL+"?"+$.param(parameters),width:dialogFeatures.width,height:dialogFeatures.height,onCallback:onDialogComplete})});var pluginInit=function(ed){$(ed.dom.doc).click(function(e){self._handleButtonsClick(e)}),self._showButton(ed,ed.controlManager,!1,!1),ed.onNodeChange.add(function(ed,controlManager,node,collapsed){var pc=self._getParentNode(node,self._personalizedContentClass),pcContentHolder=self._getParentNode(node,self._personalizedContentHolderClass),insidePC=!!pc,insidePCContentHolder=!!pcContentHolder;self._updateCommandState(!insidePC||insidePCContentHolder),self._showButton(ed,controlManager,!collapsed||insidePC,insidePC)}),ed.dom.bind(ed.getBody(),"dragstart",function(){self._pcDragging=self._selectionContainsPC()}),ed.dom.bind(ed.getBody(),"dragend",function(){self._pcDragging=!1}),ed.dom.bind(ed.getBody(),"cut",function(){self._pcInClipboard=self._selectionContainsPC()}),ed.dom.bind(ed.getBody(),"copy",function(){self._pcInClipboard=self._selectionContainsPC()}),ed.dom.bind(ed.getBody(),"drop",function(e){self._preventNestedPC(e)}),ed.dom.bind(ed.getBody(),"paste",function(e){self._preventNestedPC(e)})};self._onInitCalled?pluginInit(ed):ed.onInit.add(pluginInit)},_preventNestedPC:function(event){var aboutToInsertPC="drop"===event.type?this._pcDragging:"paste"===event.type?this._pcInClipboard:!1,target=event.srcElement||event.originalTarget;return target===this.ed.getBody()&&(target=this.ed.selection.isCollapsed()?this.ed.selection.getNode():target),aboutToInsertPC&&this._getParentNode(target,this._personalizedContentHolderClass)?(this.ed.dom.events.cancel(event),!1):void 0},_showButton:function(ed,controlManager,enabled,active){var isHidden=ed.dom.isHidden(ed.container);controlManager.setDisabled("epipersonalizedcontent",isHidden||!enabled),controlManager.setActive("epipersonalizedcontent",!isHidden&&active)},_handleButtonsClick:function(e){return this.ed.dom.hasClass(e.target,"epi_pc_editBtn")&&0===e.button?(tinyMCE.execCommand("epipersonalizedcontent"),tinymce.dom.Event.cancel(e)):void 0},_validateAndCorrectSelection:function(){var nodeToPersonalize,container,parentNode=this._getCommonAncestor(),startNode=this.ed.selection.getStart(),endNode=this.ed.selection.getEnd();if(startNode!==endNode?(container=this._getNotPersonalizableContainer(startNode,parentNode),container?nodeToPersonalize=this._getPersonalizableParent(container):(container=this._getNotPersonalizableContainer(endNode,parentNode),container&&(nodeToPersonalize=this._getPersonalizableParent(container)))):nodeToPersonalize=this._getPersonalizableParent(parentNode),!nodeToPersonalize)return null===this.ed.selection.getContent().match(this._personalizedContentClass);if(this.ed.selection.select(nodeToPersonalize),!this.ed.dom.hasClass(nodeToPersonalize,this._personalizedContentClass)){var personalizedContents=tinyMCE.activeEditor.dom.select("div."+this._personalizedContentClass,nodeToPersonalize);if(personalizedContents.length>0)return!1}return!0},_getPersonalizableParent:function(node){var self=this;return this.ed.dom.getParent(node,function(parent){return"LI"===node.nodeName?"UL"===parent.nodeName||"OL"===parent.nodeName:"TR"===node.nodeName||"TD"===node.nodeName||"TH"===node.nodeName||"TBODY"===node.nodeName||"THEAD"===node.nodeName||"TFOOT"===node.nodeName?"TABLE"===parent.nodeName:"DT"===node.nodeName||"DD"===node.nodeName?"DL"===parent.nodeName:self.ed.dom.isBlock(parent)})},_isNotPersonalizableNode:function(node){return"TD"===node.nodeName||"TR"===node.nodeName||"TH"===node.nodeName||"TBODY"===node.nodeName||"THEAD"===node.nodeName||"TFOOT"===node.nodeName||"LI"===node.nodeName||"DT"===node.nodeName||"DD"===node.nodeName},_getNotPersonalizableContainer:function(node,root){var self=this;return this.ed.dom.getParent(node,function(parent){return self._isNotPersonalizableNode(parent)},root)},_selectionContainsPC:function(){var pcMatchRule=RegExp("<div.*"+this._personalizedContentClass+".*>(\\n|.)*<div.*"+this._personalizedContentHeaderClass+".*>(\\n|.)*<div.*"+this._personalizedContentHolderClass+".*>(\\n|.)*<div.*"+this._personalizedContentFooterClass+".*>");return this.ed.dom.hasClass(this.ed.selection.getNode(),this._personalizedContentClass)||this.ed.selection.getContent().match(pcMatchRule)},_getCommonAncestor:function(){if(this.ed.selection.getStart()==this.ed.selection.getEnd())return this.ed.selection.getStart();var commonAncestor=this.ed.selection.getRng(!0).commonAncestorContainer;return commonAncestor&&"HTML"!=commonAncestor.tagName?commonAncestor:this.ed.getBody()},_convertPCToMceNonEditable:function(node,mceNonEditableClass,mceEditableClass){var nodeClass=node.attr("class")+" ";-1!==nodeClass.indexOf("epi_pc ")&&0!==nodeClass.indexOf(mceNonEditableClass)?node.attr("class",nodeClass+mceNonEditableClass):-1!==nodeClass.indexOf("epi_pc_h ")?node.attr("contenteditable",null):-1!==nodeClass.indexOf("epi_pc_f ")?node.attr("contenteditable",null):-1!==nodeClass.indexOf("epi_pc_content ")&&0!==nodeClass.indexOf(mceNonEditableClass)&&node.attr("class",nodeClass+mceEditableClass)},getInfo:function(){return{longname:"EPiServer CMS Personalized Content Plug-in",author:"EPiServer AB",authorurl:"http://www.episerver.com",infourl:"http://www.episerver.com",version:"1.0"}}}),tinymce.PluginManager.add("epipersonalizedcontent",tinymce.plugins.epipersonalizedcontent)})(tinymce,epiJQuery);