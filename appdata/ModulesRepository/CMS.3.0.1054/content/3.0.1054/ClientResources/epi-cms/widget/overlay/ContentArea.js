//>>built
require({cache:{"url:epi-cms/widget/templates/ContentArea.html":"<div class=\"epi-overlay-blockarea\">\r\n\t<div class=\"epi-overlay-item-container\">\r\n\t\t<div class=\"epi-overlay-bracket\"></div>\r\n\t</div>\r\n\t<div data-dojo-attach-point=\"containerNode\" class=\"epi-overlay-blockarea-container\"></div>\r\n\t<div data-dojo-attach-point=\"actionsNode\" class=\"epi-overlay-blockarea-actionscontainer\">\r\n\t\t<div data-dojo-attach-point=\"actionsNodeControls\" class=\"epi-overlay-blockarea-actions\"></div>\r\n\t</div>\r\n</div>"}});define("epi-cms/widget/overlay/ContentArea",["dojo/_base/array","dojo/_base/declare","dojo/_base/lang","dojo/aspect","dojo/Deferred","dojo/dnd/Manager","dojo/dom-attr","dojo/dom-construct","dojo/dom-geometry","dojo/dom-style","dojo/json","dojo/on","dojo/query","dojo/when","dijit/_Container","dijit/registry","epi/dependency","epi/shell/widget/overlay/Item","epi/shell/dnd/Source","epi/shell/dnd/_MarkerSource","epi-cms/widget/overlay/Block","epi-cms/contentediting/editors/ContentBlockEditor","epi-cms/widget/command/CreateContentFromSelector","epi-cms/contentediting/ContentActionSupport","epi-cms/contentediting/viewmodel/ContentAreaViewModel","epi-cms/contentediting/viewmodel/ContentBlockViewModel","epi-cms/contentediting/editors/_TextWithActionLinksMixin","dojo/text!../templates/ContentArea.html"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,on,_c,_d,_e,_f,_10,_11,_12,_13,_14,_15,_16,_17,_18,_19,_1a,_1b){return _2([_11,_e,_1a],{templateString:_1b,layout:"",defaultWatchKey:"",allowedDndTypes:null,blockClass:_14,modelClass:_18,dndSourceClass:_2([_12,_13]),dndSourceSettings:null,_supressValueChanged:false,constructor:function(){this._watches={};},postMixInProperties:function(){this.inherited(arguments);if(!this.model){this.model=new this.modelClass();}this.model.set("value",_3.clone(this.contentModel.get(this.name)));this.contentModel.watch(this.name,_3.hitch(this,function(_1c,_1d,_1e){if(epi.areEqual(_1e,this.model.get("value"))){return;}this.refresh();}));this._pendingPersonalizations=[];this._contentStore=this._contentStore||_10.resolve("epi.storeregistry").get("epi.cms.contentdata");this._ownerContentLink=this.contentModel.get("icontent_contentlink");},buildRendering:function(){this.inherited(arguments);this.setupActionLinks(this.actionsNodeControls);},postCreate:function(){this.inherited(arguments);this.own(on(this.model,"changed",_3.hitch(this,function(){if(!this._started||this._supressValueChanged){return;}this._onChildrenChanged();if(this._pendingPersonalizations.length>0){this._pendingPersonalizations=[];this.onClick(this);}})));this._setupDirectionality();this._setupBlocks();},destroy:function(){this.inherited(arguments);for(var i in this._watches){this._watches[i].remove();}this._watches={};this._source.destroy();if(this.textWithLinks){this.textWithLinks.destroy();this.textWithLinks=null;}},isCreateLinkVisible:function(){var _1f=new _5();_d(this._contentStore.get(this._ownerContentLink),function(_20){var _21=_17.isActionAvailable(_20,_17.action.Create,_17.providerCapabilities.Create,true);_1f.resolve(_21);});return _1f.promise;},_setHasChildrenAttr:function(_22){this._set("hasChildren",_22);},_getMinHeightAttr:function(){return _a.get(this.sourceItemNode,"minHeight");},onValueChange:function(_23){},updatePosition:function(_24){if(!this.canUpdatePosition()){return false;}var _25=this.inherited(arguments),_26,_27,_28,_29;if(this.hasChildren){this._setupDirectionality();this._positionBlocks();}_28=this.get("minHeight");_a.set(this.sourceItemNode,"minHeight","");_26=Math.floor(_9.position(this.actionsNodeControls,false).h);_27=_26>0?_26:this.get("actionNodeHeight")||0;_29=Math.floor(_9.position(this.sourceItemNode,false).h);if(_27===0){this._clearPosition();return _25;}_27&&(this.set("actionNodeHeight",_27));_a.set(this.sourceItemNode,"minHeight",(_29+_27)+"px");_a.set(this.actionsNodeControls,"marginTop",(_29)+"px");if(_28===_29+_27){return _25;}return true;},refresh:function(){this._actionNodeHeight=null;this.destroyDescendants();this._source.clearItems();if(this._source.anchor){_8.destroy(this._source.anchor);}for(var i in this._watches){this._watches[i].remove();}this._watches={};this._supressValueChanged=true;this.model.set("value",_3.clone(this.contentModel.get(this.name)));this._setupBlocks();this.inherited(arguments);this._supressValueChanged=false;},_setupDnd:function(){var _2a=_3.mixin({_skipStartup:true,creator:_3.hitch(this,"_creator"),copyOnly:false,alwaysCopy:false,dropParent:this.containerNode,type:this.allowedDndTypes,accept:this.allowedDndTypes,singular:true,propertyName:this.name},this.dndSourceSettings||{});this._source=new this.dndSourceClass(this.domNode,_2a);this._source.defaultCheckAcceptance=this._source.checkAcceptance;this._source.checkAcceptance=_3.hitch(this,this._checkAcceptance),this.own(_4.after(this._source,"onDropData",_3.hitch(this,"_onDrop"),true));this.own(_4.before(this._source,"delItem",_3.hitch(this,"_onDndItemRemoved"),true));},_creator:function(_2b){var _2c=_8.create("div"),_2d;if(typeof _2b.getNormalizedData=="function"){_2d=_2b.getNormalizedData();}_2d=_2d?_2d.data:_2b;return {node:_2c,type:this.allowedDndTypes,data:_2d};},_setupBlocks:function(){var _2e=this._getBlockNodes();_1.forEach(_2e,this._createBlock,this);this.set("hasChildren",_2e.length>0);},_createBlock:function(_2f){var id=_7.get(_2f,"data-epi-block-id"),_30=_b.parse(_7.get(_2f,"data-epi-block-personalization")),_31=_30?_30.contentGroup:this.defaultWatchKey,_32=this.model;if(_31){_32=_32.getChild({name:_31});}_32=_32&&_32.getChild(_3.mixin({contentLink:id},_30));if(!_32){return;}var _33=new this.blockClass({disabled:this.disabled,viewModel:_32,sourceItemNode:_2f});this.addChild(_33);this._watches["block_"+id+"_ensurePersonalization"]=_32.watch("ensurePersonalization",_3.hitch(this,function(_34,_35,_36){var _37=_1.indexOf(this._pendingPersonalizations,_32);if(_36){if(_37<0){this._pendingPersonalizations.push(_32);}}else{if(_37>0){this._pendingPersonalizations.splice(_37,1);}}}));_32.set("visible",true);this._source.setItem(_33.domNode.id,{name:_32.name,data:_32,type:this.allowedDndTypes});},_onChildrenChanged:function(){this.onValueChange({propertyName:this.name,value:this.model.get("value")});},_positionBlocks:function(){var _38=this.getChildren(),_39=[],_3a=this.get("position");_1.forEach(_38,function(_3b,i){var _3c,_3d,_3e;if(!_39[i]){_39[i]=_9.position(_3b.sourceItemNode,false);}_3c=_39[i];_3c.x-=_3a.x;_3c.y-=_3a.y;_3b.resize(_3c);},this);},_checkAcceptance:function(_3f,_40){if(this.readOnly){return false;}var _41=_f.getEnclosingWidget(_40[0]);if(_41.isInstanceOf(_15)){return false;}return this._source.defaultCheckAcceptance(_3f,_40);},_getBlockNodes:function(){var _42=_c("[data-epi-block-id]",this.sourceItemNode);var _43=_c("[data-epi-block-id] [data-epi-block-id]",this.sourceItemNode);return _1.filter(_42,function(_44){return _43.indexOf(_44)===-1;});},_setupDirectionality:function(){var _45;if(/vertical|horizontal/.test(this.layout)){_45=this.layout==="horizontal";}else{_45=_1.some(this._getBlockNodes(),function(_46){var _47=_a.getComputedStyle(_46),_48=/left|right/.test(_47.cssFloat),_49=/inline|inline-block/.test(_47.display);return _48||_49;});}this._source.setHorizontal(_45);},executeAction:function(_4a){if(_4a==="createnewblock"){var _4b=new _16({creatingTypeIdentifier:"episerver.core.blockdata",createAsLocalAsset:true,canChangeLocalAssetName:false,treatAsSecondaryView:true});_4b.set("model",{save:_3.hitch(this,function(_4c){var _4d=_3.clone(this.model.get("value"),true)||[];_4d.push(_4c);this.onValueChange({propertyName:this._source.propertyName,value:_4d});})});_4b.execute();}else{this.inherited(arguments);}},_onDrop:function(_4e,_4f,_50,_51){var _52=this.model,_53=this._source;if(_53.anchor===_53.targetAnchor){return;}var _54=_1.indexOf(_53.getAllNodes(),_53.targetAnchor)+(_53.before?-1:1),_55=_1.filter(_52.getChildren(),function(_56){return _56.get("visible");});_54=_52.indexOf(_55[_54-1])+1;if(!_3.isArray(_4e)){_4e=[_4e];}if(_53==_4f&&!_51){_52.modify(function(){_1.forEach(_4e,function(_57,i){var _58=_57.data;if(_58.contentGroup){_58=_52.getChild({name:_58.contentGroup});}_52.move(_58,_54+i);});});}else{_52.modify(function(){_1.forEach(_4e,function(_59,i){var _5a=new _19(_59.data);_52.addChild(_5a,_54+i);});});}},_onDndItemRemoved:function(key){var _5b=this._source.getItem(key);if(!_3.isArray(_5b)){_5b=[_5b];}this.model.modify(function(){_1.forEach(_5b,function(_5c){this.model.removeChild(_5c.data);},this);},this);}});});