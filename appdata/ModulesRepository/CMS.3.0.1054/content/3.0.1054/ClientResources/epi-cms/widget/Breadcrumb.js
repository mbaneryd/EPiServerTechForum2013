//>>built
define("epi-cms/widget/Breadcrumb",["dojo/_base/array","dojo/_base/declare","dojo/_base/lang","dojo/aspect","dojo/Deferred","dojo/dom-class","dojo/dom-construct","dojo/dom-geometry","dojo/dom-style","dojo/on","dojo/when","dojo/query","dojo/NodeList-manipulate","dojo/topic","dijit/_Widget","dijit/layout/_LayoutWidget","epi/dependency","epi-cms/core/ContentReference","epi-cms/_ContentContextMixin","epi-cms/contentediting/_ContextualContentContextMixin","epi-cms/widget/_HierarchicalModelMixin"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,on,_a,_b,_c,_d,_e,_f,_10,_11,_12,_13,_14){return _2([_f,_14,_12,_13],{contentLink:null,store:null,showCurrentNode:true,showLastBracket:false,displayAsText:true,minimumItemCount:null,baseClass:"epi-breadCrumbs",_resizeListener:null,_visibleItems:[],_currentContent:null,_ancestors:null,postMixInProperties:function(){var _15=_10.resolve("epi.storeregistry");this.store=this.store||_15.get("epi.cms.content.light");this.minimumItemCount=this.minimumItemCount||2;},buildRendering:function(){this.domNode=this.ownerDocument.createElement("ul");this.inherited(arguments);},startup:function(){this._addResizeListener();},destroy:function(){if(this._resizeListener){this._resizeListener.remove();}this.destroyDescendants();this.inherited(arguments);},_addResizeListener:function(){if(this._resizeListener){return;}var _16=this.getParent(),_17=_16;while(_17&&!_17.isLayoutContainer&&_17.getParent()){_17=_17.getParent();}if(_17&&_17!==_16){this._resizeListener=_4.after(_17,"resize",_3.hitch(this,function(){var _18=_8.getMarginBox(this.domNode);this.resize(_18);}));}},resize:function(_19){if(!_19&&this._resizeListener){return;}else{this.layout();}},layout:function(){this._visibleItems=[];_a(this._buildPath(),_3.hitch(this,function(){var _1a=_8.getContentBox(this.domNode).w;if(_1a>this._availableWidth){var _1b=this._leadingItem?_8.getMarginBox(this._leadingItem.domNode).w:0;var _1c=this._availableWidth-_1b;this._ellipsisize(0,_1c);}}));},_setContentLinkAttr:function(_1d){this._set("contentLink",_1d);this._currentContent=null;this._ancestors=null;this.layout();},_buildPath:function(){var _1e=this.get("contentLink"),def=new _5(),_1f="";if(this._currentContent&&this._ancestors){this._createAllItems();def.resolve(_1f);}else{if(_1e){var _20=new _11(_1e);var _21=_20.createVersionUnspecificReference().toString();_a(this.getCurrentContext(),_3.hitch(this,function(ctx){_a(this.store.get(_21),_3.hitch(this,function(_22){this.getAncestors(_21,_3.hitch(this,function(_23){this._currentContent=_22;this._ancestors=_23;this._createAllItems();def.resolve(_1f);}));}));}));}else{def.resolve(_1f);}}return def.promise;},_createAllItems:function(){this._cleanUp();if(!this.isTypeOfRoot(this._currentContent)){var _24=[],_25=null;for(var i=this._ancestors.length-1;i>=0;i--){_25=this._ancestors[i];if(!_25.parentLink){continue;}_24.push(_25);if(this.isTypeOfRoot(_25)){break;}}_24.reverse();var _26=_8.getContentBox(this.domNode).w;this._availableWidth=_26>=0?_26:0;_1.forEach(_24,_3.hitch(this,function(_27){this._createItem(_27,true);}));}if(this.showCurrentNode){this._createItem(this._currentContent,this.showLastBracket);}},_cleanUp:function(){this.destroyDescendants();this._leadingItem=null;this._visibleItems=[];},_createItem:function(_28,_29){var _2a,_2b=_7.create("li"),_2c=this.displayAsText||!_28.hasTemplate;if(_2c){_2a=_7.create("span",null,_2b);}else{_2a=_7.create("a",{href:"#"},_2b);this.own(on(_2a,"click",_3.hitch(this,function(e){this.onNodeClick(e,_28);})));}_2a.textContent=this.isContextualContent(_28)?this.getContextualRootName(_28):_28.name;if(_29){_7.create("span",{innerHTML:"&gt;","class":"epi-breadCrumbsSeparator"},_2b);}this._addAndLayout(_2b);},onNodeClick:function(e,_2d){e.preventDefault();_d.publish("/epi/shell/context/request",{uri:_2d.uri},{sender:this});},_addAndLayout:function(_2e){var _2f=new _e({},_2e);this._visibleItems.push(_2f);this.addChild(_2f);var _30=this._getTotalVisibleItemsSize();if(_30>this._availableWidth){this._ensureLeadingItem();while(_30>this._availableWidth&&this._visibleItems.length>this.minimumItemCount){var _31=this._visibleItems.splice(0,1)[0];_9.set(_31.domNode,"display","none");_30=this._getTotalVisibleItemsSize();}}},_getTotalVisibleItemsSize:function(){var _32=0;if(this._leadingItem){_32+=_8.getMarginBox(this._leadingItem.domNode).w;}_1.forEach(this._visibleItems,function(_33){_32+=_8.getMarginBox(_33.domNode).w;});return _32;},_ensureLeadingItem:function(){if(this._leadingItem){return;}var _34=_7.create("li"),_35=_7.create("span",{innerHTML:"..."}),_36=_7.create("span",{innerHTML:" &gt; ","class":"epi-breadCrumbsSeparator"});_7.place(_35,_34,"last");_7.place(_36,_34,"last");this._leadingItem=new _e({},_34);this.addChild(this._leadingItem,0);},_ellipsisize:function(_37,_38){if(_37>=this._visibleItems.length){return;}var _39=this._visibleItems.length-_37,_3a=Math.floor(_38/_39),_3b=this._visibleItems[_37],_3c=_8.getMarginBox(_3b.domNode).w;if(_3c<=_3a){this._ellipsisize(_37+1,_38-_3c);}else{var _3d=_b(this.displayAsText?"span":"a",_3b.domNode)[0],_3e=_b("span.epi-breadCrumbsSeparator",_3b.domNode)[0],_3f=_3a-_8.getMarginBox(_3e).w;if(_3f<0){_3f=0;}_9.set(_3d,"width",_3f+"px");_6.add(_3d,"dojoxEllipsis");this._ellipsisize(_37+1,_38-_3a);}}});});