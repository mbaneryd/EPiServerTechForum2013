//>>built
define("epi-cms/widget/_GridWidgetBase",["dojo/_base/declare","dojo/_base/lang","dojo/aspect","dojo/dom-construct","dojo/keys","dojo/topic","dojo/when","dgrid/Keyboard","dgrid/OnDemandGrid","dgrid/Selection","dijit/layout/_LayoutWidget","epi","epi/datetime","epi/UriParser","epi/username","epi/shell/dgrid/Formatter","epi/shell/TypeDescriptorManager","epi-cms/_ContentContextMixin","epi-cms/core/ContentReference","epi-cms/dgrid/DnD","epi-cms/dgrid/formatters","epi-cms/dgrid/WithContextMenu","epi/dependency"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e,_f,_10,_11,_12,_13,DnD,_14,_15,_16){return _1([_b,_12],{_gridClass:_1([_9,_10,_a,DnD,_8,_15]),storeKeyName:null,grid:null,store:null,ignoreVersionWhenComparingLinks:true,trackActiveItem:true,defaultGridMixin:null,currentItem:null,contextChangeEvent:"click",postMixInProperties:function(){this.inherited(arguments);this.defaultGridMixin={selectionMode:"single",dndParams:{creator:_2.hitch(this,this._dndNodeCreator),copyOnly:true,selfAccept:false}};if(!this.store&&this.storeKeyName){var _17=_16.resolve("epi.storeregistry");this.store=_17.get(this.storeKeyName);}},startup:function(){this.inherited(arguments);if(this.contextChangeEvent){var _18=_2.hitch(this,"_onChangeContext");this.grid.on(".dgrid-row:"+this.contextChangeEvent,_18);if(typeof this.grid.addKeyHandler=="function"){this.grid.addKeyHandler(_5.ENTER,_18);this.grid.addKeyHandler(_5.SPACE,_18);}}this.grid.on("dgrid-select",_2.hitch(this,"_onSelect"));this.grid.on("dgrid-error",_2.hitch(this,"_onError"));if(this.trackActiveItem){this.own(_3.after(this.grid,"insertRow",_2.hitch(this,this._selectActiveItem)));}this.own(this.connect(this,"layout",_2.hitch(this,function(){this.grid.resize();})));this.grid.startup();},destroy:function(){if(this.grid){this.grid.destroy();}this.inherited(arguments);},select:function(_19){this.grid.clearSelection();if(_19){this.grid.select(_19.createVersionUnspecificReference().toString());}},_forceKeepContext:function(uri){return this._isSameAsCurrentContext(uri);},_onChangeContext:function(e){var row=this.grid.row(e),uri=row.data.uri,_1a={uri:uri};if(this._forceKeepContext(uri)){return;}this._requestNewContext(_1a,{sender:this});},_onSelect:function(e){},_onError:function(_1b){var _1c=this.grid.errorMessage;if(_1b.status&&_1b.status===403){_1c=_c.resources.messages.nopermissiontoviewdata;}this._showErrorMessage(_1c);},_requestNewContext:function(_1d,_1e){_6.publish("/epi/shell/context/request",_1d,_1e);},restore:function(){this.resize();},_isActiveItem:function(row){return _7(this.getCurrentContext(),_2.hitch(this,function(_1f){var _20=row.data.uri;return _1f&&this._compareUris(_20,_1f.uri);}));},_selectActiveItem:function(_21){var row=this.grid.row(_21);if(!row){return _21;}_7(this._isActiveItem(row),_2.hitch(this,function(_22){if(_22){if(this.grid.selectionMode==="single"){this.grid.clearSelection();}this.grid.select(row,null);}}));return _21;},contextChanged:function(_23,_24){this.inherited(arguments);if(_23.type!=="epi.cms.contentdata"){return;}if(!_24||_24.sender!=this){this.onContextChanged(_23);}},onContextChanged:function(_25){this.fetchData();},fetchData:function(){},_showErrorMessage:function(_26){this.grid.cleanup();this.grid.contentNode.innerHTML=_26||"";},contextChangeFailed:function(_27,_28,_29){this.inherited(arguments);if(_29&&_29.sender===this){this._selectActiveItem();}},_renderContentItem:function(_2a,_2b,_2c,_2d){_2c.innerHTML=_14.contentItem(_2a.typeIdentifier,_2a.missingLanguageBranch,_2b);},_localizeDate:function(_2e){return _14.localizedDate(_2e);},_createUserFriendlyUsername:function(_2f){return _14.userName(_2f);},_dndNodeCreator:function(_30,_31){var _32=_11.getAndConcatenateValues(_30.typeIdentifier,"dndTypes");if(!_32&&this.dndTypes){_32=this.dndTypes;}var _33=_4.create("div").appendChild(document.createTextNode(_30.name));return {"node":_33,"type":_32,"data":_30};},_aroundInsertRow:function(_34){return _2.hitch(this,function(_35,_36,_37,i,_38){var row=_34.apply(this.grid,arguments);var _39=this.get("currentItem");if(_39&&_39.createVersionUnspecificReference().toString()===_35.contentLink){this.select(_39);}return row;});},_getCurrentItem:function(){return _7(this.getCurrentContext(),function(_3a){return {"id":(new _13(_3a.id)).id};});}});});