//>>built
require({cache:{"url:epi-cms/contentediting/editors/templates/TinyMCEEditor.html":"<div id=\"widget_${id}\">\r\n    <div style=\"display: inline-block\" data-dojo-attach-point=\"stateNode, tooltipNode\">\r\n        <textarea data-dojo-attach-point=\"editorFrame\" id=\"${id}_editorFrame\" style=\"border: none;\"></textarea>\r\n    </div>\r\n    <div data-dojo-attach-point=\"dndOverlay\" style=\"background: rgba(0, 0, 0, 0.01); position: absolute; left: 0; top: 0; right: 0; bottom: 0; display: none\"></div>\r\n</div>\r\n"}});define("epi-cms/contentediting/editors/TinyMCEEditor",["dojo/_base/array","dojo/_base/config","dojo/_base/declare","dojo/_base/lang","dojo/_base/window","dojo/dom-style","dojo/dom-class","dojo/dom-construct","dojo/Deferred","dojo/keys","dojo/on","dojo/when","dojox/html/entities","dijit/_TemplatedMixin","dijit/focus","epi/dependency","epi/routes","epi/shell/conversion/ObjectConverterRegistry","epi/shell/dnd/Target","epi/shell/layout/_LayoutWidget","epi/shell/TypeDescriptorManager","epi/shell/widget/_ValueRequiredMixin","epi-cms/widget/_DndStateMixin","epi-cms/widget/_HasChildDialogMixin","epi-cms/widget/_UserResizable","epi/shell/widget/dialog/Alert","dojo/text!./templates/TinyMCEEditor.html","epi/i18n!epi/cms/nls/tinymce","epi/i18n!epi/cms/nls/episerver.tinymce"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,on,_b,_c,_d,_e,_f,_10,_11,_12,_13,_14,_15,_16,_17,_18,_19,_1a,_1b,_1c){return _3([_13,_d,_17,_18,_15,_16],{baseClass:"epiTinyMCEEditor",width:null,height:null,value:null,intermediateChanges:true,templateString:_1a,settings:null,dirtyCheckInterval:2000,autoResizable:false,isResized:false,tinymceRendered:null,dropTarget:null,readOnly:false,_dirtyCheckTimeout:null,constructor:function(_1d){_4.mixin(this,_1d);this.tinymceRendered=new _9();},postMixInProperties:function(){if(this.autoResizable){this.height=0;}},postCreate:function(){this.dropTarget=new _12(this.dndOverlay,{accept:this.allowedDndTypes,createItemOnDrop:false,readOnly:this.readOnly});this.connect(this.dropTarget,"onDropData","onDropData");this.connect(this.dndOverlay,"onmousemove","_onOverlayMouseMove");this.inherited(arguments);},startup:function(){this.inherited(arguments);if(!window.tinymce){require(["tinymce/tiny_mce_src"],_4.hitch(this,function(){var res=_4.mixin({},_1b,_1c);tinymce.addI18n({en:res});_b(this._loadLegacyPlugins(),_4.hitch(this,function(){this._initTinyMCE();}));}));}else{this._initTinyMCE();}},destroy:function(){this._cancelDirtyCheckInterval();this.inherited(arguments);},_loadLegacyPlugins:function(){var dfd=new _9();this.legacyPlugins.forEach(function(_1e){var url=_10.getActionPath({moduleArea:"Util",path:"Editor/tinymce/plugins/"+_1e+"/"+(_2.isDebug?"editor_plugin_src.js":"editor_plugin.js")});tinymce.PluginManager.load(_1e,url);});tinymce.ScriptLoader.loadQueue(function(){dfd.resolve();});return dfd;},canAccept:function(){return !_7.contains(this.dndOverlay,"dojoDndTargetDisabled");},_onDndStart:function(){_6.set(this.dndOverlay,"display","block");this.inherited(arguments);},_onDndCancel:function(){_6.set(this.dndOverlay,"display","none");this.inherited(arguments);},_onDndDrop:function(){_6.set(this.dndOverlay,"display","none");this.inherited(arguments);},_onOverlayMouseMove:function(evt){this._dragPosition={x:evt.pageX,y:evt.pageY};},onDropData:function(_1f,_20,_21,_22){var _23=_1f?(_1f.length?_1f[0]:_1f):null;if(!_23){return;}if(this.onDropping){this.onDropping();}this._dropDataProcessor(_23);},_dropDataProcessor:function(_24){_b(_24.data,_4.hitch(this,function(_25){var _26=this,_27=_24.type,ed=this.getEditor();function _28(url){ed.focus();ed.execCommand("CreateLink",false,url);};function _29(_2a){ed.focus();if(ed.execCommand("mceInsertContent",false,_2a)){_26._onChange(ed.getContent());}};function _2b(_2c){if(!ed.selection.isCollapsed()){_28(_2c.url);}else{var _2d="<a href=\"{0}\" title=\"{1}\">{1}</a>";_29(_4.replace(_2d,[_2c.url,_c.encode(_2c.text)]));}};function _2e(_2f){var _30="<img alt=\"{alt}\" src=\"{src}\" width=\"{width}\" height=\"{height}\" />";var _31=_8.create("img",{src:_2f.previewUrl||_2f.url,style:{display:"none;"}},_5.body(),"last");on.once(_31,"load",function(){_29(_4.replace(_30,this));_8.destroy(_31);});};if(_27&&_27.indexOf("link")!==-1){_2b(_25);}else{if(_27&&_27.indexOf("fileurl")!==-1){_2e(_25);}}var _32=_25.typeIdentifier;var _33=_14.getValue(_32,"editorDropBehaviour");if(_33){if(_33===1){var _34="<div data-contentlink=\""+_25.contentLink+"\" data-classid=\"36f4349b-8093-492b-b616-05d8964e4c89\" class=\"mceNonEditable epi-contentfragment\">"+_25.name+"</div>";_29(_34);return;}var _35,_36=_14.getInheritanceChain(_32);for(var i=0;i<_36.length;i++){var _37=_36[i];_35=_11.getConverter(_37,_37+".link");if(_35){break;}}if(!_35){return;}_b(_35.convert(_32,_32+".link",_25),_4.hitch(this,function(_38){if(!_38.url){var _39=new _19({description:_1c.notabletocreatelinkforpage});_39.show();this.own(_39);}else{switch(_33){case 2:_2b(_38);break;case 3:_2e(_38);break;}}}));}}));_6.set(this.dndOverlay,{"display":"none"});},focus:function(){this._set("state","Focused");var ed=this.getEditor();if(ed!=null){this._focused=true;ed._gainedFocus=true;_b(this.tinymceRendered,_4.hitch(this,function(){tinymce.execCommand("mceFocus",false,this.editorFrame.id);}));}},validate:function(){return this.inherited(arguments);},getEditor:function(){return (typeof tinymce!=="undefined"&&tinymce!=null?tinymce.get(this.editorFrame.id):null);},getEditorDOM:function(){return tinymce.DOM;},resizeEditor:function(){var ed=this.getEditor(),_3a=0,_3b=(tinymce.isIE?document.body.clientHeight:window.innerHeight)-200,_3c=(tinymce.isIE?document.body.clientWidth:window.innerWidth)-200,d=ed.getDoc(),b=d.body,DOM=tinymce.DOM,_3d=this.height,_3e=this.width,_3f,_40;_3f=b.scrollHeight;_40=b.scrollWidth;if(_3f>_3a){_3d=_3f;}if(_3f>_3b){_3d=_3b;}if(_40>_3c){_3e=_3c;}DOM.setStyle(ed.contentWindow.frameElement,"height",_3d+80+"px");if(ed.getBody().scrollWidth!=ed.getBody().offsetWidth){var _41=20;if(_3d==_3b){_41=30;}DOM.setStyle(ed.contentWindow.frameElement,"width",ed.getBody().scrollWidth+_41+"px");}this.isResized=true;},_setValueAttr:function(_42){var _43=(_42===null||_42===undefined);this._emptyRawValue=_43;this._rawValue=_42;this.value=_42;if(_43){this.value="";}var _44=function(t){var _45=t.getEditor();if(_45!=null){_45.setContent(t.value);}this._started&&setTimeout(_4.hitch(t,t.validate),0);};_b(this.tinymceRendered,_4.hitch(this,function(){_44(this);}));},_getValueAttr:function(){return this._emptyRawValue?this._rawValue:this.value;},_updateTinySettings:function(){this.settings=_4.mixin(this.settings,{mode:"exact",width:this.width,height:this.height,setup:_4.hitch(this,this._setupEditorEventHandling),relative_urls:false,elements:this.editorFrame.id,readonly:this.readOnly});},_initTinyMCE:function(){this._updateTinySettings();if(this.legacyPlugins&&this.legacyPlugins.length>0){this.settings.plugins=this.settings.plugins+","+this.legacyPlugins.join(",");}this.editorFrame.value=this.value||"";if(typeof tinymce!=="undefined"){tinymce.dom.Event.domLoaded=true;tinymce.init(this.settings);this._startDirtyCheckInterval();}else{console.error("Couldn't initialize the editor");}},_isFullScreen:function(ed){return ed.editorId==="mce_fullscreen";},_onPostRender:function(ed){if(this.tinymceRendered.fired!==0){this.tinymceRendered.resolve();this.own(_e.registerIframe(ed.contentWindow.frameElement));this._handlePopupMenu(ed);this._handlePopupWindow(ed);}},_handlePopupWindow:function(ed){ed.windowManager.onOpen.add(_4.hitch(this,function(){this.isShowingChildDialog=true;}));ed.windowManager.onClose.add(_4.hitch(this,function(){this.focus();this.isShowingChildDialog=this._isFullScreen(ed);if(!this.isShowingChildDialog&&this._hasPendingChanges){this._onChange(ed.getContent());}}));},_handlePopupMenu:function(ed){var _46;for(var i in ed.controlManager.controls){_46=ed.controlManager.controls[i];if(_46.onRenderMenu){_46.onRenderMenu.add(_4.hitch(this,function(_47,_48){_48.onShowMenu.add(_4.hitch(this,function(){this.isShowingChildDialog=true;}));_48.onHideMenu.add(_4.hitch(this,function(){this.isShowingChildDialog=this._isFullScreen(ed);}));}));}}},_setupEditorEventHandling:function(ed){ed.onInit.add(_4.hitch(this,function(){if(ed&&ed.selection){ed.selection.onSetContent.add(_4.hitch(this,function(_49,_4a){var _4b=_4a.set;if(_4b){this._onChange(ed.getContent());}}));}}));ed.onSetContent.add(_4.hitch(this,function(ed,e){this.onSetContent(ed);}));ed.onPostRender.add(_4.hitch(this,function(ed,e){this._onPostRender(ed);}));ed.onKeyUp.add(_4.hitch(this,function(ed,e){this.onKeyUp(ed,e);}));ed.onChange.add(_4.hitch(this,function(ed,e){this._onChange(ed.getContent());}));ed.onRemove.add(_4.hitch(this,function(ed){this.onEditorRemoved(ed);}));ed.onRedo.add(_4.hitch(this,function(ed,_4c){this.onRedo(ed,_4c);}));ed.onUndo.add(_4.hitch(this,function(ed,_4d){this.onUndo(ed,_4d);}));ed.onBeforeExecCommand.add(_4.hitch(this,function(ed,cmd,ui,val,a){if(cmd==="mceFullScreen"){this.isShowingChildDialog=!this._isFullScreen(ed);}}));},onSetContent:function(ed){if(this.isResized){this._hasPendingChanges=this.value!=ed.getContent()||this._hasPendingChanges;}if(this.autoResizable){setTimeout(_4.hitch(this,function(){this.resizeEditor();}),200);}else{if(!this.isResized){this.isResized=true;}}this.onLayoutChanged();},onEditorRemoved:function(ed){},_isMetaKey:function(e){if(e.keyCode==_a.CTRL||e.keyCode==_a.ALT||e.keyCode==_a.SHIFT||e.keyCode==_a.META){return true;}return false;},onKeyUp:function(_4e,e){if(_4e){if(!tinymce.VK.metaKeyPressed(e)&&!this._isMetaKey(e)){this._hasPendingChanges=_4e.undoManager.typing;}}},_onChange:function(val){this.value=val;this._emptyRawValue=false;if(this.validate()){this._hasPendingChanges=false;this.onChange(this.value);}},onChange:function(val){},_stopEditing:function(){this._focused=false;if(this.get("state")==="Focused"){this._set("state","");}this.displayMessage(null);var ed=this.getEditor();if(ed&&ed.undoManager&&ed.undoManager.typing){ed.undoManager.typing=0;ed.undoManager.add();}if(this._hasPendingChanges){var val=ed.getContent();if(!this.intermediateChanges){this._onChange(val);}else{this.value=val;this._emptyRawValue=false;}}},_onBlur:function(){this._stopEditing();this.inherited(arguments);},_cancelDirtyCheckInterval:function(){if(this._dirtyCheckTimeout){clearTimeout(this._dirtyCheckTimeout);this._dirtyCheckTimeout=null;}},_startDirtyCheckInterval:function(){if(this._destroyed||!this.intermediateChanges){return;}this._cancelDirtyCheckInterval();this._dirtyCheck();this._dirtyCheckTimeout=setTimeout(_4.hitch(this,this._startDirtyCheckInterval),this.dirtyCheckInterval);},_dirtyCheck:function(){var ed=this.getEditor();if(ed){if(this._hasPendingChanges){this._onChange(ed.getContent());}}},onRedo:function(ed,_4f){this._hasPendingChanges=true;},onUndo:function(ed,_50){this._hasPendingChanges=true;}});});