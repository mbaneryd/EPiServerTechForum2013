//>>built
define("epi-cms/contentediting/viewmodel/PublishMenuViewModel",["dojo/_base/declare","dojo/_base/lang","epi","epi/datetime","epi/dependency","epi/username","epi-cms/contentediting/ContentActionSupport","epi-cms/contentediting/viewmodel/_ContentViewModelObserver","epi/shell/command/_CommandConsumerMixin","epi/shell/command/_GlobalCommandProviderMixin","epi/i18n!epi/cms/nls/episerver.cms.contentediting.editactionpanel.publishactionmenu"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b){return _1([_8,_9,_a],{commandKey:"epi.cms.publishmenu",contentActionSupport:null,inUseNotificationManager:null,_currentUser:null,commands:null,mainButtonCommand:null,lastExecutedCommand:null,mainButtonSectionVisible:null,lastChangeStatus:null,topInfoSectionVisible:null,publishInfoSectionVisible:null,lastPublishedText:null,lastPublishedViewLinkVisible:null,lastPublishedViewLinkHref:null,additionalInfoSectionVisible:null,additionalInfoText:null,isOpen:null,typeIdentifier:null,postscript:function(){this.inherited(arguments);this.res=this.res||_b;this.contentActionSupport=this.contentActionSupport||_7;this.initializeCommandProviders();},_setDataModelAttr:function(_c){this.updateCommandModel(_c);this.inherited(arguments);},_setIsOpenAttr:function(_d){if(_d){this.set("lastChangeStatus",this._getLastChangeStatus(this.dataModel.contentData));}},onDataModelChange:function(_e,_f,_10){var _11=this.dataModel.contentData,_12=(_11.publishedBy!==null&&_11.publishedBy!==undefined);this._updateCommands();this.set("lastChangeStatus",this._getLastChangeStatus(_11));this.set("topInfoSectionVisible",this._getTopInfoSectionVisible(_11));this.set("publishInfoSectionVisible",this._getPublishInfoSectionVisible(_11));this.set("lastPublishedTitle",this._getLastPublishedTitle(_11));this.set("lastPublishedTitleVisible",_12);this.set("lastPublishedText",this._getLastPublishedText(_11));this.set("lastPublishedViewLinkVisible",this._getLastPublishedViewLinkVisible(_11,_12));this.set("lastPublishedViewLinkHref",_11.publicUrl);this.set("typeIdentifier",_11.typeIdentifier);this._setAdditionalInfo(_11);},_updateCommands:function(){var _13=this.getCommands(),_14=null;dojo.forEach(_13,dojo.hitch(this,function(_15){if(_15.canExecute&&_15.options&&_15.options.isMain&&_15.options.priority&&(!_14||_14.options.priority<_15.options.priority)){_14=_15;}}));this.set("mainButtonCommand",_14);this.set("commands",_13);this.set("mainButtonSectionVisible",_14!==null);},_getTopInfoSectionVisible:function(_16){return this.mainButtonCommand||!((_16.status===_7.versionStatus.Published||_16.status===_7.versionStatus.Expired)&&!_16.isCommonDraft);},_getPublishInfoSectionVisible:function(_17){var _18=this.inUseNotificationManager.hasInUseNotificationWarning(_17.inUseNotifications),_19=this._isOriginallyEditable();return !(_18&&_19);},_getLastPublishedViewLinkVisible:function(_1a,_1b){return _1b&&!!_1a.publicUrl;},_getLastChangeStatus:function(_1c){if(this.lastExecutedCommand&&this.lastExecutedCommand.options&&this.lastExecutedCommand.options.successStatus){var _1d=this.lastExecutedCommand.options.successStatus;this.lastExecutedCommand=this.mainButtonCommand;return _1d;}if(_1c.missingLanguageBranch&&_1c.missingLanguageBranch.isTranslationNeeded){return _2.replace(this.res.nottranslated,{languageName:_3.resources.language[_1c.missingLanguageBranch.languageId],languageId:_1c.missingLanguageBranch.languageId});}if(_1c.status==_7.versionStatus.Published||_1c.status==_7.versionStatus.Expired){return this.res.notmodifiedsincelastpublish;}if(_1c.status==_7.versionStatus.PreviouslyPublished){return this._getTemplatedText(this.res.previouslypublished,_1c.versionCreatedBy,_1c.versionCreatedTime);}if(_1c.status==_7.versionStatus.CheckedIn){return this._getTemplatedText(this.res.pendingapproval,_1c.versionCreatedBy,_1c.versionCreatedTime);}return this._getTemplatedText(this.res.lastchangestatus,_1c.changedBy,_1c.saved);},_getLastPublishedTitle:function(_1e){return _1e.status===_7.versionStatus.PreviouslyPublished?this.res.currentlypublished:this.res.lastpublishedby;},_getLastPublishedText:function(_1f){return (_1f.publishedBy===null||_1f.publishedBy===undefined)?this.res.notpublishedbefore:this._getTemplatedText(this.res.publishedtime,_1f.publishedBy,_1f.lastPublished,true);},_setAdditionalInfo:function(_20){var _21=this.inUseNotificationManager.hasInUseNotificationWarning(_20.inUseNotifications),_22=this._isOriginallyEditable(),_23=_21&&_22;this.set("additionalInfoSectionVisible",_23);if(_23){var _24=this.inUseNotificationManager.getOtherUsersInUseNotifications(_20.inUseNotifications);this.set("additionalInfoText",this._getTemplatedText(this.res.inusewarning,_24.join(",")));}},_isOriginallyEditable:function(){var _25=this.inUseNotificationManager.ignoreOthersNotifications;this.inUseNotificationManager.ignoreOthersNotifications=true;var _26=this.dataModel.canChangeContent();this.inUseNotificationManager.ignoreOthersNotifications=_25;return _26;},_getFriendlyUsername:function(_27,_28){return _6.toUserFriendlyHtml(_27,null,_28);},_getTemplatedText:function(_29,_2a,_2b,_2c){var _2d=_4.deserialize(_2b);return dojo.replace(_29,{username:this._getFriendlyUsername(_2a,_2c),time:_4.toUserFriendlyHtml(_2d),timepassed:_4.timePassed(_2d)});}});});