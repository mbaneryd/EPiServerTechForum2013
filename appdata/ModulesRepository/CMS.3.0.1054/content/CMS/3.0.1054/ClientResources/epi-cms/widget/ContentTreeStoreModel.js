//>>built
define("epi-cms/widget/ContentTreeStoreModel",["dojo/_base/array","dojo/_base/connect","dojo/_base/declare","dojo/_base/lang","dojo/aspect","dojo/Deferred","dojo/promise/all","dojo/when","dojo/topic","epi/dependency","epi/shell/_StatefulGetterSetterMixin","epi/shell/TypeDescriptorManager","epi/shell/_ContextMixin","epi/shell/ViewSettings","epi-cms/ApplicationSettings","epi-cms/contentediting/ContentActionSupport","epi-cms/core/ContentReference","epi-cms/widget/_HierarchicalModelMixin","epi-cms/widget/viewmodel/_UpdateableStoreModelMixin"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e,_f,_10,_11,_12,_13){return _3([_b,_12,_13,_d],{store:null,root:null,notAllowToDelete:null,notAllowToCopy:null,typeIdentifiers:null,showAllLanguages:true,getChildrenQuery:"getchildren",getRootChildrenQuery:null,_observers:null,_defaultDataStoreName:"epi.cms.content.light",additionalQueryOptions:{},createAsLocalAsset:false,constructor:function(_14){_3.safeMixin(this,_14);this._observers={};this.store=this.store||_a.resolve("epi.storeregistry").get(this._defaultDataStoreName);this._queryOptions=_4.mixin({ignore:["query"],comparers:{"typeIdentifiers":_4.hitch(this,function(_15,_16){return _1.some(_15,_4.hitch(this,function(_17){return _17===_16.typeIdentifier||_c.isBaseTypeIdentifier(_16.typeIdentifier,_17);}));}),"referenceId":function(_18,_19){return _11.compareIgnoreVersion(_18,_19.parentLink);},"allLanguages":function(_1a,_1b){if(_1a||!_1b.currentLanguageBranch){return true;}return epi.areEqual(_f.currentContentLanguage,_1b.currentLanguageBranch.languageId);}},sort:this._getSortSettings(this.typeIdentifiers)},this.additionalQueryOptions);var _1c=_2.subscribe("/epi/cms/contentdata/updated",this,function(_1d){this.store.refresh(_1d.contentLink).then(_4.hitch(this,function(){if(_1d.recursive){this.onItemChildrenReload(_1d);}}));});var _1e=_2.subscribe("/epi/cms/contentdata/childrenchanged",_4.hitch(this,this._childrenChanged));var _1f=_2.subscribe("/epi/cms/contentdata/restored",this,function(_20){this._childrenChanged(_20);});var _21=_5.after(this.store,"onItemChanged",_4.hitch(this,function(id,_22){this.onChange(_22);}),true);this._handles=[_1c,_1e,_1f,_21];},destroy:function(){for(var id in this._observers){this._observers[id].cancel();this._observers[id]=null;}if(this._handles){_1.forEach(this._handles,function(_23){_23.remove();});this._handles=null;}},isSupportedType:function(_24){return _1.some(this.typeIdentifiers,function(_25){return _25===_24||_c.isBaseTypeIdentifier(_24,_25);});},_setShowAllLanguagesAttr:function(_26){this._set("showAllLanguages",_26);this.onItemChildrenReload(this.root);},getRoot:function(_27,_28){if(_4.isArray(this.root)){_27({});}else{_8(this.store.get(this.root),_27,_28);}},mayHaveChildren:function(_29){return _29.hasChildren;},getChildren:function(_2a,_2b){var id=this.getIdentity(_2a),_2c=id==this.root,_2d=_2c&&this.getRootChildrenQuery?this.getRootChildrenQuery:this.getChildrenQuery,_2e=this._createQuery({referenceId:id,query:_2d}),_2f=this.store.query(_2e,this._queryOptions),_30=_4.hitch(this,function(_31){this.onChange(_31);_8(this.store.query(_2e,this._queryOptions),_4.hitch(this,function(_32){this.onChildrenChange(_2a,_32);}));});var _33=this._observers[id];if(_33){_33.cancel();delete this._observers[id];}this._observers[id]=_2f.observe(_30,true);_8(_2f,_2b);},_getSortSettings:function(_34){if(!_34){return {};}if(_34 instanceof String){_34=[_34];}var _35=this,_36,_37=[];_34.map(function(_38){_36=_c.getValue(_38,"sortKey");if(_36){_37.push(_36.sortDescending?{attribute:_36.columnName,descending:true}:{attribute:_36.columnName});}});return _37;},_createQuery:function(_39,_3a){var _3b=this.typeIdentifiers&&(_4.isArray(this.typeIdentifiers)?this.typeIdentifiers:this.typeIdentifiers.split(","));var _3c=this.showAllLanguages?{allLanguages:true}:{},_3d=_3a?{}:{typeIdentifiers:_3b};var _3e=_4.mixin(_39,_3d,_3c);return _3e;},_createChildrenQuery:function(_3f,_40){var _41=_4.mixin(_3f,{query:"getchildren"});return this._createQuery(_41,_40);},move:function(_42,_43){if(!_43.contentLink){_43=this.store.get(_43);}var _44=_1.map(_42,function(_45){return _8(this.store.get(_45.data.parentLink),_4.hitch(this,function(_46){return this.pasteItem(_45.data,_46,_43,false);}));},this);return _7(_44).then(_4.hitch(this,function(_47){if(_43.contentLink===_f.wastebasketPage){var _48=_42.filter(function(i,_49){return !!_47[_49];});if(_48.length){this.onDeleted(_48);}}}));},remove:function(_4a){var _4b=_4a.map(function(_4c){return this.store.remove(_4c.data.contentLink);},this);return _7(_4b).then(_4.hitch(this,function(){this.onDeleted(_4a);}));},copy:function(_4d,_4e){var _4f=_1.map(_4d,function(_50){return _8(this.store.get(_50.data.parentLink),_4.hitch(this,function(_51){return this.pasteItem(_50.data,_51,_4e,true);}));},this);return _7(_4f);},pasteItem:function(_52,_53,_54,_55,_56){var id=this.getIdentity(_52),_57=_54&&_54.isWastebasket,_58=_55?this.store.copy:this.store.move,_59={targetId:this.getIdentity(_54),createAsLocalAsset:this.createAsLocalAsset,sortIndex:_56};return _58.call(this.store,id,_59).then(_4.hitch(this,function(_5a){if(_57){this.onDelete(_52,true);}else{_9.publish("/epi/cms/contentdata/childrenchanged",_54.contentLink);}var _5b=_55?_5a.extraInformation:_52.contentLink;var _5c=_11.toContentReference(_5b).createVersionUnspecificReference().toString();return _8(this.store.refresh(_5c),_4.hitch(this,function(_5d){this._onPasteComplete(_5d,_55,_57,_53,_54);return _5a;}));}));},onPasteComplete:function(){},_onPasteComplete:function(_5e,_5f,_60,_61,_62){this.onPasteComplete();this._selectItemOnPasteComplete(_5e,_5f,_60,_61,_62);this.inherited(arguments);},_selectItemOnPasteComplete:function(_63,_64,_65,_66,_67){if(_63&&_63.contentLink&&!_65){this.onSelect(_63.contentLink,true);}},newItem:function(_68,_69){if(_68.dndData&&_68.dndData.data){var _6a=this.getParentItem(_68.dndData);this._pasteNewItem(_68.dndData.data,_6a,_69);}},getParentItem:function(_6b){if(_6b&&_6b.data){var _6c=_6b.data["parentLink"];if(_6c){_6c=new _11(_6c).createVersionUnspecificReference().toString();}return {contentLink:_6c};}},_pasteNewItem:function(_6d,_6e,_6f){this.pasteItem(_6d,_6e,_6f,false);},_updateItemChanged:function(_70){_8(this.store.refresh(_70),_4.hitch(this,function(_71){this._childrenChanged(_71);}));},_childrenChanged:function(_72){var dfd=new _6();this.getChildren(_72,_4.hitch(this,function(_73){this.onChildrenChange(_72,_73);dfd.resolve(_73);}));return dfd;},getIdentity:function(_74){if(_4.isObject(_74)){return this.store.getIdentity(_74);}return _74;},getObjectIconClass:function(_75,_76){var _77=_c.getValue(_75.typeIdentifier,"iconClass");if(!_77){return _76;}var _78="";switch(parseInt(_75.contentLink,10)){case _f.globalAssetsFolder:_78="AllSites";break;case _f.siteAssetsFolder:_78="ThisSite";break;default:break;}return (_78===""&&_77===_76)?_77:(_76+" "+_77+_78);},getLabel:function(_79){return _79.name;},canExpandTo:function(_7a){var _7b=new _6();this.getAncestors(_7a,_4.hitch(this,function(_7c){_7b.resolve(this.getIdentity(_7c[0])===this.root.id);}));return _7b.promise;},canCopy:function(_7d){if(!_7d){return false;}var _7e=_7d.contentLink,_7f=_7e===this.root||(_1.indexOf(this.notAllowToCopy,_7e)>=0);return !_7f&&_10.hasAccess(_7d.accessMask,_10.accessLevel.Read)&&_10.hasProviderCapability(_7d.providerCapabilityMask,_10.providerCapabilities.Copy);},canCut:function(_80){if(!_80){return false;}var _81=_80.contentLink,_82=_81===this.root||(_1.indexOf(this.notAllowToDelete,_81)>=0);return !_82&&_10.isActionAvailable(_80,_10.action.Delete,_10.providerCapabilities.Move,true);},canDelete:function(_83){if(!_83){return false;}var _84=_83.contentLink,_85=_84===this.root||(_1.indexOf(this.notAllowToDelete,_84)>=0);return !_85&&_10.isActionAvailable(_83,_10.action.Delete,_10.providerCapabilities.Delete,true);},canPaste:function(_86,_87,_88){if(!_86||!_87){return false;}var _89=_88&&_87.isWastebasket,_8a=!_88&&(this.getIdentity(_86)===this.getIdentity(_87)),_8b=!_88&&(_86.parentLink===this.getIdentity(_87)),_8c=_10.isActionAvailable(_87,_10.action.Create,_10.providerCapabilities.Create,true);return !_87.isDeleted&&!_89&&!_8a&&!_8b&&_8c;},canEdit:function(_8d){if(!_8d){return false;}var _8e=_8d.contentLink,_8f=_8e===this.root;return !_8f&&_10.hasAccess(_8d.accessMask,_10.accessLevel.Edit);},onItemChildrenReload:function(_90){},onChange:function(){},onChildrenChange:function(){},onDelete:function(){},onDeleted:function(_91){var _92=_91[0].data;if(_92){_8(this.getCurrentContext(),_4.hitch(this,function(ctx){var _93=_92.capabilities.isPage,_94=_11.compareIgnoreVersion(_92.contentLink,ctx.id);if(_93&&!_94){return;}if(!_93&&_94){_9.publish("/epi/shell/context/request",{uri:_e.settings.defaultContext});return;}this.onSelect(_92.parentLink,true);}));}},onSelect:function(_95,_96,_97){}});});