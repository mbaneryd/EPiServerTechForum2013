//>>built
define("epi-cms/legacy/LegacyDialogWrapper",["dojo/_base/array","dojo/_base/declare","dojo/_base/lang","dojo/_base/sniff","dojo/aspect","dojo/on","dojo/topic","dojo/dom-attr","dojo/dom-class","dojo/dom-construct","dojo/dom-geometry","dojo/dom-style","dojo/has","dojo/query","dojo/string","dojo/when","dijit/_Contained","dijit/_TemplatedMixin","dijit/_WidgetsInTemplateMixin","dijit/a11y","dijit/focus","dijit/form/Button","dijit/layout/_LayoutWidget","epi/Url","epi/shell/widget/_ActionProviderWidget","epi-cms/legacy/_LegacyDialogObject","epi-cms/legacy/LegacyDialogPopup","epi/i18n!epi/cms/nls/episerver.shared.action"],function(_1,_2,_3,_4,_5,on,_6,_7,_8,_9,_a,_b,_c,_d,_e,_f,_10,_11,_12,_13,_14,_15,_16,Url,_17,_18,_19,_1a){return _2([_16,_11,_12,_17,_10],{_currentUrl:null,dialogArguments:null,callbackArguments:null,features:null,autoFit:false,showCloseButton:false,_isIframeInitialLoad:true,_iframeFocusRegistration:null,_scrollbarWidth:null,_iframeHandles:null,templateString:"        <div style=\"position: relative;\" tabindex=\"0\">            <iframe data-dojo-attach-point=\"containerIframe\" tabindex=\"-1\" frameborder=\"0\" style=\"border: none; position: absolute, top:0, left: 0;\" src=\"about:blank\" ></iframe>        </div>",_mappedButtons:null,postMixInProperties:function(){this.inherited(arguments);this._isIframeInitialLoad=true;this._iframeHandles=[];this.features=_3.mixin({width:320,height:240},this.features);},postCreate:function(){this.inherited(arguments);this._legacyDialog=this._createLegacyDialogObject(_3.hitch(this,function(){this.onCallback.apply(this,arguments);}),this.callbackArguments,this.dialogArguments,window);this._resetIframeContainerSize();},startup:function(){this.inherited(arguments);if(this.containerIframe.attachEvent){this.containerIframe.attachEvent("onload",_3.hitch(this,this._onIframeLoad));}else{this.connect(this.containerIframe,"onload",_3.hitch(this,this._onIframeLoad));}},resize:function(){this.inherited(arguments);if(this._started){this._setIframeSizeFromDomNode();}},_setUrlAttr:function(_1b){var url=_1b||"about:blank";this._currentUrl=url;_7.set(this.containerIframe,"src",url);},onCallback:function(_1c){},onLoad:function(){},onCancel:function(){},onFocus:function(){this.inherited(arguments);this._focusIframeContent();},onMapDialogButton:function(_1d){return true;},onBeforePerformAction:function(_1e){},getLegacyDialog:function(){return this._legacyDialog;},_focusIframeContent:function(){var _1f=this.containerIframe.contentWindow,doc=_1f&&_1f.document,_20=(doc&&_13.getFirstInTabbingOrder(doc))||this.containerIframe;_14.focus(_20);},_onIframeLoad:function(){this.own(_6.subscribe("/IsInLegacyWrapper/NeedToBeCloseOnLoad",_3.hitch(this,function(_21){this.onCancel();})));if(!_c("ie")){this._iframeFocusRegistration=_14.registerIframe(this.containerIframe);}this._focusIframeContent();this._overrideLegacyDialogUtilities();var _22=this.containerIframe.contentWindow;this._iframeHandles.push(on(_22,"unload",_3.hitch(this,this._removeIframeHandles)));if(_22.EPi&&_22.EPi.ToolButton){this._iframeHandles.push(_5.after(_22.EPi.ToolButton,"SetEnabled",_3.hitch(this,this._toolButtonChanged),true));}this._iframeHandles.push(_5.after(this._legacyDialog,"ButtonChanged",_3.hitch(this,this._toolButtonChanged),true));this._mapDialogButtons();this._setTitle();var _23=_d(".epi-contentContainer",this.containerIframe.contentWindow.document)[0];if(_23){_8.add(_23,"epi-legacyDialog");}if(this.autoFit){this._calculateAndSetContentSize();}this.onResize();this.onResize();if(this.onLoad){this.onLoad.apply(this,arguments);}this._isIframeInitialLoad=false;},_removeIframeHandles:function(){_1.forEach(this._iframeHandles,function(_24){_24.remove();});this._iframeHandles=[];this._mappedButtons=null;},_setTitle:function(){if(this.dialogTitle){this.title=this.dialogTitle;return;}var _25=_d("title",this.containerIframe.contentWindow.document)[0];if(_25){this.title=_e.trim(_25.innerHTML);}},_getScrollbarWidth:function(){if(this._scrollbarWidth===null){var d=_9.create("div",{style:"position:absolute; top:-2000; left:-2000; width:100px; height:100px; overflow:scroll"},document.body);this._scrollbarWidth=d.offsetWidth-d.clientWidth;_9.destroy(d);}return this._scrollbarWidth;},_boxToStyle:function(_26){return {width:_26.w+"px",height:_26.h+"px"};},_setIframeSizeFromDomNode:function(){_b.set(this.containerIframe,this._boxToStyle(_a.getContentBox(this.domNode)));},_setContentSize:function(_27){_b.set(this.domNode,this._boxToStyle(_27));this._setIframeSizeFromDomNode();},_calculateAndSetContentSize:function(_28){function _29(doc,dir){if(doc&&doc.body&&doc.documentElement){return Math.max(doc.documentElement["client"+dir],doc.documentElement["scroll"+dir],doc.documentElement["offset"+dir],doc.body["scroll"+dir],doc.body["offset"+dir]);}return 0;};var _2a=null;try{_2a=this.containerIframe.contentWindow.document;}catch(e){return;}var _2b=(_2a.documentElement.scrollHeight-_2a.documentElement.clientHeight)>0,_2c=_2b&&this.autoFit?this._getScrollbarWidth():0,_2d={w:_29(_2a,"Width")+_2c,h:_29(_2a,"Height")};this._setContentSize(_2d);},_resetIframeContainerSize:function(){this._setContentSize({w:this.features.width,h:this.features.height});},_showNode:function(_2e,_2f){if(!_2e){return;}_b.set(_2e,"display",_2f?"":"none");},_toolButtonChanged:function(_30,_31){if(typeof _30==="string"){var _32=_3.getObject("containerIframe.contentWindow.EPi",false,this);_30=_32&&_32._GetDomObject&&_32._GetDomObject(_30);}if(_30){if(this.hasAction(_30.id)){this.setActionProperty(_30.id,"disabled",_30.disabled);this.setActionProperty(_30.id,"visible",_30.style.display!="none");this.setActionProperty(_30.id,"label",_30.value||_30.innerHTML);}var _33=this._mappedButtons[_30.id];if(_33){this._showNode(_33.containerNode,false);}}},_mapDialogButtons:function(){var _34=_d(this.legacyButtonQuery||"[data-epi-dialog-button]",this.containerIframe.contentWindow.document);this.removeActions(this.getActions());this._mappedButtons={};_1.forEach(_34,function(_35){var _36=_7.get(_35,"data-epi-dialog-button"),_37=null;switch(_36){case "functioner":return;case "container":_37=_d("[data-epi-dialog-button=\"functioner\"]",_35)[0];break;default:if(_35.tagName=="INPUT"){_37=_35;if(_8.contains(_37.parentNode,"epi-cmsButton")){_35=_37.parentNode;}}else{_37=_d("INPUT",_35)[0];}break;}this._mappedButtons[_37.id]={containerNode:_35,functionNode:_37};this._showNode(_35,false);_f(this.onMapDialogButton(_37),_3.hitch(this,function(_38){if(_38){var _39=_37.tagName=="INPUT"?_37.value:_37.innerHTML,_3a=_37.tagName=="INPUT"?_7.get(_37,"title"):_37.innerHTML,_3b={name:_37.id,label:_39,disabled:_37.disabled,title:_3a,action:_3.hitch(this,function(){this.onBeforePerformAction(_3b,_37);_37.click();})};this.addActions(_3b);}}));},this);if(this.showCloseButton){this.addActions({name:"close",label:_1a.close,action:_3.hitch(this,this.onCancel)});}},_overrideLegacyDialogUtilities:function(){var _3c=this.containerIframe.contentWindow;if(!_3c.EPi){_3c.EPi={};}_3c.EPi.CreateDialog=_3.hitch(this,this._createLegacyDialogFnc);_3c.EPi.GetDialog=_3.hitch(this,this._getLegacyDialogFnc);},_getLegacyDialogFnc:function(win){if(win){return win.EPi.GetDialog();}return this._legacyDialog;},_createLegacyDialogFnc:function(url,_3d,_3e,_3f,_40,_41){var _42=new _19({url:url,destroyOnHide:true,dialogArguments:_3f,callbackArguments:_3e,features:_40});_42.on("Callback",_3.hitch(this,function(){if(_3d){_3d.apply(this,arguments);}}));_42.show();return _42.legacyDialogObject;},_createLegacyDialogObject:function(_43,_44,_45,_46){var obj=new _18({callbackMethod:_43,callbackArguments:_44,dialogArguments:_45,_opener:_46?_46.top:window.top});try{obj._dialog=this.containerIframe.contentWindow;}catch(e){obj._dialog=null;}return obj;},_reloadUrl:function(_47){this._isIframeInitialLoad=_47;if(this._isIframeInitialLoad){this._resetIframeContainerSize();}var url=new Url(this._currentUrl);_3.mixin(url.query,{"epi.preventCache":new Date().valueOf()});this.set("url",url.toString());},cleanup:function(){var _48=this.containerIframe.contentWindow;_48.EPi.CreateDialog=null;_48.EPi.GetDialog=null;if(this._legacyDialog&&!this._legacyDialog.IsCleaned()){this._legacyDialog.Cleanup();}},destroy:function(){this.cleanup();if(this._iframeFocusRegistration){this._iframeFocusRegistration.remove();this._iframeFocusRegistration=null;}this.inherited(arguments);}});});