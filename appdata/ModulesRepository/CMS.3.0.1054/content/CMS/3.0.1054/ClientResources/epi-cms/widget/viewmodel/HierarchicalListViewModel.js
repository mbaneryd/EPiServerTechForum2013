//>>built
define("epi-cms/widget/viewmodel/HierarchicalListViewModel",["dojo/_base/array","dojo/_base/declare","dojo/_base/lang","dojo/topic","dojo/Stateful","dojo/when","epi","epi/dependency","epi/shell/ClipboardManager","epi/shell/command/_CommandProviderMixin","epi/shell/selection","epi/shell/TypeDescriptorManager","epi-cms/_ContentContextMixin","epi-cms/_MultilingualMixin","epi-cms/contentediting/_ContextualContentContextMixin","epi-cms/core/ContentReference","epi-cms/widget/ContentForestStoreModel","epi-cms/widget/command/NewFolder","epi-cms/command/RenameFolder","epi-cms/widget/CreateCommandsMixin","epi-cms/command/NewContent","epi-cms/command/CopyContent","epi-cms/command/CutContent","epi-cms/command/DeleteContent","epi-cms/command/PasteContent","epi-cms/command/TranslateContent","epi-cms/component/command/ViewTrash","epi-cms/component/command/ChangeContext"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e,_f,_10,_11,_12,_13,_14,_15,_16,_17,_18,_19,_1a,_1b,_1c){return _2([_5,_d,_f,_e,_14],{menuType:{ROOT:1,TREE:2,LIST:4},searchArea:"",searchRoots:"",clipboardManager:null,selection:null,commands:null,createCommands:null,createHierarchyCommands:null,pseudoContextualCommands:null,currentTreeItem:null,currentListItem:null,listQuery:null,listQueryOptions:null,showAllLanguages:true,treeStoreModelClass:_11,treeStoreModel:null,store:null,storeKey:"epi.cms.content.light",mainNavigationTypes:null,containedTypes:null,_showAllLanguagesSetter:function(_1d){this.showAllLanguages=_1d;this._updateListQuery(this.currentTreeItem);this.treeStoreModel.set("showAllLanguages",_1d);},_currentTreeItemSetter:function(_1e){this.currentTreeItem=_1e;this._updateListQuery(_1e);},postscript:function(_1f){this.inherited(arguments);this.contentRepositoryDescriptors=this.contentRepositoryDescriptors||_8.resolve("epi.cms.contentRepositoryDescriptors");_2.safeMixin(this,this.contentRepositoryDescriptors[_1f.repositoryKey]);this.clipboardManager=this.clipboardManager||new _9();this.selection=this.selection||new _b();this.store=this.store||_8.resolve("epi.storeregistry").get(this.storeKey);this._setupTreeStoreModel();this._setupCommands();this.set("commands",this._commandRegistry.toArray());this._setupSearchRoots();this.set("listQueryOptions",this.treeStoreModel._queryOptions);},startup:function(){this.inherited(arguments);this._setupSelection();},getCommand:function(_20){return this._commandRegistry[_20]?this._commandRegistry[_20].command:null;},contentContextChanged:function(_21,_22){this._setupSearchRoots();if(!this._isSupportedContent(_21)){return;}var _23=this,_24=_23.get("currentListItem"),_25=_23.treeStoreModel.get("previousSelection"),_26=_10.toContentReference(_21.id);_6(_23.store.get(_26.createVersionUnspecificReference()),function(_27){var _28=_25&&_23.hasContextual(_25.selectedAncestors)?_27.assetsFolderLink:_21.parentLink,_29=_10.toContentReference(_25?_28:_23.roots[0]);_23.set("editingListItem",_26);if(_22&&_22.forceReload||!_10.compareIgnoreVersion(_24,_26)){_6(_23.store.get(_29.createVersionUnspecificReference()),function(_2a){_23.treeStoreModel&&_6(_23.treeStoreModel.canExpandTo(_2a),function(_2b){if(_2b){_23.set("currentTreeItem",_29);_23.set("currentListItem",_26);_23._updateCommands(_2a,_23.menuType.LIST);}});});}});},onSearch:function(_2c){_6(this.store.get(_2c.id),_3.hitch(this,function(_2d){var _2e=_10.toContentReference(_2d.contentLink);this.set("editingListItem",_2e);this.set("currentListItem",_2e);this.set("currentTreeItem",_10.toContentReference(_2d.parentLink));this._updateCommands(_2d,this.menuType.LIST);}));},onTreeItemSelected:function(_2f,_30){var _31=this.get("currentTreeItem"),_32=_10.toContentReference(_2f.contentLink),_33=_30?this.menuType.ROOT:this.menuType.TREE;this._updateCommands(_2f,_33);if(!_10.compareIgnoreVersion(_31,_32)&&_10.emptyContentReference!=_32){this.set("currentTreeItem",_32);}},onListItemSelected:function(_34){var _35=this.get("currentListItem"),_36=_10.toContentReference(_34.contentLink);this._updateCommands(_34,this.menuType.LIST);if(!_10.compareIgnoreVersion(_35,_36)){this.set("currentListItem",_36);}},onListItemUpdated:function(_37){},_isSupportedContent:function(_38){return !!(_38&&_38.id)&&this.containedTypes.some(function(_39){return _c.isBaseTypeIdentifier(_38.dataType,_39);});},_setupSelection:function(){_6(this.getCurrentContext(),_3.hitch(this,function(ctx){var _3a;if(!this._isContentContext(ctx)||!this._isSupportedContent(ctx)){_3a=_10.toContentReference(this.roots[0]).toString();_6(this.store.get(_3a),_3.hitch(this,function(_3b){this.onTreeItemSelected(_3b,true);}));}else{this.contentContextChanged(ctx,null);}}));},_setupTreeStoreModel:function(){var _3c=new this.treeStoreModelClass({store:this.store,roots:this.roots,typeIdentifiers:this.mainNavigationTypes,containedTypes:this.containedTypes,notAllowToCopy:this.preventCopyingFor,notAllowToDelete:this.preventDeletionFor,notSupportContextualContents:this.preventContextualContentFor,onAddDelegate:_3.hitch(this,function(_3d){var _3e=dijit.getEnclosingWidget(_3d.domNode),_3f=_3e&&_3e.item,_40=(typeof (this.treeStoreModel.canEdit)==="function")&&this.treeStoreModel.canEdit(_3f);if(_40){_3d.edit();var _41=function(){_4.publish("/epi/cms/contentdata/childrenchanged",_3f.parentLink);};var _42=_3d.on("rename",function(){_42.remove();_41();});var _43=_3d.on("cancelEdit",function(){_43.remove();_41();});}}),onRefreshRoots:_3.hitch(this,this._setupSearchRoots),additionalQueryOptions:{sort:this._getSortSettings()}});this.set("treeStoreModel",_3c);},_getSortSettings:function(){return [{attribute:"name",descending:false}];},_setupSearchRoots:function(){_6(this.getCurrentContent(),_3.hitch(this,function(_44){var _45=this.roots instanceof Array&&this.roots.length>0?_3.clone(this.roots):[],_46=_44&&_44.assetsFolderLink;if(_46&&typeof this._getPseudoContextualContent==="function"&&_46!=this._getPseudoContextualContent()){_45.push(_46);}this.set("searchRoots",_45.join(","));}));},_setupCommands:function(){var _47=this.menuType;var _48={category:"context",model:this.treeStoreModel,selection:this.selection,clipboard:this.clipboardManager};this.createHierarchyCommands={};var _49=1;_1.forEach(this.mainNavigationTypes,function(_4a){this.createHierarchyCommands[_4a]={command:new _12(_3.mixin({typeIdentifier:_4a},_48)),isAvailable:_47.ROOT|_47.TREE,order:_49};_49=_49+1;},this);this.createCommands=this.getCreateCommands(_49);var _4b={rename:{command:new _13({category:"context"}),isAvailable:_47.TREE,order:10},cut:{command:new _17(_48),isAvailable:_47.TREE|_47.LIST,order:20},copy:{command:new _16(_48),isAvailable:_47.TREE|_47.LIST,order:30},paste:{command:new _19(_48),isAvailable:_47.ROOT|_47.TREE,order:40},edit:{command:new _1c({category:"context",forceContextChange:true}),isAvailable:this.menuType.LIST,order:3},translate:{command:new _1a(),isAvailable:this.menuType.TREE|this.menuType.LIST},"delete":{command:new _18(_48),isAvailable:_47.TREE|_47.LIST,order:50},trash:{command:new _1b({typeIdentifiers:this.mainNavigationTypes}),order:60},sort:function(){var _4c=[];for(var key in this){if(key!=="toArray"&&key!=="sort"&&this.hasOwnProperty(key)){var _4d=this[key].order;if(!_4d){_4d=100;}_4c.push([_4d,this[key].command]);}}_4c.sort(function(a,b){return a[0]-b[0];});return _4c;},toArray:function(){var _4e=this.sort();var _4f=[];_1.forEach(_4e,function(key){_4f.push(key[1]);});return _4f;}};this._commandRegistry=_3.mixin(this._commandRegistry,this.createHierarchyCommands,this.createCommands,_4b);this.pseudoContextualCommands=this._getPseudoContextualCommands();},_updateListQuery:function(_50){var id,_51=null;var _52=_1.filter(this.containedTypes,function(_53){return this.mainNavigationTypes.indexOf(_53)<0;},this);if(_50){id=_50.toString(),_51=this._createListChildrenQuery(id,this.showAllLanguages,_52);}this.set("listQuery",_51);},_createListChildrenQuery:function(id,_54,_55){return {referenceId:id,query:"getchildren",allLanguages:_54,typeIdentifiers:_55};},_updateSelection:function(_56){this.selection.set("data",_56?[{type:"epi.cms.contentdata",data:_56}]:[]);},_updateCommands:function(_57,_58){this._updateSelection(_57);if(typeof this.treeStoreModel.isSupportedType==="function"&&this.treeStoreModel.isSupportedType(_57.typeIdentifier)){this._updateTreeContextCommandModels(_57);this.decoratePseudoContextualCommands(this.pseudoContextualCommands);}this._commandRegistry.translate.command.set("model",_57);this._commandRegistry.translate.command.set("executeDelegate",null);this._commandRegistry.edit.command.set("model",_57);this._updateCommandAvailability(_58);},_updateTreeContextCommandModels:function(_59){this._updateCreateCommandModels(_59);this._commandRegistry.rename.command.set("model",_59);},_updateCreateCommandModels:function(_5a){var _5b=this.createCommands;for(var key in _5b){_5b[key].command.set("model",_5a);}},_getPseudoContextualCommands:function(){var key,_5c=[];for(key in this.createCommands){_5c.push(this.createCommands[key].command);}for(key in this.createHierarchyCommands){_5c.push(this.createHierarchyCommands[key].command);}_5c.push(this._commandRegistry.paste.command);return _5c;},_updateCommandAvailability:function(_5d){var _5e=this._commandRegistry,_5f;for(var key in _5e){if(key!=="toArray"&&_5e.hasOwnProperty(key)){_5f=_5e[key].isAvailable;if(_5f){var _60=_5e[key].command;this._updateAvailabilityForSpecificCommand(_60,_5d,_5f);}}}},_updateAvailabilityForSpecificCommand:function(_61,_62,_63){if(!_61.isInstanceOf(_1a)){_61.set("isAvailable",!!(_63&_62));}},upload:function(_64){}});});