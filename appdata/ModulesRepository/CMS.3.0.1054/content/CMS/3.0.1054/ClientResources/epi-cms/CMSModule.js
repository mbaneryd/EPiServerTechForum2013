//>>built
define("epi-cms/CMSModule",["dojo/_base/array","dojo/_base/declare","dojo/_base/lang","dojo/when","epi","epi/_Module","epi/dependency","epi/routes","epi/shell/conversion/ObjectConverterRegistry","epi/shell/store/JsonRest","epi/shell/store/Throttle","epi/shell/TypeDescriptorManager","epi/shell/ViewSettings","epi-cms/ApplicationSettings","epi-cms/BackContextHistory","epi-cms/ContextSynchronizer","epi-cms/conversion/ContentLightUriConverter","epi-cms/conversion/ContentReferenceConverter","epi-cms/conversion/PropertyDateConverter","epi-cms/core/ContentReference","epi-cms/store/CustomQueryEngine","epi-cms/store/PageVersionQueryEngine","epi-cms/component/command/GlobalToolbarCommandProvider","epi-cms/contentediting/EditorFactory","epi-cms/contentediting/InUseNotificationManager","epi-cms/contentediting/ViewSettingsManager","epi-cms/contentediting/command/Editing","epi-cms/contentediting/commandproviders/ContentDetails","epi-cms/contentediting/commandproviders/PublishMenu","epi-cms/contentediting/commandproviders/PublishMenuGlobal","epi-cms/contentediting/viewsettings/ChannelViewSetting","epi-cms/contentediting/viewsettings/ResolutionViewSetting","epi-cms/contentediting/viewsettings/ViewLanguageViewSetting","epi-cms/contentediting/viewsettings/VisitorGroupViewSetting","epi-cms/Profile"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e,_f,_10,_11,_12,_13,_14,_15,_16,_17,_18,_19,_1a,_1b,_1c,_1d,_1e,_1f,_20,_21,_22,_23){return _2([_6],{_settings:null,_hashWrapper:null,_firstTimeHashUpdated:false,constructor:function(_24){this._settings=_24;},initialize:function(){this.inherited(arguments);_2.safeMixin(_e,this._settings);this.registerDependency("epi.cms.BackContextHistory",new _f());this.registerDependency("epi.cms.ContextSynchronizer",new _10(),undefined,function(_25){_25.destroy();});this.registerDependency("epi.cms.contentEditing.command.Editing",_1b);this._hashWrapper=_7.resolve("epi.shell.HashWrapper");var _26=_7.resolve("epi.globalcommandregistry");var _27=new _1e();_26.registerProvider("epi.cms.publishmenu",_27);var _28=this.resolveDependency("epi.shell.ContextService");this.registerDependency("epi.cms.contentRepositoryDescriptors",this._settings.contentRepositoryDescriptors);_28.registerRoute("epi.cms.contentdata",_3.hitch(this,this._redirectContentDataContext));this._initializeEditorFactory();this._initializeStores();this._setupConverters(_7);this._setupViewSettings(_28);_26.registerProvider("epi.cms.globalToolbar",new _17());this._setupInUseNotificationManager(_26);var _29=_7.resolve("epi.shell.Profile");var def=_29.getContentLanguage();_4(def,function(_2a){_e.currentContentLanguage=_29.contentLanguage=_2a;});return def;},_redirectContentDataContext:function(_2b,_2c,uri){if(_d.viewName=="/episerver/dashboard"){var _2d=_8.getActionPath({moduleArea:"CMS",controller:"Home",action:""});_2d=_2d.substring(0,_2d.length-1);var _2e=_2d+"#"+this._hashWrapper.extractHash(_2b,_2c);this._redirect(_2e);}else{if(_2b.hasSiteChanged){var _2f=_2b.fullHomeUrl+"#"+this._hashWrapper.extractHash(_2b,_2c);this._redirect(_2f);}else{if(_2c&&_2c.trigger=="internal"&&this._firstTimeHashUpdated){return;}this._firstTimeHashUpdated=true;this._hashWrapper.onContextChange(_2b,_2c);}}},_redirect:function(url){window.location=url;},_setupConverters:function(_30){var _31=new _11(),_32=new _12(),_33=new _13(),_34=this.resolveDependency("epi.cms.contentRepositoryDescriptors"),key;for(key in _34){var _35=_34[key];if(_35.linkableTypes){_35.linkableTypes.forEach(function(_36){_9.registerConverter(_36,_36+".link",_31);_9.registerConverter(_36,"link",_31);});}}for(key in _c._uiDescriptors){var _37=_c._uiDescriptors[key];_9.registerConverter(_37.typeIdentifier,_37.typeIdentifier+".reference",_32);_9.registerConverter(_37.typeIdentifier,_37.typeIdentifier+".light",_31);}_31.registerDefaultConverters(_9);_33.registerDefaultConverters(_9);},_setupViewSettings:function(_38){var _39=new _21();_39.initialize(_38);var _3a=new _1a({viewSettings:[new _20(),new _22(),new _1f(),_39]});this.registerDependency("epi.viewsettingsmanager",_3a);},_initializeStores:function(){var _3b=this.resolveDependency("epi.storeregistry"),_3c,_3d,_3e;_3c=_3b.create("epi.cms.contentdata",this._getRestPath("contentdata"),{idProperty:"contentLink"});_3d=_3b.create("epi.cms.content.light",this._getRestPath("contentstructure"),{idProperty:"contentLink",queryEngine:_15});_3e=_3b.create("epi.cms.contentversion",this._getRestPath("contentversion"),{idProperty:"contentLink",queryEngine:_16});_3b.create("epi.cms.displayoptions",this._getRestPath("displayoptions"));_3b.create("epi.cms.category",this._getRestPath("categories"));_3b.create("epi.cms.inusenotification",this._getRestPath("inusenotification")).addDependentStore(_3c);_3b.create("epi.cms.visitorgroup",this._getRestPath("visitorgroup"));_3b.create("epi.cms.language",this._getRestPath("language"),{idProperty:"languageId"});_3b.create("epi.cms.sitestructure",this._getRestPath("sitestructure"),{idProperty:"url"});_3b.create("epi.cms.displaychannels",this._getRestPath("channel"));_3b.create("epi.cms.wastebasket",this._getRestPath("wastebasket"));_3b.create("epi.cms.xform",this._getRestPath("xform"));_3b.create("epi.cms.workflowtask",this._getRestPath("workflowtask"),{idProperty:"taskId"});_3b.create("epi.cms.contenttype",this._getRestPath("contenttype"),{preventCache:false}).query();_3b.add("epi.cms.contentreferences",new _b(new _a({target:this._getRestPath("contentreferences"),idProperty:"contentLink"})));_3b.add("epi.cms.content.search",new _b(new _a({target:this._getRestPath("contentstructure"),idProperty:"contentLink"})));_3c.addDependentStore(_3d,{refreshOnPatch:true,refresh:function(_3f){var id=_3c.getIdentity(_3f);var _40=new _14(id).createVersionUnspecificReference().toString();_3d.refresh(_40);}});_3c.addDependentStore(_3e,{transformDelegate:function(_41){if(_41.capabilities&&!_41.capabilities.supportsVersions){return null;}if(!_41.properties){return null;}var _42={"pageChangedBy":"savedBy","pageSaved":"savedDate","pageLanguageBranch":"language","pageName":"name","name":"name","icontent_name":"name"};var _43=_3.mixin({},_41);for(var p in _42){if(p in _43.properties){_43[_42[p]]=_43.properties[p];}}return _43;}});},_getRestPath:function(_44){return _8.getRestPath({moduleArea:"cms",storeName:_44});},_initializeEditorFactory:function(){this.registerDependency("epi.cms.contentediting.EditorFactory",function(){var _45=new _18();_45.registerEditorWrapper("inline","epi-cms.contentediting.InlineEditorWrapper",function(_46,_47){});_45.registerEditorWrapper("richtextinline","epi-cms.contentediting.RichTextInlineEditorWrapper",function(_48,_49){});_45.registerEditorWrapper("flyout","epi-cms.contentediting.FlyoutEditorWrapper",function(_4a,_4b){});_45.registerEditorWrapper("floating","epi-cms.contentediting.FloatingEditorWrapper",function(_4c,_4d){});_45.registerEditorWrapper("contenteditable","epi-cms.contentediting.ContentEditableWrapper",function(_4e,_4f){});_45.registerEditorWrapper("legacyProperty","epi-cms.contentediting.DialogEditorWrapper",function(_50,_51){_50.closeOnChange=true;_50.showButtons=false;});return _45;});},_setupInUseNotificationManager:function(_52){var _53=new _19();this.registerDependency("epi.cms.contentediting.inUseNotificationManager",_53);_52.registerProvider("epi.cms.publishmenu",new _1d());_52.registerProvider("epi.cms.contentdetailsmenu",new _1c());}});});