//>>built
require({cache:{"url:epi-cms/contentediting/editors/templates/ItemCollectionEditor.html":"<div class=\"dijitInline\">\r\n    <!-- To reuse styling of content area we wrap into a div that include content area class -->\r\n    <div class=\"epi-content-area-editor\" data-dojo-attach-point=\"container\">\r\n        <div data-dojo-attach-point=\"itemsContainer\"></div>\r\n        <div data-dojo-attach-point=\"actionsContainer\" class=\"epi-content-area-actionscontainer\"></div>\r\n    </div>\r\n</div>\r\n"}});define("epi-cms/contentediting/editors/ItemCollectionEditor",["dojo/_base/array","dojo/_base/declare","dojo/_base/lang","dojo/_base/event","dojo/aspect","dojo/dom-class","dojo/dom-construct","dojo/dom-style","dojo/dom-geometry","dojo/keys","dojo/on","dojo/query","dojo/topic","dojo/when","dijit/_TemplatedMixin","dijit/_WidgetsInTemplateMixin","dijit/layout/_LayoutWidget","epi/shell/dgrid/Formatter","epi/shell/dnd/Target","epi/shell/widget/_ValueRequiredMixin","epi/shell/widget/ContextMenu","epi/shell/TypeDescriptorManager","dgrid/Keyboard","dgrid/OnDemandList","dgrid/Selection","epi-cms/dgrid/formatters","epi-cms/dgrid/DnD","epi-cms/extension/events","epi-cms/contentediting/command/NewItem","epi-cms/contentediting/viewmodel/ItemCollectionViewModel","epi-cms/contentediting/command/ItemCollectionCommands","epi-cms/widget/_HasChildDialogMixin","./_TextWithActionLinksMixin","dojo/text!./templates/ItemCollectionEditor.html","epi/i18n!epi/cms/nls/episerver.cms.contentediting.editors.itemcollection"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,on,_b,_c,_d,_e,_f,_10,_11,_12,_13,_14,_15,_16,_17,_18,_19,DnD,_1a,_1b,_1c,_1d,_1e,_1f,_20,_21){return _2([_10,_e,_f,_13,_1e,_1f],{baseClass:"epi-item-collection-editor",multiple:true,res:_21,actionsResource:_21,templateString:_20,value:null,model:null,contextMenu:null,grid:null,commandProviderClass:_1d,_newItemCommand:null,_gridClass:_2([_17,_11,_18,DnD,_16]),_mouseOverClass:"epi-dgrid-mouseover",actionsVisible:true,customTypeIdentifier:null,onChange:function(_22){},postMixInProperties:function(){this.inherited(arguments);this.setupAllowedTypes();},postCreate:function(){this.inherited(arguments);this.set("model",new _1c(this.value,{itemModelType:this.itemModelType,readOnly:this.readOnly}));this.setupCommands();this.setupList();this.setupActionContainer();this.setupEvents();},startup:function(){this.inherited(arguments);this.contextMenu.startup();},setupActionContainer:function(){this.own(this._dndTarget=new _12(this.actionsContainer,{accept:this.get("allowedDndTypes"),isSource:false,alwaysCopy:false,insertNodes:function(){}}));this.setupActionLinks(this.actionsContainer);this._displayActionsContainer();},setupCommands:function(){this.contextMenu=this.contextMenu||new _14(),this.commandProvider=this.commandProvider||new this.commandProviderClass({model:this.model,commandOptions:this.commandOptions}),this.contextMenu.addProvider(this.commandProvider),this.own(this.contextMenu,this.commandProvider,this._newItemCommand=new _1b({"model":this.model,"dialogContentParams":this.commandOptions?this.commandOptions.dialogContentParams:{}}));},setupList:function(){var _23={hasMenu:!!this.contextMenu,settings:{title:this.res?this.res.menutooltip:""}},_24=function(_25,_26,row){return "<div class='epi-rowIcon'><span class='dijitInline dijitIcon epi-iconLink epi-objectIcon'></span></div>"+_25;},_27={selectionMode:"single",selectionEvents:"click,dgrid-cellfocusin",formatters:[_19.contentItemFactory("text","title","typeIdentifier",_23),_24],dndParams:{copyOnly:true,accept:this.get("allowedDndTypes"),creator:_3.hitch(this,this._dndNodeCreator)},dndSourceTypes:this.customTypeIdentifier?[this.customTypeIdentifier]:[],consumer:this},_28=function(_29){var _2a=_15.getAndConcatenateValues(this.dndSourceTypes,"dndTypes");if(_2a.length===0){_2a=this.dndSourceTypes;}return _2a;};if(this.customTypeIdentifier){_27._getDndType=_28;}this.own(this.grid=new this._gridClass(_27,this.itemsContainer));this.grid.set("showHeader",false);this.grid.renderArray(this.model.get("data"));this.grid.startup();},setupEvents:function(){var _2b=this,_2c=on.selector;this.own(_2b.model.on("selectedItem",_3.hitch(this,this.focus)),_2b.model.on("initCompleted",_3.hitch(this,this._renderUI)),_2b.grid.on(_2c(".dgrid-row",_1a.mouse.enter),function(e){_6.add(_2b,_2b._mouseOverClass);}),_2b.grid.on(_2c(".dgrid-row",_1a.mouse.leave),function(e){_6.remove(_2b,_2b._mouseOverClass);}),_2b.grid.on("dgrid-select",function(e){_2b.model.set("selectedItem",e.rows[0].data);_2b.commandProvider.set("model",_2b.model);}),_2b.grid.on(_2c(".dgrid-row",_1a.keys.del),function(e){_2b.model.remove();}),_2b.grid.on(_2c(".dgrid-row",_1a.keys.shiftf10),function(e){_2b._showContextMenu(e);}),_2b.grid.on(_2c(".dgrid-row",_1a.contextmenu),function(e){var _2d=_2b.grid.row(e).data;_2b.model.set("selectedItem",_2d);_2b.select(_2d);_2b._showContextMenu(e);}),_2b.grid.on(".epi-iconContextMenu:click",function(e){_2b.contextMenu.scheduleOpen(_2b,null,{x:e.pageX,y:e.pageY});}),_5.around(_2b.grid.dndSource,"checkAcceptance",function(_2e){return function(_2f,_30){return !_2b.readOnly&&_2e.apply(_2b.grid.dndSource,arguments);};}),_5.after(_2b.grid.dndSource,"onDropData",function(_31,_32,_33,_34){var i;if(_2b.grid.dndSource===_32){for(i=0;i<_33.length;i++){_2b.model.moveTo(_2b.grid.dndSource.getItem(_33[i].id).data,_2b.grid.dndSource.current!=null?_2b.grid.dndSource.getItem(_2b.grid.dndSource.current.id).data:null,_2b.grid.dndSource.before);}}else{var _35;for(i=0;i<_31.length;i++){_d(_31[i].data,_3.hitch(this,function(_36){_2b.model.addTo(_36,_2b.grid.dndSource.current!=null?this.grid.dndSource.getItem(_2b.grid.dndSource.current.id).data:null,_2b.grid.dndSource.before);if(_32&&_32.grid&&_32.grid.consumer&&_32.grid.consumer!==_2b){_32.grid.consumer.model.set("selectedItem",_36);_32.grid.consumer.model.remove();}}));}}},true),_5.around(_2b.grid,"insertRow",_3.hitch(_2b,_2b._aroundInsertRow)),this.model.on("changed",_3.hitch(this,function(){this.onChange(this.value=this.model.get("value")||[]);this._renderUI();this.focus();})),_5.after(this.grid.dndSource,"onDndStart",_3.hitch(this,function(_37,_38,_39){var _3a=this.grid.dndSource,_3b=_3a.accept&&_3a.checkAcceptance(_37,_38);_6[_3b?"remove":"add"](this.container,"dojoDndTargetDisabled");}),true),_5.after(this._dndTarget,"onDropData",_3.hitch(this,function(_3c,_3d,_3e,_3f){var _40;for(var i=0;i<_3c.length;i++){_d(_3c[i].data,_3.hitch(this,function(_41){this.model.addTo(_41,null,false);if(_3d&&_3d.grid&&_3d.grid.consumer&&_3d.grid.consumer!==this){_3d.grid.consumer.model.set("selectedItem",_41);_3d.grid.consumer.model.remove();}}));}}),true));var _42=this.commandProvider.commands.concat(this._newItemCommand);_42.forEach(function(_43){this.own(_5.after(_43,"onDialogOpen",function(){_2b.set("isShowingChildDialog",true);_2b.validate();}),_5.after(_43,"onDialogHideComplete",function(){_2b.set("isShowingChildDialog",false);_2b.focus();}));},this);},executeAction:function(_44){if(_44==="createnewitem"){if(this._newItemCommand){this._newItemCommand.execute();}}},setupAllowedTypes:function(){var _45=this.itemConverterKey;this.allowedDndTypes=this.allowedDndTypes||[];if(_45){this.allowedDndTypes=this.allowedDndTypes.map(function(_46){return _46+"."+_45;});}if(this.customTypeIdentifier){this.allowedDndTypes.unshift(this.customTypeIdentifier);}},focus:function(){if(this.value&&this.value.length>0){this._focusManager.focus(this.container);if(this.model){var _47=this.model.get("selectedItem"),_48=this.model.getItemIndex(_47);if(_47){this.grid&&this.grid.focus(this.grid.row(_48).element);}}}else{this.textWithLinks.focus();}},select:function(_49){this.grid.clearSelection();if(_49){this.grid.select(this.model.getItemIndex(_49));}},isValid:function(){return (!this.required||(this.model&&this.model.get("value").length>0));},_onBlur:function(){if(this.contextMenu&&this.contextMenu.isShowingNow){return;}this.inherited(arguments);},_setValueAttr:function(val){this._set("value",val);if(!val||!(val instanceof Array)){this._set("value",[]);}if(this._started){this.model?this.model.set("data",this.value):(this.model=new _1c(this.value,{readOnly:this.readOnly}));this._renderUI();}},_setReadOnlyAttr:function(_4a){this._set("readOnly",_4a);this._displayActionsContainer();if(this.model){this.model.set("readOnly",_4a);}},_dndNodeCreator:function(_4b,_4c){var _4d=this.allowedDndTypes,_4e=_7.create("div").appendChild(document.createTextNode(_4b.text));if(_4b.typeIdentifier){_4d=_15.getAndConcatenateValues(_4b.typeIdentifier,"dndTypes");}return {"node":_4e,"type":_4d,"data":_4b};},_aroundInsertRow:function(_4f){return _3.hitch(this,function(_50,_51,_52,i,_53){var row=_4f.apply(this.grid,arguments);var _54=this.model.get("selectedItem");if(_54&&_54.id===_50.id){this.select(_54);}return row;});},_renderUI:function(){this.grid.refresh();this.grid.renderArray(this.model.get("data"));},_showContextMenu:function(e){var _55=this.model.get("selectedItem"),_56=this.model.getItemIndex(_55);if(_55){_4.stop(e);this.contextMenu.scheduleOpen(this,null,_9.position(_b(".epi-iconContextMenu",this.grid.row(_56).element)[0],true));}},_displayActionsContainer:function(){_8.set(this.actionsContainer,"display",this.readOnly||!this.actionsVisible?"none":"");}});});